# T-009: RLS 정책 기본 적용

**생성일**: 2025-08-11  
**상태**: TODO  
**우선순위**: P0 (MVP 필수)  
**담당자**: Backend  
**예상 소요**: 1.5일  
**스프린트**: S1 (Week 2)  
**기한**: 2025-08-22

## 📋 작업 개요

T-005에서 테스트한 RLS(Row Level Security) 정책들을 실제 애플리케이션에서 활용할 수 있도록 모든 핵심 테이블에 완전한 RLS 정책을 적용합니다. 멀티테넌트 환경에서 데이터 격리와 역할별 접근 제어를 보장하는 포괄적인 보안 정책을 구현합니다.

## 🎯 작업 목표

1. **모든 핵심 테이블에 RLS 활성화**
2. **테넌트별 데이터 격리 정책 구현**  
3. **역할별 접근 권한 정책 구현**
4. **소유권 기반 접근 제어 정책**
5. **RLS 성능 최적화 및 모니터링**

## 📚 세부 작업 항목

### 1. 테넌트 격리 기본 정책 적용 (0.5일)

```sql
-- 모든 테이블에 기본 테넌트 격리 활성화
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;  
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE instructors ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_packages ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance_records ENABLE ROW LEVEL SECURITY;

-- 기본 테넌트 격리 정책 (모든 테이블 공통)
CREATE POLICY tenant_isolation_policy ON students
  FOR ALL USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
  );

CREATE POLICY tenant_isolation_policy ON classes
  FOR ALL USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
  );

-- 나머지 테이블에도 동일한 패턴 적용
```

### 2. 역할별 접근 권한 정책 구현 (0.4일)

```sql
-- 학생 테이블 역할별 접근 정책
CREATE POLICY students_admin_full_access ON students
  FOR ALL TO authenticated
  USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND EXISTS (
      SELECT 1 FROM user_profiles 
      WHERE id = auth.uid() 
      AND tenant_id = current_setting('app.current_tenant_id')::uuid
      AND role = 'admin'
    )
  );

CREATE POLICY students_staff_access ON students  
  FOR SELECT TO authenticated
  USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND EXISTS (
      SELECT 1 FROM user_profiles 
      WHERE id = auth.uid() 
      AND tenant_id = current_setting('app.current_tenant_id')::uuid
      AND role IN ('staff', 'admin')
    )
  );

CREATE POLICY students_instructor_own_classes ON students
  FOR SELECT TO authenticated  
  USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND class_id IN (
      SELECT c.id FROM classes c
      WHERE c.instructor_id = auth.uid()
      AND c.tenant_id = current_setting('app.current_tenant_id')::uuid
    )
  );
```

### 3. 소유권 기반 정책 구현 (0.3일)

```sql
-- 강사는 본인이 생성한 데이터만 수정 가능
CREATE POLICY instructors_own_data ON attendance_records
  FOR ALL TO authenticated
  USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND (
      -- admin과 staff는 모든 데이터 접근
      EXISTS (
        SELECT 1 FROM user_profiles 
        WHERE id = auth.uid() 
        AND role IN ('admin', 'staff')
        AND tenant_id = current_setting('app.current_tenant_id')::uuid
      )
      OR
      -- instructor는 본인 클래스 학생들만
      student_id IN (
        SELECT s.id FROM students s
        JOIN classes c ON s.class_id = c.id
        WHERE c.instructor_id = auth.uid()
        AND c.tenant_id = current_setting('app.current_tenant_id')::uuid
      )
    )
  );

-- 결제 데이터 보호 (admin만 접근)
CREATE POLICY payments_admin_only ON payments
  FOR ALL TO authenticated
  USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND EXISTS (
      SELECT 1 FROM user_profiles 
      WHERE id = auth.uid() 
      AND role = 'admin'
      AND tenant_id = current_setting('app.current_tenant_id')::uuid
    )
  );
```

### 4. 특수 정책 및 예외 처리 (0.2일)

```sql
-- Service Role은 RLS 우회 (데이터 마이그레이션, 관리 작업용)
CREATE POLICY service_role_bypass ON students
  FOR ALL TO service_role
  USING (true);

-- 읽기 전용 뷰어 역할 정책
CREATE POLICY viewer_read_only ON students
  FOR SELECT TO authenticated
  USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND EXISTS (
      SELECT 1 FROM user_profiles 
      WHERE id = auth.uid() 
      AND role = 'viewer'
      AND tenant_id = current_setting('app.current_tenant_id')::uuid
    )
  );

-- 테넌트 관리자는 사용자 프로필 관리 가능
CREATE POLICY tenant_admin_user_management ON user_profiles
  FOR ALL TO authenticated
  USING (
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND (
      id = auth.uid() -- 본인 프로필
      OR
      EXISTS (
        SELECT 1 FROM user_profiles up
        WHERE up.id = auth.uid()
        AND up.role = 'admin'
        AND up.tenant_id = current_setting('app.current_tenant_id')::uuid
      )
    )
  );
```

### 5. RLS 성능 최적화 및 모니터링 (0.1일)

```sql
-- RLS 정책 실행 성능을 위한 인덱스 추가
CREATE INDEX IF NOT EXISTS idx_user_profiles_tenant_role 
  ON user_profiles(tenant_id, role);

CREATE INDEX IF NOT EXISTS idx_classes_instructor_tenant
  ON classes(instructor_id, tenant_id);

CREATE INDEX IF NOT EXISTS idx_students_class_tenant
  ON students(class_id, tenant_id);

-- RLS 정책 성능 모니터링 함수
CREATE OR REPLACE FUNCTION monitor_rls_performance()
RETURNS TABLE(
  table_name text,
  policy_name text,
  query_count bigint,
  avg_duration_ms numeric
) AS $$
BEGIN
  -- pg_stat_user_tables와 결합하여 RLS 성능 모니터링
  RETURN QUERY
  SELECT 
    schemaname||'.'||tablename as table_name,
    'RLS_POLICY' as policy_name,
    seq_scan + idx_scan as query_count,
    CASE 
      WHEN seq_scan + idx_scan > 0 
      THEN (seq_tup_read + idx_tup_fetch)::numeric / (seq_scan + idx_scan)
      ELSE 0 
    END as avg_duration_ms
  FROM pg_stat_user_tables 
  WHERE schemaname = 'public';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 🛠 기술 요구사항

### RLS 정책 검증 도구
```sql
-- RLS 정책 테스트 함수
CREATE OR REPLACE FUNCTION test_rls_policy(
  table_name text,
  user_role text,
  tenant_id uuid,
  expected_count integer
) RETURNS boolean AS $$
DECLARE
  actual_count integer;
BEGIN
  -- 특정 역할로 설정
  PERFORM set_config('app.current_tenant_id', tenant_id::text, true);
  
  -- 테이블 조회 결과 확인
  EXECUTE format('SELECT COUNT(*) FROM %I', table_name) INTO actual_count;
  
  RETURN actual_count = expected_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 애플리케이션 연동 함수
```typescript
// lib/supabase/rlsUtils.ts
export async function setTenantContext(supabase: SupabaseClient, tenantId: string) {
  const { error } = await supabase.rpc('set_tenant_context', {
    tenant_id: tenantId
  })
  
  if (error) {
    throw new Error(`Failed to set tenant context: ${error.message}`)
  }
}

export async function getCurrentTenantId(supabase: SupabaseClient): Promise<string | null> {
  const { data, error } = await supabase.rpc('get_current_tenant_id')
  
  if (error) {
    console.error('Failed to get current tenant ID:', error)
    return null
  }
  
  return data
}
```

## 📂 생성될 파일 구조

```
sql/
├── rls_policies/
│   ├── 01_enable_rls.sql              # RLS 활성화
│   ├── 02_tenant_isolation.sql        # 테넌트 격리 정책
│   ├── 03_role_based_access.sql       # 역할별 접근 정책
│   ├── 04_ownership_policies.sql      # 소유권 기반 정책  
│   ├── 05_special_policies.sql        # 특수 정책
│   └── 06_performance_optimization.sql # 성능 최적화
├── functions/
│   ├── tenant_context_functions.sql   # 테넌트 컨텍스트 관리
│   ├── rls_monitoring_functions.sql   # RLS 모니터링 함수
│   └── rls_testing_functions.sql      # RLS 테스트 함수
└── tests/
    ├── rls_policy_tests.sql           # RLS 정책 테스트
    └── performance_tests.sql          # 성능 테스트
```

## 🧪 테스트 계획

### 정책 검증 테스트
```sql
-- 테넌트 격리 테스트
SELECT test_tenant_isolation('tenant_1', 'tenant_2');

-- 역할별 접근 권한 테스트  
SELECT test_role_access('admin', 'students', true);
SELECT test_role_access('viewer', 'payments', false);

-- 소유권 기반 접근 테스트
SELECT test_instructor_ownership('instructor_1', 'student_in_other_class', false);
```

### 성능 테스트
- [ ] 대용량 데이터에서 RLS 정책 성능 측정
- [ ] 복잡한 조인 쿼리에서 RLS 오버헤드 확인
- [ ] 인덱스 최적화 효과 검증

### 보안 테스트
- [ ] 테넌트간 데이터 누출 방지 확인
- [ ] 권한 상승 공격 방지 테스트
- [ ] SQL 인젝션 통한 RLS 우회 시도 테스트

## 📋 완료 조건

- [ ] 모든 핵심 테이블에 RLS 활성화
- [ ] 테넌트별 완전한 데이터 격리
- [ ] 4가지 역할별 접근 권한 정책 동작
- [ ] instructor의 소유권 기반 접근 제어  
- [ ] Service Role의 관리 작업 우회 가능
- [ ] RLS 정책 성능 최적화 완료
- [ ] 모든 정책 테스트 통과
- [ ] RLS 모니터링 도구 구축

## 🔗 의존성

**선행 작업**:
- ✅ T-005: RBAC 권한 시스템 테스트 및 RLS 검증  
- T-007: Supabase Auth 인증 시스템 구현
- T-008: RBAC 기본 구조 구현

**후속 작업**:
- T-010: 공통 레이아웃 컴포넌트 개발
- T-011: 에러 핸들링 시스템 구축

## 💡 구현 참고사항

### RLS 디버깅
```sql
-- RLS 정책 실행 계획 확인
EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON) 
SELECT * FROM students WHERE name LIKE '%홍길동%';

-- 현재 적용된 정책 확인
SELECT * FROM pg_policies WHERE tablename = 'students';
```

### 성능 최적화 팁
```sql
-- RLS 정책에서 서브쿼리 최적화
CREATE POLICY optimized_policy ON students
  FOR SELECT TO authenticated
  USING (
    -- EXISTS보다 JOIN이 더 효율적일 수 있음
    tenant_id = current_setting('app.current_tenant_id')::uuid
    AND tenant_id IN (
      SELECT up.tenant_id 
      FROM user_profiles up 
      WHERE up.id = auth.uid()
    )
  );
```

### 에러 처리
```typescript
// RLS 정책 위반 시 사용자 친화적 에러 메시지
export function handleRLSError(error: any) {
  if (error.message?.includes('row-level security')) {
    throw new Error('해당 데이터에 접근할 권한이 없습니다')
  }
  throw error
}
```

## 📈 예상 리스크 및 대응

| 리스크 | 확률 | 영향도 | 대응방안 |
|-------|------|--------|----------|
| RLS 성능 오버헤드 | 중간 | 높음 | 인덱스 최적화, 쿼리 튜닝 |
| 복잡한 정책 로직 | 높음 | 중간 | 단계적 구현, 철저한 테스트 |
| 정책 충돌 | 중간 | 높음 | 명확한 정책 우선순위 정의 |
| 디버깅 어려움 | 중간 | 중간 | 전용 디버깅 도구 구축 |

**총 예상 소요**: 1.5일 (RLS 정책 복잡도 및 테스트 시간 고려)