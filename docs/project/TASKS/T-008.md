# T-008: RBAC ê¸°ë³¸ êµ¬ì¡° êµ¬í˜„

**ìƒì„±ì¼**: 2025-08-11  
**ìƒíƒœ**: TODO  
**ìš°ì„ ìˆœìœ„**: P0 (MVP í•„ìˆ˜)  
**ë‹´ë‹¹ì**: Backend + Frontend  
**ì˜ˆìƒ ì†Œìš”**: 2.0ì¼  
**ìŠ¤í”„ë¦°íŠ¸**: S1 (Week 2)  
**ê¸°í•œ**: 2025-08-21

## ğŸ“‹ ì‘ì—… ê°œìš”

EduCanvasì˜ ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ì—ì„œ 4ê°€ì§€ ì—­í• (admin, instructor, staff, viewer)ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´(RBAC) ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤. T-005ì—ì„œ í…ŒìŠ¤íŠ¸í•œ ê¶Œí•œ êµ¬ì¡°ë¥¼ ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì™„ì „í•œ RBAC ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

## ğŸ¯ ì‘ì—… ëª©í‘œ

1. **4ê°€ì§€ ì—­í•  ë° ê¶Œí•œ ì²´ê³„ ì •ì˜**
2. **ê¶Œí•œ ê²€ì¦ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„**  
3. **ì»´í¬ë„ŒíŠ¸ ë ˆë²¨ ê¶Œí•œ ì œì–´**
4. **í˜ì´ì§€ ë ˆë²¨ ì ‘ê·¼ ì œì–´**
5. **ê¶Œí•œë³„ UI í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬**

## ğŸ“š ì„¸ë¶€ ì‘ì—… í•­ëª©

### 1. ê¶Œí•œ ì²´ê³„ ì •ì˜ ë° íƒ€ì… ìƒì„± (0.3ì¼)

```typescript
// types/permissions.ts
export type Role = 'admin' | 'instructor' | 'staff' | 'viewer'

export interface Permission {
  resource: string
  action: 'create' | 'read' | 'update' | 'delete'
}

export const PERMISSIONS: Record<Role, Permission[]> = {
  admin: [
    { resource: 'students', action: 'create' },
    { resource: 'students', action: 'read' },
    { resource: 'students', action: 'update' },
    { resource: 'students', action: 'delete' },
    { resource: 'instructors', action: 'create' },
    { resource: 'instructors', action: 'read' },
    { resource: 'instructors', action: 'update' },
    { resource: 'instructors', action: 'delete' },
    { resource: 'classes', action: 'create' },
    { resource: 'classes', action: 'read' },
    { resource: 'classes', action: 'update' },
    { resource: 'classes', action: 'delete' },
    { resource: 'payments', action: 'create' },
    { resource: 'payments', action: 'read' },
    { resource: 'payments', action: 'update' },
    { resource: 'payments', action: 'delete' },
  ],
  instructor: [
    { resource: 'students', action: 'read' },
    { resource: 'students', action: 'update' }, // ë³¸ì¸ ë‹´ë‹¹ í•™ìƒë§Œ
    { resource: 'classes', action: 'read' }, // ë³¸ì¸ ë‹´ë‹¹ í´ë˜ìŠ¤ë§Œ
    { resource: 'classes', action: 'update' }, // ë³¸ì¸ ë‹´ë‹¹ í´ë˜ìŠ¤ë§Œ
    { resource: 'attendance', action: 'create' },
    { resource: 'attendance', action: 'read' },
    { resource: 'attendance', action: 'update' },
  ],
  staff: [
    { resource: 'students', action: 'create' },
    { resource: 'students', action: 'read' },
    { resource: 'students', action: 'update' },
    { resource: 'classes', action: 'read' },
    { resource: 'payments', action: 'read' },
  ],
  viewer: [
    { resource: 'students', action: 'read' },
    { resource: 'classes', action: 'read' },
  ]
}
```

### 2. ê¶Œí•œ ê²€ì¦ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ êµ¬í˜„ (0.4ì¼)

```typescript
// lib/permissions/permissionUtils.ts
export function hasPermission(
  userRole: Role,
  resource: string,
  action: string
): boolean {
  const rolePermissions = PERMISSIONS[userRole]
  return rolePermissions.some(
    perm => perm.resource === resource && perm.action === action
  )
}

export function checkResourceAccess(
  userRole: Role,
  userId: string,
  resource: string,
  resourceOwnerId?: string
): boolean {
  // ê¸°ë³¸ ê¶Œí•œ í™•ì¸
  if (!hasPermission(userRole, resource, 'read')) {
    return false
  }
  
  // instructorëŠ” ë³¸ì¸ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë§Œ ì ‘ê·¼ ê°€ëŠ¥
  if (userRole === 'instructor') {
    return userId === resourceOwnerId
  }
  
  return true
}
```

### 3. ê¶Œí•œ ê¸°ë°˜ ë¼ìš°íŒ… ë¯¸ë“¤ì›¨ì–´ (0.3ì¼)

```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

const PROTECTED_ROUTES = {
  '/admin': ['admin'],
  '/admin/students': ['admin', 'staff'],
  '/admin/instructors': ['admin'],
  '/admin/payments': ['admin'],
  '/instructor': ['instructor'],
  '/staff': ['staff'],
} as const

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })

  const {
    data: { session },
  } = await supabase.auth.getSession()

  // ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì ì²˜ë¦¬
  if (!session) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  // ê¶Œí•œ í™•ì¸
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('role')
    .eq('id', session.user.id)
    .single()

  if (!profile) {
    return NextResponse.redirect(new URL('/unauthorized', req.url))
  }

  // ê²½ë¡œë³„ ê¶Œí•œ ê²€ì¦
  const pathname = req.nextUrl.pathname
  const requiredRoles = PROTECTED_ROUTES[pathname as keyof typeof PROTECTED_ROUTES]

  if (requiredRoles && !requiredRoles.includes(profile.role)) {
    return NextResponse.redirect(new URL('/unauthorized', req.url))
  }

  return res
}

export const config = {
  matcher: ['/admin/:path*', '/instructor/:path*', '/staff/:path*']
}
```

### 4. ê¶Œí•œ ê¸°ë°˜ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„ (0.5ì¼)

```typescript
// components/auth/PermissionGuard.tsx
interface PermissionGuardProps {
  resource: string
  action: string
  children: React.ReactNode
  fallback?: React.ReactNode
  ownerId?: string // ë¦¬ì†ŒìŠ¤ ì†Œìœ ì ID
}

export function PermissionGuard({
  resource,
  action,
  children,
  fallback = null,
  ownerId
}: PermissionGuardProps) {
  const { user, profile } = useAuth()
  
  const hasAccess = useMemo(() => {
    if (!profile) return false
    
    const hasBasicPermission = hasPermission(profile.role, resource, action)
    if (!hasBasicPermission) return false
    
    // ì†Œìœ ê¶Œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´
    if (ownerId) {
      return checkResourceAccess(profile.role, user.id, resource, ownerId)
    }
    
    return true
  }, [profile, resource, action, ownerId, user.id])
  
  return hasAccess ? <>{children}</> : <>{fallback}</>
}

// components/auth/RoleGuard.tsx
interface RoleGuardProps {
  allowedRoles: Role[]
  children: React.ReactNode
  fallback?: React.ReactNode
}

export function RoleGuard({ 
  allowedRoles, 
  children, 
  fallback = null 
}: RoleGuardProps) {
  const { profile } = useAuth()
  
  const hasRole = profile && allowedRoles.includes(profile.role)
  
  return hasRole ? <>{children}</> : <>{fallback}</>
}
```

### 5. ê¶Œí•œë³„ ë„¤ë¹„ê²Œì´ì…˜ êµ¬í˜„ (0.5ì¼)

```typescript
// components/layout/Sidebar.tsx
const NAVIGATION_ITEMS = [
  {
    name: 'ëŒ€ì‹œë³´ë“œ',
    href: '/admin',
    icon: HomeIcon,
    requiredRoles: ['admin', 'instructor', 'staff', 'viewer']
  },
  {
    name: 'í•™ìƒ ê´€ë¦¬',
    href: '/admin/students',
    icon: UsersIcon,
    requiredRoles: ['admin', 'staff']
  },
  {
    name: 'ê°•ì‚¬ ê´€ë¦¬',
    href: '/admin/instructors',
    icon: AcademicCapIcon,
    requiredRoles: ['admin']
  },
  {
    name: 'ê²°ì œ ê´€ë¦¬',
    href: '/admin/payments',
    icon: CreditCardIcon,
    requiredRoles: ['admin']
  },
  {
    name: 'ë‚´ ìˆ˜ì—…',
    href: '/instructor/classes',
    icon: BookOpenIcon,
    requiredRoles: ['instructor']
  }
]

export function Sidebar() {
  const { profile } = useAuth()
  
  const visibleItems = NAVIGATION_ITEMS.filter(item =>
    item.requiredRoles.includes(profile?.role || 'viewer')
  )
  
  return (
    <nav>
      {visibleItems.map(item => (
        <NavItem key={item.href} item={item} />
      ))}
    </nav>
  )
}
```

## ğŸ›  ê¸°ìˆ  ìš”êµ¬ì‚¬í•­

### ê¶Œí•œ ê²€ì¦ ì„±ëŠ¥ ìµœì í™”
```typescript
// ê¶Œí•œ ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ ê°œì„ 
const usePermissions = () => {
  const { profile } = useAuth()
  
  return useMemo(() => {
    if (!profile) return []
    return PERMISSIONS[profile.role]
  }, [profile?.role])
}

// ê¶Œí•œ ì²´í¬ ê²°ê³¼ ë©”ëª¨ì´ì œì´ì…˜
const useHasPermission = (resource: string, action: string) => {
  const permissions = usePermissions()
  
  return useMemo(() => {
    return permissions.some(
      perm => perm.resource === resource && perm.action === action
    )
  }, [permissions, resource, action])
}
```

### ê°œë°œ ë„êµ¬ ì§€ì›
```typescript
// ê°œë°œ í™˜ê²½ì—ì„œ ê¶Œí•œ ë””ë²„ê¹… ë„êµ¬
if (process.env.NODE_ENV === 'development') {
  (window as any).__RBAC_DEBUG__ = {
    currentUser: () => useAuth(),
    checkPermission: (resource: string, action: string) => 
      hasPermission(useAuth().profile?.role!, resource, action),
    listPermissions: (role: Role) => PERMISSIONS[role]
  }
}
```

## ğŸ“‚ ìƒì„±ë  íŒŒì¼ êµ¬ì¡°

```
src/
â”œâ”€â”€ components/auth/
â”‚   â”œâ”€â”€ PermissionGuard.tsx
â”‚   â”œâ”€â”€ RoleGuard.tsx
â”‚   â””â”€â”€ UnauthorizedPage.tsx
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ usePermissions.ts
â”‚   â”œâ”€â”€ useRoleGuard.ts
â”‚   â””â”€â”€ useResourceAccess.ts
â”œâ”€â”€ lib/permissions/
â”‚   â”œâ”€â”€ permissions.ts
â”‚   â”œâ”€â”€ permissionUtils.ts
â”‚   â”œâ”€â”€ roleCheckers.ts
â”‚   â””â”€â”€ rbacTypes.ts
â”œâ”€â”€ middleware.ts
â””â”€â”€ app/
    â”œâ”€â”€ unauthorized/
    â”‚   â””â”€â”€ page.tsx
    â””â”€â”€ (protected)/
        â”œâ”€â”€ admin/
        â”œâ”€â”€ instructor/
        â””â”€â”€ staff/
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
- [ ] ì—­í• ë³„ ì ‘ê·¼ ê¶Œí•œ í…ŒìŠ¤íŠ¸
- [ ] ì†Œìœ ê¶Œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´ í…ŒìŠ¤íŠ¸

### í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ë¯¸ë“¤ì›¨ì–´ ê¶Œí•œ ê²€ì¦ í…ŒìŠ¤íŠ¸
- [ ] í˜ì´ì§€ ì ‘ê·¼ ì œì–´ í…ŒìŠ¤íŠ¸  
- [ ] ì»´í¬ë„ŒíŠ¸ ê¶Œí•œ ê°€ë“œ í…ŒìŠ¤íŠ¸

### E2E í…ŒìŠ¤íŠ¸
- [ ] ì—­í• ë³„ ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- [ ] ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì ‘ê·¼ ì°¨ë‹¨ í…ŒìŠ¤íŠ¸
- [ ] ê¶Œí•œ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸

## ğŸ“‹ ì™„ë£Œ ì¡°ê±´

- [ ] 4ê°€ì§€ ì—­í• ë³„ ê¶Œí•œ ì²´ê³„ ì™„ì „ ì •ì˜
- [ ] í˜ì´ì§€ ë ˆë²¨ ì ‘ê·¼ ì œì–´ ë™ì‘
- [ ] ì»´í¬ë„ŒíŠ¸ ë ˆë²¨ ê¶Œí•œ ê°€ë“œ ë™ì‘
- [ ] ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ì—­í• ë³„ í‘œì‹œ/ìˆ¨ê¹€
- [ ] ë²„íŠ¼/ë§í¬ ê¶Œí•œë³„ í™œì„±í™”/ë¹„í™œì„±í™”
- [ ] ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì‹œ ì ì ˆí•œ ì—ëŸ¬ í˜ì´ì§€
- [ ] instructorì˜ ì†Œìœ ê¶Œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- [ ] ê¶Œí•œ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸

## ğŸ”— ì˜ì¡´ì„±

**ì„ í–‰ ì‘ì—…**:
- âœ… T-005: RBAC ê¶Œí•œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ë° RLS ê²€ì¦
- âœ… T-006: UI ì»´í¬ë„ŒíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
- T-007: Supabase Auth ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„

**í›„ì† ì‘ì—…**:
- T-009: RLS ì •ì±… ê¸°ë³¸ ì ìš©
- T-010: ê³µí†µ ë ˆì´ì•„ì›ƒ ì»´í¬ë„ŒíŠ¸ ê°œë°œ

## ğŸ’¡ êµ¬í˜„ ì°¸ê³ ì‚¬í•­

### ì„±ëŠ¥ ìµœì í™”
```typescript
// ê¶Œí•œ ì²´í¬ ê²°ê³¼ ìºì‹±
const permissionCache = new Map<string, boolean>()

const cachedHasPermission = (role: Role, resource: string, action: string) => {
  const key = `${role}-${resource}-${action}`
  
  if (permissionCache.has(key)) {
    return permissionCache.get(key)!
  }
  
  const result = hasPermission(role, resource, action)
  permissionCache.set(key, result)
  return result
}
```

### ì—ëŸ¬ ì²˜ë¦¬
```typescript
// ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì‹œ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€
export function UnauthorizedPage() {
  const { profile } = useAuth()
  
  return (
    <div className="text-center py-12">
      <h2 className="text-2xl font-bold text-gray-900">
        ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤
      </h2>
      <p className="mt-4 text-gray-600">
        í˜„ì¬ {profile?.role} ê¶Œí•œìœ¼ë¡œëŠ” ì´ í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
      </p>
      <Button href="/admin" className="mt-6">
        ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
      </Button>
    </div>
  )
}
```

## ğŸ“ˆ ì˜ˆìƒ ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘

| ë¦¬ìŠ¤í¬ | í™•ë¥  | ì˜í–¥ë„ | ëŒ€ì‘ë°©ì•ˆ |
|-------|------|--------|----------|
| ë³µì¡í•œ ê¶Œí•œ ë¡œì§ | ì¤‘ê°„ | ë†’ìŒ | ë‹¨ê³„ì  êµ¬í˜„, ì² ì €í•œ í…ŒìŠ¤íŠ¸ |
| ì„±ëŠ¥ ì´ìŠˆ (ê¶Œí•œ ì²´í¬) | ì¤‘ê°„ | ì¤‘ê°„ | ìºì‹± ë° ë©”ëª¨ì´ì œì´ì…˜ |
| ê¶Œí•œ ì²´ê³„ ë³€ê²½ ìš”êµ¬ | ë†’ìŒ | ì¤‘ê°„ | ìœ ì—°í•œ êµ¬ì¡° ì„¤ê³„ |
| ì†Œìœ ê¶Œ ê²€ì¦ ë³µì¡ì„± | ì¤‘ê°„ | ì¤‘ê°„ | ëª…í™•í•œ ê·œì¹™ ì •ì˜ |

**ì´ ì˜ˆìƒ ì†Œìš”**: 2.0ì¼ (RBAC ì‹œìŠ¤í…œ ë³µì¡ë„ ê³ ë ¤)