# T-008: RBAC ê¸°ë³¸ êµ¬ì¡° êµ¬í˜„

**ìƒì„±ì¼**: 2025-08-11  
**ìƒíƒœ**: TODO  
**ìš°ì„ ìˆœìœ„**: P0 (MVP í•„ìˆ˜)  
**ë‹´ë‹¹ì**: Backend + Frontend  
**ì˜ˆìƒ ì†Œìš”**: 2.0ì¼  
**ìŠ¤í”„ë¦°íŠ¸**: S1 (Week 2)  
**ê¸°í•œ**: 2025-08-21

## ğŸ“‹ ì‘ì—… ê°œìš”

EduCanvasì˜ ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ì—ì„œ 4ê°€ì§€ ì—­í• (admin, instructor, staff, viewer)ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´(RBAC) ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤. T-005ì—ì„œ í…ŒìŠ¤íŠ¸í•œ ê¶Œí•œ êµ¬ì¡°ë¥¼ ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì™„ì „í•œ RBAC ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

## ğŸ¯ ì‘ì—… ëª©í‘œ

1. **4ê°€ì§€ ì—­í•  ë° ê¶Œí•œ ì²´ê³„ ì •ì˜**
2. **ê¶Œí•œ ê²€ì¦ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„**  
3. **ì»´í¬ë„ŒíŠ¸ ë ˆë²¨ ê¶Œí•œ ì œì–´**
4. **í˜ì´ì§€ ë ˆë²¨ ì ‘ê·¼ ì œì–´**
5. **ê¶Œí•œë³„ UI í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬**

## ğŸ“š ì„¸ë¶€ ì‘ì—… í•­ëª©

### 1. ê¶Œí•œ ì²´ê³„ ì •ì˜ ë° íƒ€ì… ìƒì„± (0.3ì¼)

```typescript
// types/permissions.ts
export type Role = 'admin' | 'instructor' | 'staff' | 'viewer'

export interface Permission {
  resource: string
  action: 'create' | 'read' | 'update' | 'delete'
}

export const PERMISSIONS: Record<Role, Permission[]> = {
  admin: [
    { resource: 'students', action: 'create' },
    { resource: 'students', action: 'read' },
    { resource: 'students', action: 'update' },
    { resource: 'students', action: 'delete' },
    { resource: 'instructors', action: 'create' },
    { resource: 'instructors', action: 'read' },
    { resource: 'instructors', action: 'update' },
    { resource: 'instructors', action: 'delete' },
    { resource: 'classes', action: 'create' },
    { resource: 'classes', action: 'read' },
    { resource: 'classes', action: 'update' },
    { resource: 'classes', action: 'delete' },
    { resource: 'payments', action: 'create' },
    { resource: 'payments', action: 'read' },
    { resource: 'payments', action: 'update' },
    { resource: 'payments', action: 'delete' },
  ],
  instructor: [
    { resource: 'students', action: 'read' },
    { resource: 'students', action: 'update' }, // ë³¸ì¸ ë‹´ë‹¹ í•™ìƒë§Œ
    { resource: 'classes', action: 'read' }, // ë³¸ì¸ ë‹´ë‹¹ í´ë˜ìŠ¤ë§Œ
    { resource: 'classes', action: 'update' }, // ë³¸ì¸ ë‹´ë‹¹ í´ë˜ìŠ¤ë§Œ
    { resource: 'attendance', action: 'create' },
    { resource: 'attendance', action: 'read' },
    { resource: 'attendance', action: 'update' },
  ],
  staff: [
    { resource: 'students', action: 'create' },
    { resource: 'students', action: 'read' },
    { resource: 'students', action: 'update' },
    { resource: 'classes', action: 'read' },
    { resource: 'payments', action: 'read' },
  ],
  viewer: [
    { resource: 'students', action: 'read' },
    { resource: 'classes', action: 'read' },
  ]
}
```

### 2. ê¶Œí•œ ê²€ì¦ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ êµ¬í˜„ (0.4ì¼)

```typescript
// lib/permissions/permissionUtils.ts
export function hasPermission(
  userRole: Role,
  resource: string,
  action: string
): boolean {
  const rolePermissions = PERMISSIONS[userRole]
  return rolePermissions.some(
    perm => perm.resource === resource && perm.action === action
  )
}

export function checkResourceAccess(
  userRole: Role,
  userId: string,
  resource: string,
  resourceOwnerId?: string
): boolean {
  // ê¸°ë³¸ ê¶Œí•œ í™•ì¸
  if (!hasPermission(userRole, resource, 'read')) {
    return false
  }
  
  // instructorëŠ” ë³¸ì¸ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë§Œ ì ‘ê·¼ ê°€ëŠ¥
  if (userRole === 'instructor') {
    return userId === resourceOwnerId
  }
  
  return true
}
```

### 3. ê¶Œí•œ ê¸°ë°˜ ë¼ìš°íŒ… ë¯¸ë“¤ì›¨ì–´ (0.3ì¼)

```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

const PROTECTED_ROUTES = {
  '/admin': ['admin'],
  '/admin/students': ['admin', 'staff'],
  '/admin/instructors': ['admin'],
  '/admin/payments': ['admin'],
  '/instructor': ['instructor'],
  '/staff': ['staff'],
} as const

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })

  const {
    data: { session },
  } = await supabase.auth.getSession()

  // ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì ì²˜ë¦¬
  if (!session) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  // ê¶Œí•œ í™•ì¸
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('role')
    .eq('id', session.user.id)
    .single()

  if (!profile) {
    return NextResponse.redirect(new URL('/unauthorized', req.url))
  }

  // ê²½ë¡œë³„ ê¶Œí•œ ê²€ì¦
  const pathname = req.nextUrl.pathname
  const requiredRoles = PROTECTED_ROUTES[pathname as keyof typeof PROTECTED_ROUTES]

  if (requiredRoles && !requiredRoles.includes(profile.role)) {
    return NextResponse.redirect(new URL('/unauthorized', req.url))
  }

  return res
}

export const config = {
  matcher: ['/admin/:path*', '/instructor/:path*', '/staff/:path*']
}
```

### 4. ê¶Œí•œ ê¸°ë°˜ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„ (0.5ì¼)

```typescript
// components/auth/PermissionGuard.tsx
interface PermissionGuardProps {
  resource: string
  action: string
  children: React.ReactNode
  fallback?: React.ReactNode
  ownerId?: string // ë¦¬ì†ŒìŠ¤ ì†Œìœ ì ID
}

export function PermissionGuard({
  resource,
  action,
  children,
  fallback = null,
  ownerId
}: PermissionGuardProps) {
  const { user, profile } = useAuth()
  
  const hasAccess = useMemo(() => {
    if (!profile) return false
    
    const hasBasicPermission = hasPermission(profile.role, resource, action)
    if (!hasBasicPermission) return false
    
    // ì†Œìœ ê¶Œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´
    if (ownerId) {
      return checkResourceAccess(profile.role, user.id, resource, ownerId)
    }
    
    return true
  }, [profile, resource, action, ownerId, user.id])
  
  return hasAccess ? <>{children}</> : <>{fallback}</>
}

// components/auth/RoleGuard.tsx
interface RoleGuardProps {
  allowedRoles: Role[]
  children: React.ReactNode
  fallback?: React.ReactNode
}

export function RoleGuard({ 
  allowedRoles, 
  children, 
  fallback = null 
}: RoleGuardProps) {
  const { profile } = useAuth()
  
  const hasRole = profile && allowedRoles.includes(profile.role)
  
  return hasRole ? <>{children}</> : <>{fallback}</>
}
```

### 5. ê¶Œí•œë³„ ë„¤ë¹„ê²Œì´ì…˜ êµ¬í˜„ (0.5ì¼)

```typescript
// components/layout/Sidebar.tsx
const NAVIGATION_ITEMS = [
  {
    name: 'ëŒ€ì‹œë³´ë“œ',
    href: '/admin',
    icon: HomeIcon,
    requiredRoles: ['admin', 'instructor', 'staff', 'viewer']
  },
  {
    name: 'í•™ìƒ ê´€ë¦¬',
    href: '/admin/students',
    icon: UsersIcon,
    requiredRoles: ['admin', 'staff']
  },
  {
    name: 'ê°•ì‚¬ ê´€ë¦¬',
    href: '/admin/instructors',
    icon: AcademicCapIcon,
    requiredRoles: ['admin']
  },
  {
    name: 'ê²°ì œ ê´€ë¦¬',
    href: '/admin/payments',
    icon: CreditCardIcon,
    requiredRoles: ['admin']
  },
  {
    name: 'ë‚´ ìˆ˜ì—…',
    href: '/instructor/classes',
    icon: BookOpenIcon,
    requiredRoles: ['instructor']
  }
]

export function Sidebar() {
  const { profile } = useAuth()
  
  const visibleItems = NAVIGATION_ITEMS.filter(item =>
    item.requiredRoles.includes(profile?.role || 'viewer')
  )
  
  return (
    <nav>
      {visibleItems.map(item => (
        <NavItem key={item.href} item={item} />
      ))}
    </nav>
  )
}
```

## ğŸ›  ê¸°ìˆ  ìš”êµ¬ì‚¬í•­

### ê¶Œí•œ ê²€ì¦ ì„±ëŠ¥ ìµœì í™”
```typescript
// ê¶Œí•œ ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ ê°œì„ 
const usePermissions = () => {
  const { profile } = useAuth()
  
  return useMemo(() => {
    if (!profile) return []
    return PERMISSIONS[profile.role]
  }, [profile?.role])
}

// ê¶Œí•œ ì²´í¬ ê²°ê³¼ ë©”ëª¨ì´ì œì´ì…˜
const useHasPermission = (resource: string, action: string) => {
  const permissions = usePermissions()
  
  return useMemo(() => {
    return permissions.some(
      perm => perm.resource === resource && perm.action === action
    )
  }, [permissions, resource, action])
}
```

### ê°œë°œ ë„êµ¬ ì§€ì›
```typescript
// ê°œë°œ í™˜ê²½ì—ì„œ ê¶Œí•œ ë””ë²„ê¹… ë„êµ¬
if (process.env.NODE_ENV === 'development') {
  (window as any).__RBAC_DEBUG__ = {
    currentUser: () => useAuth(),
    checkPermission: (resource: string, action: string) => 
      hasPermission(useAuth().profile?.role!, resource, action),
    listPermissions: (role: Role) => PERMISSIONS[role]
  }
}
```

## ğŸ“‚ ìƒì„±ë  íŒŒì¼ êµ¬ì¡°

```
src/
â”œâ”€â”€ components/auth/
â”‚   â”œâ”€â”€ PermissionGuard.tsx
â”‚   â”œâ”€â”€ RoleGuard.tsx
â”‚   â””â”€â”€ UnauthorizedPage.tsx
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ usePermissions.ts
â”‚   â”œâ”€â”€ useRoleGuard.ts
â”‚   â””â”€â”€ useResourceAccess.ts
â”œâ”€â”€ lib/permissions/
â”‚   â”œâ”€â”€ permissions.ts
â”‚   â”œâ”€â”€ permissionUtils.ts
â”‚   â”œâ”€â”€ roleCheckers.ts
â”‚   â””â”€â”€ rbacTypes.ts
â”œâ”€â”€ middleware.ts
â””â”€â”€ app/
    â”œâ”€â”€ unauthorized/
    â”‚   â””â”€â”€ page.tsx
    â””â”€â”€ (protected)/
        â”œâ”€â”€ admin/
        â”œâ”€â”€ instructor/
        â””â”€â”€ staff/
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
- [ ] ì—­í• ë³„ ì ‘ê·¼ ê¶Œí•œ í…ŒìŠ¤íŠ¸
- [ ] ì†Œìœ ê¶Œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´ í…ŒìŠ¤íŠ¸

### í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ë¯¸ë“¤ì›¨ì–´ ê¶Œí•œ ê²€ì¦ í…ŒìŠ¤íŠ¸
- [ ] í˜ì´ì§€ ì ‘ê·¼ ì œì–´ í…ŒìŠ¤íŠ¸  
- [ ] ì»´í¬ë„ŒíŠ¸ ê¶Œí•œ ê°€ë“œ í…ŒìŠ¤íŠ¸

### E2E í…ŒìŠ¤íŠ¸
- [ ] ì—­í• ë³„ ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- [ ] ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì ì ‘ê·¼ ì°¨ë‹¨ í…ŒìŠ¤íŠ¸
- [ ] ê¶Œí•œ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸

## ğŸ“‹ ì™„ë£Œ ì¡°ê±´

- [ ] 4ê°€ì§€ ì—­í• ë³„ ê¶Œí•œ ì²´ê³„ ì™„ì „ ì •ì˜
- [ ] í˜ì´ì§€ ë ˆë²¨ ì ‘ê·¼ ì œì–´ ë™ì‘
- [ ] ì»´í¬ë„ŒíŠ¸ ë ˆë²¨ ê¶Œí•œ ê°€ë“œ ë™ì‘
- [ ] ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ì—­í• ë³„ í‘œì‹œ/ìˆ¨ê¹€
- [ ] ë²„íŠ¼/ë§í¬ ê¶Œí•œë³„ í™œì„±í™”/ë¹„í™œì„±í™”
- [ ] ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì‹œ ì ì ˆí•œ ì—ëŸ¬ í˜ì´ì§€
- [ ] instructorì˜ ì†Œìœ ê¶Œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- [ ] ê¶Œí•œ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸

## ğŸ”— ì˜ì¡´ì„±

**ì„ í–‰ ì‘ì—…**:
- âœ… T-005: RBAC ê¶Œí•œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ë° RLS ê²€ì¦
- âœ… T-006: UI ì»´í¬ë„ŒíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
- T-007: Supabase Auth ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„

**í›„ì† ì‘ì—…**:
- T-009: RLS ì •ì±… ê¸°ë³¸ ì ìš©
- T-010: ê³µí†µ ë ˆì´ì•„ì›ƒ ì»´í¬ë„ŒíŠ¸ ê°œë°œ

## ğŸ’¡ êµ¬í˜„ ì°¸ê³ ì‚¬í•­

### ì„±ëŠ¥ ìµœì í™”
```typescript
// ê¶Œí•œ ì²´í¬ ê²°ê³¼ ìºì‹±
const permissionCache = new Map<string, boolean>()

const cachedHasPermission = (role: Role, resource: string, action: string) => {
  const key = `${role}-${resource}-${action}`
  
  if (permissionCache.has(key)) {
    return permissionCache.get(key)!
  }
  
  const result = hasPermission(role, resource, action)
  permissionCache.set(key, result)
  return result
}
```

### ì—ëŸ¬ ì²˜ë¦¬
```typescript
// ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì‹œ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€
export function UnauthorizedPage() {
  const { profile } = useAuth()
  
  return (
    <div className="text-center py-12">
      <h2 className="text-2xl font-bold text-gray-900">
        ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤
      </h2>
      <p className="mt-4 text-gray-600">
        í˜„ì¬ {profile?.role} ê¶Œí•œìœ¼ë¡œëŠ” ì´ í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
      </p>
      <Button href="/admin" className="mt-6">
        ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
      </Button>
    </div>
  )
}
```

## ğŸ“ˆ ì˜ˆìƒ ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘

| ë¦¬ìŠ¤í¬ | í™•ë¥  | ì˜í–¥ë„ | ëŒ€ì‘ë°©ì•ˆ |
|-------|------|--------|----------|
| ë³µì¡í•œ ê¶Œí•œ ë¡œì§ | ì¤‘ê°„ | ë†’ìŒ | ë‹¨ê³„ì  êµ¬í˜„, ì² ì €í•œ í…ŒìŠ¤íŠ¸ |
| ì„±ëŠ¥ ì´ìŠˆ (ê¶Œí•œ ì²´í¬) | ì¤‘ê°„ | ì¤‘ê°„ | ìºì‹± ë° ë©”ëª¨ì´ì œì´ì…˜ |
| ê¶Œí•œ ì²´ê³„ ë³€ê²½ ìš”êµ¬ | ë†’ìŒ | ì¤‘ê°„ | ìœ ì—°í•œ êµ¬ì¡° ì„¤ê³„ |
| ì†Œìœ ê¶Œ ê²€ì¦ ë³µì¡ì„± | ì¤‘ê°„ | ì¤‘ê°„ | ëª…í™•í•œ ê·œì¹™ ì •ì˜ |

**ì´ ì˜ˆìƒ ì†Œìš”**: 2.0ì¼ (RBAC ì‹œìŠ¤í…œ ë³µì¡ë„ ê³ ë ¤)

---

## ğŸ“‹ 2025-08-13 Schema v4.1 ê¸°ë°˜ ê°œì„ ëœ êµ¬í˜„ ê³„íš

### ğŸ” í˜„ì¬ ìƒí™© ë¶„ì„

#### Schema v4.1 ë°œê²¬ì‚¬í•­
1. **ì‹¤ì œ ì—­í•  ì²´ê³„**: `user_profiles.role`ì€ ë‹¨ìˆœí•œ ENUMì´ ì•„ë‹Œ ë³µì¡í•œ êµ¬ì¡°
2. **í…Œë„ŒíŠ¸ë³„ ì—­í• **: `tenant_memberships`ì™€ `tenant_roles` í…Œì´ë¸”ë¡œ ë©€í‹°ë ˆë²¨ ê¶Œí•œ ì§€ì›
3. **User-First Architecture**: `classes.instructor_id â†’ user_profiles.id` (ì§ì ‘ ì°¸ì¡°)
4. **ê¸°ì¡´ ì‹œìŠ¤í…œ í™œìš©**: í˜„ì¬ `system_admin`, `admin`, `instructor`, `staff` ì—­í•  ì´ë¯¸ ì¡´ì¬

#### ë°ì´í„°ë² ì´ìŠ¤ ENUM ê°’ í™•ì¸
```typescript
// ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì§€ì›í•˜ëŠ” ìƒíƒœê°’ë“¤
user_status: ["active", "inactive", "suspended", "pending_approval"]
student_status: ["active", "inactive", "graduated", "withdrawn", "suspended"]
// user_profiles.roleì€ ë³„ë„ ENUMì´ ì•„ë‹Œ í…Œë„ŒíŠ¸ë³„ ë™ì  ê´€ë¦¬
```

### ğŸ¯ ì¬ì •ì˜ëœ ì—­í•  ì²´ê³„ (Schema v4.1 ê¸°ë°˜)

#### ê¸€ë¡œë²Œ ë ˆë²¨ (user_profiles.role)
- `system_admin`: ì‹œìŠ¤í…œ ì „ì²´ ê´€ë¦¬ (ë©€í‹°í…Œë„ŒíŠ¸ ê´€ë¦¬)
- `admin`: í…Œë„ŒíŠ¸ ê´€ë¦¬ì (í…Œë„ŒíŠ¸ ë‚´ ëª¨ë“  ê¶Œí•œ)
- `instructor`: ê°•ì‚¬ (ë‹´ë‹¹ í´ë˜ìŠ¤/í•™ìƒë§Œ ê´€ë¦¬)
- `staff`: ì§ì› (í•™ìƒ ë“±ë¡, ì¶œê²°, ê²°ì œ ì²˜ë¦¬)
- `viewer`: ì¡°íšŒ ì „ìš©

#### í…Œë„ŒíŠ¸ ë ˆë²¨ (tenant_roles)
- ê° í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ì—­í•  ì •ì˜ ê°€ëŠ¥
- `hierarchy_level`ë¡œ ê¶Œí•œ ê³„ì¸µ êµ¬ì¡° ì§€ì›
- ê¸°ë³¸ ê¶Œí•œ + ì¶”ê°€ ê¶Œí•œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥

### ğŸ› ï¸ ê°œì„ ëœ êµ¬í˜„ ê³„íš

#### 1ë‹¨ê³„: íƒ€ì… ì‹œìŠ¤í…œ ì •ë¦¬ (0.3ì¼)
- âœ… ê¸°ì¡´ `auth.types.ts`ì— ì´ë¯¸ ì •ì˜ëœ íƒ€ì… í™œìš©
- `UserRole` íƒ€ì… í™•ì¥ ë° ì •ì œ
- í…Œë„ŒíŠ¸ë³„ ì—­í•  íƒ€ì… ì¶”ê°€

#### 2ë‹¨ê³„: ê¶Œí•œ ê²€ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ (0.5ì¼)
```typescript
// ë©€í‹°ë ˆë²¨ ê¶Œí•œ ê²€ì¦
export function checkPermission(
  userProfile: UserProfile,
  resource: string,
  action: string,
  tenantId?: string,
  resourceOwnerId?: string
): boolean {
  // 1. ê¸€ë¡œë²Œ ì—­í•  ê¸°ë°˜ ê¶Œí•œ (system_admin ë“±)
  // 2. í…Œë„ŒíŠ¸ ì—­í•  ê¸°ë°˜ ê¶Œí•œ (tenant_roles)
  // 3. ì†Œìœ ê¶Œ ê¸°ë°˜ ê¶Œí•œ (instructor ë³¸ì¸ ë‹´ë‹¹)
  // 4. ë¦¬ì†ŒìŠ¤ë³„ ì„¸ë¶€ ê¶Œí•œ
}
```

#### 3ë‹¨ê³„: ì»´í¬ë„ŒíŠ¸ ê°€ë“œ ì‹œìŠ¤í…œ ê°•í™” (0.4ì¼)
- ê¸°ì¡´ `AuthGuard` í™œìš©í•˜ì—¬ í™•ì¥
- `PermissionGuard`, `RoleGuard` ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
- í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ ì¸ì‹ ê¶Œí•œ ì²´í¬

#### 4ë‹¨ê³„: ë¯¸ë“¤ì›¨ì–´ ê¶Œí•œ ê°•í™” (0.3ì¼)
- í˜„ì¬ middleware.ts í™•ì¥
- í˜ì´ì§€ë³„ ì„¸ë°€í•œ ê¶Œí•œ ì œì–´
- í…Œë„ŒíŠ¸ ê²©ë¦¬ í™•ì¸

#### 5ë‹¨ê³„: UI ê¶Œí•œ ì œì–´ (0.5ì¼)
- ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ë™ì  ìƒì„±
- ë²„íŠ¼/ë§í¬ ê¶Œí•œë³„ í‘œì‹œ/ìˆ¨ê¹€
- ì‹¤ì‹œê°„ ê¶Œí•œ ë³€ê²½ ëŒ€ì‘

### ğŸ¯ í•µì‹¬ ê°œì„ ì‚¬í•­

#### Schema v4.1 ë°˜ì˜ ì‚¬í•­
1. **í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ì—­í• **: `tenant_roles` í…Œì´ë¸” í™œìš©
2. **ê³„ì¸µì  ê¶Œí•œ**: `hierarchy_level`ë¡œ ìƒí•˜ìœ„ ê¶Œí•œ ê´€ë¦¬
3. **ê¶Œí•œ ì˜¤ë²„ë¼ì´ë“œ**: `permissions_override`ë¡œ ì„¸ë°€í•œ ì œì–´
4. **User-First ì•„í‚¤í…ì²˜**: ê¸°ì¡´ ì„¤ê³„ ì¡´ì¤‘

#### ê¸°ì¡´ 4ì—­í•  í™•ì¥
- ê¸°ë³¸ 4ì—­í•  ìœ ì§€í•˜ë˜ í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í„°ë§ˆì´ì§• í—ˆìš©
- `viewer` ì—­í• ì— ì„¸ë¶€ ì¡°íšŒ ê¶Œí•œ êµ¬ë¶„
- `staff` ì—­í• ì— ì—…ë¬´ë³„ ì„¸ë¶„í™” (ì ‘ìˆ˜, ìƒë‹´, ê²°ì œ ë“±)
- `instructor` ì—­í• ì— ë ˆë²¨ë³„ ì°¨ë“± ê¶Œí•œ

#### íƒ€ì… ì•ˆì „ì„± ìµœìš°ì„ 
- ëª¨ë“  ê¶Œí•œ ì²´í¬ì— íƒ€ì… ê°€ë“œ ì ìš©
- ì»´íŒŒì¼ íƒ€ì„ ê¶Œí•œ ê²€ì¦
- ëŸ°íƒ€ì„ ê¶Œí•œ í™•ì¸ ì´ì¤‘í™”

### ğŸ“ ê°œì„ ëœ íŒŒì¼ êµ¬ì¡°

```
src/
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ auth.types.ts (ê¸°ì¡´ í™•ì¥)
â”‚   â””â”€â”€ permissions.types.ts (ì‹ ê·œ)
â”œâ”€â”€ lib/permissions/
â”‚   â”œâ”€â”€ rbac.ts (ë©”ì¸ ê¶Œí•œ ë¡œì§)
â”‚   â”œâ”€â”€ tenantRoles.ts (í…Œë„ŒíŠ¸ë³„ ì—­í• )
â”‚   â””â”€â”€ resourceAccess.ts (ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ ì œì–´)
â”œâ”€â”€ components/auth/
â”‚   â”œâ”€â”€ PermissionGuard.tsx (ì‹ ê·œ)
â”‚   â”œâ”€â”€ RoleGuard.tsx (ì‹ ê·œ)
â”‚   â””â”€â”€ AuthGuard.tsx (ê¸°ì¡´ í™•ì¥)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ usePermissions.ts (ì‹ ê·œ)
â”‚   â””â”€â”€ useTenantRole.ts (ì‹ ê·œ)
â””â”€â”€ middleware.ts (ê¸°ì¡´ í™•ì¥)
```

### âš ï¸ ìœ„í—˜ ìš”ì†Œ ë° ëŒ€ì‘

1. **ë³µì¡ì„± ì¦ê°€**: ë‹¨ê³„ë³„ êµ¬í˜„ìœ¼ë¡œ ì ì§„ì  ì ìš©
2. **ê¸°ì¡´ ì‹œìŠ¤í…œ ì¶©ëŒ**: í˜„ì¬ auth ì‹œìŠ¤í…œê³¼ ì™„ì „ í˜¸í™˜
3. **ì„±ëŠ¥ ì´ìŠˆ**: ê¶Œí•œ ìºì‹± ë° ë©”ëª¨ì´ì œì´ì…˜ ì ìš©
4. **íƒ€ì… ì•ˆì „ì„±**: ì—„ê²©í•œ íƒ€ì… ê°€ë“œ ë° ê²€ì¦

### ğŸ“‹ ì—…ë°ì´íŠ¸ëœ ì™„ë£Œ ì¡°ê±´

- [ ] 5ê°€ì§€ ê¸°ë³¸ ì—­í•  + í…Œë„ŒíŠ¸ ì»¤ìŠ¤í…€ ì—­í•  ì§€ì›
- [ ] í˜ì´ì§€/ì»´í¬ë„ŒíŠ¸ ë ˆë²¨ ê¶Œí•œ ì œì–´ ë™ì‘
- [ ] ì†Œìœ ê¶Œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (instructor â†” ë‹´ë‹¹ í•™ìƒ/í´ë˜ìŠ¤)
- [ ] í…Œë„ŒíŠ¸ë³„ ê¶Œí•œ ê²©ë¦¬ ì™„ì „ êµ¬í˜„
- [ ] ê¶Œí•œ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸
- [ ] íƒ€ì… ì•ˆì „ì„± 100% í™•ë³´ (any íƒ€ì… ì‚¬ìš© ê¸ˆì§€)

**ìˆ˜ì •ëœ ì˜ˆìƒ ì†Œìš”**: 2.0ì¼ â†’ **2.5ì¼** (Schema v4.1 ë³µì¡ì„± ë°˜ì˜)

---

**ë¬¸ì„œ ì—…ë°ì´íŠ¸**: 2025-08-13 - Schema v4.1 ë¶„ì„ ê²°ê³¼ ë°˜ì˜