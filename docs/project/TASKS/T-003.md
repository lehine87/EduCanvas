---
id: T-003
title: Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î∞è database_schema_v3.sql Ï†ÅÏö©
status: TODO
priority: P0
assignees: [Backend Dev]
estimate: 1.0d
due: 2025-08-14
dependencies: [T-001]
labels: [database, setup, infrastructure]
---

# T-003: Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î∞è database_schema_v3.sql Ï†ÅÏö©

## üìã ÏûëÏóÖ Í∞úÏöî

EduCanvas MVPÏùò Î∞±ÏóîÎìú Ïù∏ÌîÑÎùºÏù∏ Supabase ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÉùÏÑ±ÌïòÍ≥†, Î≥µÏû°Ìïú ÏöîÍ∏àÏ†úÏôÄ Í∏âÏó¨ Ï†ïÏ±Ö + ÌôïÏû• Í∏∞Îä•ÏùÑ ÏßÄÏõêÌïòÎäî database_schema_v3.sqlÏùÑ ÏôÑÏ†ÑÌûà Ï†ÅÏö©Ìï©ÎãàÎã§. MVP Í∏∞Î∞ò + Phase 4-10 ÌôïÏû• Í∏∞Îä•, Row Level Security, Ïã§ÏãúÍ∞Ñ Í∏∞Îä•, ÏûêÎèô Ìä∏Î¶¨Í±∞ÍπåÏßÄ Î™®Îì† Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í∏∞Îä•ÏùÑ ÏôÑÏÑ±Ìï©ÎãàÎã§.

## üéØ Î™©Ï†Å

- Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏôÑÏ†ÑÌïú ÏÑ§Ï†ï Î∞è ÌôòÍ≤Ω Íµ¨ÏÑ±
- database_schema_v3.sql Í∏∞Î∞ò ÏôÑÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà Íµ¨Ï∂ï (MVP + ÌôïÏû•)
- **MVP Í∏∞Î∞ò**: 5Í∞ÄÏßÄ ÏöîÍ∏àÏ†ú ÌÉÄÏûÖÍ≥º 7Í∞ÄÏßÄ Í∏âÏó¨ Ï†ïÏ±Ö ÏôÑÎ≤Ω ÏßÄÏõê
- **ÌôïÏû• Í∏∞Îä•**: ÍµêÏã§, ÏãúÍ∞ÑÌëú, ÏÑ±Ï†Å, Î¨∏ÏÑú, ÌûàÏä§ÌÜ†Î¶¨, ÏÉÅÎã¥ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú
- Row Level Security (RLS) 4-tier Í∂åÌïú ÏãúÏä§ÌÖú Íµ¨ÌòÑ
- Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ Î∞è ÏûêÎèôÌôî Ìä∏Î¶¨Í±∞ ÏÑ§Ï†ï
- AI Í∏∞Î∞ò ÌïôÏäµ Î∂ÑÏÑùÏùÑ ÏúÑÌïú Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Ï§ÄÎπÑ
- TypeScript ÌÉÄÏûÖ ÏûêÎèô ÏÉùÏÑ± ÌôòÍ≤Ω Íµ¨Ï∂ï

## üèóÔ∏è Íµ¨ÌòÑ Ìï≠Î™©

### 1. Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î∞è Í∏∞Î≥∏ ÏÑ§Ï†ï

- [ ] Supabase Í≥ÑÏ†ï ÏÉùÏÑ± Î∞è ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
- [ ] ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï ÏµúÏ†ÅÌôî (ÏßÄÏó≠: ÏïÑÏãúÏïÑ-ÌÉúÌèâÏñë ÏÑ†ÌÉù)
- [ ] Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏïàÏ†ÑÌïú ÏÑ§Ï†ï
- [ ] API ÌÇ§ Î∞è Ïó∞Í≤∞ Ï†ïÎ≥¥ ÌôïÏù∏

### 2. Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤Ω ÏÑ§Ï†ï

```bash
# Supabase CLI ÏÑ§Ïπò
npm install -g supabase

# ÌîÑÎ°úÏ†ùÌä∏ Ï¥àÍ∏∞Ìôî
supabase init

# Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤Ω ÏãúÏûë
supabase start

# ÏõêÍ≤© ÌîÑÎ°úÏ†ùÌä∏ Ïó∞Í≤∞
supabase link --project-ref [PROJECT_ID]
```

### 3. database_schema_v2.sql ÏôÑÏ†Ñ Ï†ÅÏö©

#### 3.1 Ïó¥Í±∞Ìòï ÌÉÄÏûÖ (ENUMs) Ï†ïÏùò
```sql
-- ÌïôÏÉù ÏÉÅÌÉú
CREATE TYPE student_status AS ENUM ('active', 'waiting', 'inactive', 'graduated');

-- ÏÇ¨Ïö©Ïûê Ïó≠Ìï† (4-tier RBAC)
CREATE TYPE user_role AS ENUM ('admin', 'instructor', 'staff', 'viewer');

-- Ï∂úÏÑù ÏÉÅÌÉú  
CREATE TYPE attendance_status AS ENUM ('present', 'late', 'absent', 'excused');

-- Í≤∞Ï†ú ÏÉÅÌÉú
CREATE TYPE payment_status AS ENUM ('pending', 'completed', 'overdue', 'cancelled', 'refunded');

-- Í≤∞Ï†ú Î∞©Î≤ï
CREATE TYPE payment_method AS ENUM ('cash', 'card', 'transfer', 'mobile');

-- 5Í∞ÄÏßÄ ÏàòÍ∞ïÍ∂å Ï≤≠Íµ¨ Ïú†Ìòï
CREATE TYPE billing_type AS ENUM (
    'monthly',      -- Ïõî Ï†ïÏï°Ï†ú
    'sessions',     -- ÌöåÏ∞®Ï†ú (10ÌöåÍ∂å, 20ÌöåÍ∂å)
    'hours',        -- ÏãúÍ∞ÑÏ†ú
    'package',      -- Ìå®ÌÇ§ÏßÄ (3Í∞úÏõî, 6Í∞úÏõî)
    'drop_in'       -- ÎìúÎ°≠Ïù∏ (Îß§Ìöå Í≤∞Ï†ú)
);

-- Ìï†Ïù∏ Ïú†Ìòï
CREATE TYPE discount_type AS ENUM (
    'sibling',          -- ÌòïÏ†ú Ìï†Ïù∏
    'early_payment',    -- Ï°∞Í∏∞ ÎÇ©Î∂Ä Ìï†Ïù∏
    'loyalty',          -- Ïû•Í∏∞ ÏàòÍ∞ï Ìï†Ïù∏
    'scholarship',      -- Ïû•ÌïôÍ∏à
    'promotion',        -- ÌîÑÎ°úÎ™®ÏÖò
    'volume'           -- Îã§Í≥ºÎ™© Ìï†Ïù∏
);

-- 7Í∞ÄÏßÄ Í∏âÏó¨ Ï†ïÏ±Ö Ïú†Ìòï
CREATE TYPE salary_policy_type AS ENUM (
    'fixed_monthly',     -- Í≥†Ï†ï ÏõîÍ∏â
    'fixed_hourly',      -- Í≥†Ï†ï ÏãúÍ∏â  
    'commission',        -- Îã®Ïàú ÎπÑÏú®Ï†ú
    'tiered_commission', -- ÎàÑÏßÑ ÎπÑÏú®Ï†ú
    'student_based',     -- ÌïôÏÉù Ïàò Í∏∞Ï§Ä
    'performance_based', -- ÏÑ±Í≥ºÍ∏â
    'hybrid'            -- Î≥µÌï©Ìòï (Í∏∞Î≥∏Í∏â + ÏÑ±Í≥ºÍ∏â)
);
```

#### 3.2 ÌïµÏã¨ ÌÖåÏù¥Î∏î ÏÉùÏÑ±

**ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨**
```sql
-- ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ (Supabase Auth ÌôïÏû•)
CREATE TABLE user_profiles (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    role user_role NOT NULL DEFAULT 'viewer',
    phone TEXT,
    avatar_url TEXT,
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**ÌïôÏÉù Í¥ÄÎ¶¨**
```sql
-- ÌïôÏÉù Ï†ïÎ≥¥
CREATE TABLE students (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_number TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    name_english TEXT,
    birth_date DATE,
    gender TEXT CHECK (gender IN ('male', 'female')),
    phone TEXT,
    email TEXT,
    address TEXT,
    school TEXT,
    grade TEXT,
    status student_status DEFAULT 'active',
    notes TEXT,
    emergency_contact JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ÌïôÎ∂ÄÎ™® Ï†ïÎ≥¥
CREATE TABLE guardians (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    relationship TEXT NOT NULL,
    phone TEXT NOT NULL,
    email TEXT,
    is_primary BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**ÌÅ¥ÎûòÏä§ Î∞è Í∞ïÏÇ¨ Í¥ÄÎ¶¨**
```sql
-- ÌÅ¥ÎûòÏä§ Ï†ïÎ≥¥
CREATE TABLE classes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    subject TEXT,
    level TEXT,
    max_students INTEGER DEFAULT 20,
    instructor_id UUID REFERENCES user_profiles(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Í∏âÏó¨ Ï†ïÏ±Ö
CREATE TABLE salary_policies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    instructor_id UUID REFERENCES user_profiles(id),
    policy_type salary_policy_type NOT NULL,
    base_amount DECIMAL(10,2) DEFAULT 0,
    rate DECIMAL(5,4) DEFAULT 0,
    tier_config JSONB,
    effective_from DATE NOT NULL,
    effective_to DATE,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**ÏàòÍ∞ïÍ∂å Î∞è Í≤∞Ï†ú ÏãúÏä§ÌÖú**
```sql
-- ÏàòÍ∞ïÍ∂å Ìå®ÌÇ§ÏßÄ (5Í∞ÄÏßÄ ÏöîÍ∏àÏ†ú ÏßÄÏõê)
CREATE TABLE course_packages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    class_id UUID REFERENCES classes(id),
    name TEXT NOT NULL,
    billing_type billing_type NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    sessions INTEGER DEFAULT 0,
    hours DECIMAL(4,1) DEFAULT 0,
    months INTEGER DEFAULT 0,
    validity_months INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- Ï≤≠Íµ¨ ÌÉÄÏûÖÎ≥Ñ ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
    CONSTRAINT valid_billing_config CHECK (
        CASE billing_type
            WHEN 'sessions' THEN sessions > 0
            WHEN 'hours' THEN hours > 0
            WHEN 'package' THEN months > 0
            ELSE true
        END
    )
);

-- Ìï†Ïù∏ Ï†ïÏ±Ö
CREATE TABLE discount_policies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    discount_type discount_type NOT NULL,
    discount_rate DECIMAL(5,4) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    min_students INTEGER DEFAULT 1,
    max_students INTEGER,
    conditions JSONB,
    is_active BOOLEAN DEFAULT true,
    valid_from DATE NOT NULL,
    valid_to DATE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ÌïôÏÉù ÏàòÍ∞ïÍ∂å Îì±Î°ù
CREATE TABLE student_enrollments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    class_id UUID REFERENCES classes(id),
    package_id UUID REFERENCES course_packages(id),
    
    -- Îì±Î°ù Ï†ïÎ≥¥
    enrolled_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMPTZ,
    
    -- ÏÇ¨Ïö©Îüâ Ï∂îÏ†Å
    sessions_total INTEGER DEFAULT 0,
    sessions_used INTEGER DEFAULT 0,
    hours_total DECIMAL(4,1) DEFAULT 0,
    hours_used DECIMAL(4,1) DEFAULT 0,
    
    -- ÏÉÅÌÉú Í¥ÄÎ¶¨
    is_active BOOLEAN DEFAULT true,
    position_in_class INTEGER DEFAULT 0,
    
    -- Í≤∞Ï†ú Ï†ïÎ≥¥
    original_price DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    final_price DECIMAL(10,2) NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- ClassFlowÎ•º ÏúÑÌïú Ïú†ÎãàÌÅ¨ Ï†úÏïΩ
    UNIQUE(class_id, position_in_class)
);

-- Í≤∞Ï†ú Í∏∞Î°ù
CREATE TABLE payments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    enrollment_id UUID REFERENCES student_enrollments(id),
    amount DECIMAL(10,2) NOT NULL,
    method payment_method NOT NULL,
    status payment_status DEFAULT 'pending',
    due_date DATE,
    paid_at TIMESTAMPTZ,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**Ï∂úÏÑù Í¥ÄÎ¶¨**
```sql
-- Ï∂úÏÑù Í∏∞Î°ù
CREATE TABLE attendances (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    class_id UUID REFERENCES classes(id),
    enrollment_id UUID REFERENCES student_enrollments(id),
    
    attendance_date DATE NOT NULL,
    status attendance_status DEFAULT 'present',
    check_in_time TIMESTAMPTZ,
    check_out_time TIMESTAMPTZ,
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- Ï§ëÎ≥µ Ï∂úÏÑù Î∞©ÏßÄ
    UNIQUE(student_id, class_id, attendance_date)
);
```

### 4. Row Level Security (RLS) Ï†ïÏ±Ö Íµ¨ÌòÑ

#### 4.1 RLS ÌôúÏÑ±Ìôî
```sql
-- Î™®Îì† ÌÖåÏù¥Î∏îÏóêÏÑú RLS ÌôúÏÑ±Ìôî
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE guardians ENABLE ROW LEVEL SECURITY;
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE salary_policies ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_packages ENABLE ROW LEVEL SECURITY;
ALTER TABLE discount_policies ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendances ENABLE ROW LEVEL SECURITY;
```

#### 4.2 4-tier Í∂åÌïúÎ≥Ñ Ï†ïÏ±Ö Ï†ïÏùò

**Admin Í∂åÌïú (Î™®Îì† Ï†ëÍ∑º)**
```sql
-- AdminÏùÄ Î™®Îì† ÌÖåÏù¥Î∏î Ï†ëÍ∑º Í∞ÄÎä•
CREATE POLICY "Admin full access" ON students
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role = 'admin'
        )
    );

-- Îã§Î•∏ ÌÖåÏù¥Î∏îÎì§ÎèÑ ÎèôÏùºÌïú Ìå®ÌÑ¥ÏúºÎ°ú Ï†ÅÏö©
CREATE POLICY "Admin full access" ON classes
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role = 'admin'
        )
    );
```

**Instructor Í∂åÌïú (Îã¥Îãπ ÌÅ¥ÎûòÏä§Îßå)**
```sql
-- Í∞ïÏÇ¨Îäî ÏûêÏã†Ïù¥ Îã¥ÎãπÌïòÎäî ÌÅ¥ÎûòÏä§Ïùò ÌïôÏÉùÎßå Ï°∞Ìöå
CREATE POLICY "Instructor class students" ON students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM user_profiles up
            JOIN classes c ON c.instructor_id = up.id
            JOIN student_enrollments se ON se.class_id = c.id AND se.student_id = students.id
            WHERE up.id = auth.uid() AND up.role = 'instructor'
        )
    );

-- ÏûêÏã†Ïùò Í∏âÏó¨ Ï†ïÏ±ÖÎßå Ï°∞Ìöå
CREATE POLICY "Instructor own salary" ON salary_policies
    FOR SELECT USING (
        instructor_id = auth.uid() AND 
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('instructor', 'admin')
        )
    );
```

**Staff Í∂åÌïú (Ï†úÌïúÎêú ÏùΩÍ∏∞/Ïì∞Í∏∞)**
```sql
-- Ïä§ÌÉúÌîÑÎäî ÌïôÏÉù Ï†ïÎ≥¥ ÏùΩÍ∏∞/ÏàòÏ†ï Í∞ÄÎä• (ÏÇ≠Ï†ú Î∂àÍ∞Ä)
CREATE POLICY "Staff student access" ON students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('staff', 'admin')
        )
    );

CREATE POLICY "Staff student update" ON students
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('staff', 'admin')
        )
    );
```

**Viewer Í∂åÌïú (ÏùΩÍ∏∞Îßå)**
```sql
-- Î∑∞Ïñ¥Îäî Í∏∞Î≥∏ Ï†ïÎ≥¥Îßå ÏùΩÍ∏∞ Í∞ÄÎä•
CREATE POLICY "Viewer basic read" ON students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('viewer', 'staff', 'instructor', 'admin')
        )
    );
```

### 5. Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ ÏÑ§Ï†ï

```sql
-- ClassFlowÎ•º ÏúÑÌïú Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ ÌôúÏÑ±Ìôî
ALTER PUBLICATION supabase_realtime ADD TABLE student_enrollments;
ALTER PUBLICATION supabase_realtime ADD TABLE attendances;
ALTER PUBLICATION supabase_realtime ADD TABLE students;
ALTER PUBLICATION supabase_realtime ADD TABLE classes;
```

### 6. ÏûêÎèôÌôî Ìä∏Î¶¨Í±∞ Íµ¨ÌòÑ

#### 6.1 ÏÇ¨Ïö©Îüâ ÏûêÎèô Ï∞®Í∞ê Ìä∏Î¶¨Í±∞
```sql
-- Ï∂úÏÑù Ïãú ÏÇ¨Ïö©Îüâ ÏûêÎèô Ï∞®Í∞ê
CREATE OR REPLACE FUNCTION update_enrollment_usage()
RETURNS TRIGGER AS $$
BEGIN
    -- Ï∂úÏÑù Ï≤¥ÌÅ¨ Ïãú ÏÇ¨Ïö©Îüâ Ï∞®Í∞ê
    IF NEW.status = 'present' THEN
        UPDATE student_enrollments 
        SET 
            sessions_used = sessions_used + 1,
            hours_used = hours_used + 1.0,  -- Í∏∞Î≥∏ 1ÏãúÍ∞Ñ Ï∞®Í∞ê
            updated_at = CURRENT_TIMESTAMP
        WHERE id = NEW.enrollment_id;
        
        -- ÏÇ¨Ïö©Îüâ Ï¥àÍ≥º Ïãú ÏïåÎ¶º (ÎÇòÏ§ëÏóê ÌôïÏû• Í∞ÄÎä•)
        -- ÌòÑÏû¨Îäî Í∏∞Î≥∏ Ï∞®Í∞êÎßå Íµ¨ÌòÑ
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER attendance_usage_trigger
    AFTER INSERT OR UPDATE ON attendances
    FOR EACH ROW
    EXECUTE FUNCTION update_enrollment_usage();
```

#### 6.2 ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÍ∞Å ÏûêÎèô Í∞±Ïã†
```sql
-- updated_at ÏûêÎèô Í∞±Ïã† Ìï®Ïàò
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Ï£ºÏöî ÌÖåÏù¥Î∏îÏóê Ìä∏Î¶¨Í±∞ Ï†ÅÏö©
CREATE TRIGGER update_students_updated_at 
    BEFORE UPDATE ON students
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_profiles_updated_at 
    BEFORE UPDATE ON user_profiles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_classes_updated_at 
    BEFORE UPDATE ON classes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_enrollments_updated_at 
    BEFORE UPDATE ON student_enrollments
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 6.3 Í∏âÏó¨ Í≥ÑÏÇ∞ ÏûêÎèôÌôî (Í∏∞Î≥∏ Íµ¨Ï°∞)
```sql
-- Í∏âÏó¨ Í≥ÑÏÇ∞ Ìï®Ïàò (Ìñ•ÌõÑ ÌôïÏû• Í∞ÄÎä•)
CREATE OR REPLACE FUNCTION calculate_instructor_salary(
    instructor_id UUID,
    calculation_month DATE
)
RETURNS DECIMAL(10,2) AS $$
DECLARE
    policy salary_policies%ROWTYPE;
    total_salary DECIMAL(10,2) := 0;
    student_count INTEGER;
    attendance_count INTEGER;
BEGIN
    -- Ìï¥Îãπ ÏõîÏùò ÌôúÏÑ± Í∏âÏó¨ Ï†ïÏ±Ö Ï°∞Ìöå
    SELECT * INTO policy
    FROM salary_policies sp
    WHERE sp.instructor_id = calculate_instructor_salary.instructor_id
      AND sp.is_active = true
      AND sp.effective_from <= calculation_month
      AND (sp.effective_to IS NULL OR sp.effective_to >= calculation_month)
    ORDER BY sp.effective_from DESC
    LIMIT 1;
    
    IF policy.id IS NULL THEN
        RETURN 0;
    END IF;
    
    -- Ï†ïÏ±Ö ÌÉÄÏûÖÎ≥Ñ Í≥ÑÏÇ∞
    CASE policy.policy_type
        WHEN 'fixed_monthly' THEN
            total_salary := policy.base_amount;
            
        WHEN 'fixed_hourly' THEN
            -- Ìï¥Îãπ Ïõî Ï∂úÏÑù ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (Í∏∞Î≥∏ Íµ¨ÌòÑ)
            SELECT COUNT(*) INTO attendance_count
            FROM attendances a
            JOIN classes c ON c.id = a.class_id
            WHERE c.instructor_id = calculate_instructor_salary.instructor_id
              AND DATE_TRUNC('month', a.attendance_date) = DATE_TRUNC('month', calculation_month)
              AND a.status = 'present';
            
            total_salary := attendance_count * policy.base_amount;
            
        WHEN 'student_based' THEN
            -- Ìï¥Îãπ Ïõî ÌèâÍ∑† ÌïôÏÉù Ïàò Í≥ÑÏÇ∞
            SELECT COUNT(DISTINCT se.student_id) INTO student_count
            FROM student_enrollments se
            JOIN classes c ON c.id = se.class_id
            WHERE c.instructor_id = calculate_instructor_salary.instructor_id
              AND se.is_active = true
              AND se.enrolled_at <= (calculation_month + INTERVAL '1 month - 1 day');
            
            total_salary := student_count * policy.base_amount;
            
        ELSE
            -- Îã§Î•∏ Ï†ïÏ±ÖÎì§ÏùÄ Ìñ•ÌõÑ Íµ¨ÌòÑ
            total_salary := policy.base_amount;
    END CASE;
    
    RETURN total_salary;
END;
$$ LANGUAGE plpgsql;
```

### 7. Ïù∏Îç±Ïä§ Î∞è ÏÑ±Îä• ÏµúÏ†ÅÌôî

```sql
-- ÏûêÏ£º ÏÇ¨Ïö©ÎêòÎäî ÏøºÎ¶¨Î•º ÏúÑÌïú Ïù∏Îç±Ïä§
CREATE INDEX idx_students_status ON students(status);
CREATE INDEX idx_students_name ON students(name);
CREATE INDEX idx_students_student_number ON students(student_number);

CREATE INDEX idx_classes_instructor ON classes(instructor_id);
CREATE INDEX idx_classes_active ON classes(is_active);

CREATE INDEX idx_enrollments_student ON student_enrollments(student_id);
CREATE INDEX idx_enrollments_class ON student_enrollments(class_id);
CREATE INDEX idx_enrollments_active ON student_enrollments(is_active);
CREATE INDEX idx_enrollments_position ON student_enrollments(class_id, position_in_class);

CREATE INDEX idx_attendances_date ON attendances(attendance_date);
CREATE INDEX idx_attendances_student_class ON attendances(student_id, class_id);

CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_due_date ON payments(due_date);

-- Î≥µÌï© Ïù∏Îç±Ïä§ (ClassFlow ÏÑ±Îä• ÏµúÏ†ÅÌôî)
CREATE INDEX idx_enrollments_class_position_active ON student_enrollments(class_id, position_in_class, is_active);
```

### 8. Î∑∞ Î∞è Ìï®Ïàò ÏÉùÏÑ±

```sql
-- ClassFlowÎ•º ÏúÑÌïú Î∑∞ (ÌïôÏÉù-ÌÅ¥ÎûòÏä§ Í¥ÄÍ≥Ñ)
CREATE VIEW student_class_view AS
SELECT 
    s.id as student_id,
    s.name as student_name,
    s.student_number,
    s.status as student_status,
    c.id as class_id,
    c.name as class_name,
    se.position_in_class,
    se.enrolled_at,
    se.expires_at,
    se.sessions_total,
    se.sessions_used,
    se.hours_total,
    se.hours_used,
    se.is_active as enrollment_active,
    up.name as instructor_name
FROM students s
JOIN student_enrollments se ON se.student_id = s.id
JOIN classes c ON c.id = se.class_id
LEFT JOIN user_profiles up ON up.id = c.instructor_id
WHERE se.is_active = true
ORDER BY c.name, se.position_in_class;

-- ÌÜµÍ≥ÑÎ•º ÏúÑÌïú Î∑∞
CREATE VIEW enrollment_stats AS
SELECT 
    c.id as class_id,
    c.name as class_name,
    COUNT(se.student_id) as total_students,
    COUNT(se.student_id) FILTER (WHERE s.status = 'active') as active_students,
    c.max_students,
    c.max_students - COUNT(se.student_id) as available_slots
FROM classes c
LEFT JOIN student_enrollments se ON se.class_id = c.id AND se.is_active = true
LEFT JOIN students s ON s.id = se.student_id
WHERE c.is_active = true
GROUP BY c.id, c.name, c.max_students;
```

### 9. ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ

```sql
-- Í∏∞Î≥∏ Í¥ÄÎ¶¨Ïûê ÏÇ¨Ïö©Ïûê (Ïã§Ï†ú auth.usersÏôÄ Ïó∞Îèô ÌïÑÏöî)
INSERT INTO user_profiles (id, email, name, role) VALUES
('00000000-0000-0000-0000-000000000001', 'admin@educanvas.com', 'ÏãúÏä§ÌÖú Í¥ÄÎ¶¨Ïûê', 'admin'),
('00000000-0000-0000-0000-000000000002', 'instructor1@educanvas.com', 'ÍπÄÏÑ†ÏÉùÎãò', 'instructor'),
('00000000-0000-0000-0000-000000000003', 'staff1@educanvas.com', 'Î∞ïÏßÅÏõê', 'staff');

-- ÏÉòÌîå ÌÅ¥ÎûòÏä§
INSERT INTO classes (id, name, subject, level, max_students, instructor_id) VALUES
('10000000-0000-0000-0000-000000000001', 'ÏàòÌïô Ï§ëÍ∏âÎ∞ò', 'ÏàòÌïô', 'Ï§ëÍ∏â', 15, '00000000-0000-0000-0000-000000000002'),
('10000000-0000-0000-0000-000000000002', 'ÏòÅÏñ¥ Í≥†Í∏âÎ∞ò', 'ÏòÅÏñ¥', 'Í≥†Í∏â', 12, '00000000-0000-0000-0000-000000000002'),
('10000000-0000-0000-0000-000000000003', 'Í≥ºÌïô Ï¥àÍ∏âÎ∞ò', 'Í≥ºÌïô', 'Ï¥àÍ∏â', 20, '00000000-0000-0000-0000-000000000002');

-- ÏÉòÌîå ÏàòÍ∞ïÍ∂å Ìå®ÌÇ§ÏßÄ
INSERT INTO course_packages (class_id, name, billing_type, price, sessions, months) VALUES
('10000000-0000-0000-0000-000000000001', 'ÏàòÌïô ÏõîÏ†ïÏï°', 'monthly', 150000, 0, 1),
('10000000-0000-0000-0000-000000000001', 'ÏàòÌïô 10ÌöåÍ∂å', 'sessions', 200000, 10, 0),
('10000000-0000-0000-0000-000000000002', 'ÏòÅÏñ¥ 3Í∞úÏõî Ìå®ÌÇ§ÏßÄ', 'package', 400000, 0, 3),
('10000000-0000-0000-0000-000000000003', 'Í≥ºÌïô ÏãúÍ∞ÑÏ†ú', 'hours', 20000, 0, 0);

-- ÏÉòÌîå ÌïôÏÉù (5Î™Ö)
INSERT INTO students (id, student_number, name, birth_date, phone, status) VALUES
('20000000-0000-0000-0000-000000000001', 'ST001', 'Ïù¥ÎØºÏ§Ä', '2010-03-15', '010-1111-1111', 'active'),
('20000000-0000-0000-0000-000000000002', 'ST002', 'ÍπÄÏÑúÏó∞', '2011-07-22', '010-2222-2222', 'active'),
('20000000-0000-0000-0000-000000000003', 'ST003', 'Î∞ïÏßÄÌò∏', '2010-11-08', '010-3333-3333', 'active'),
('20000000-0000-0000-0000-000000000004', 'ST004', 'ÏµúÏú†ÏßÑ', '2009-05-30', '010-4444-4444', 'active'),
('20000000-0000-0000-0000-000000000005', 'ST005', 'Ï†ïÌòÑÏö∞', '2010-12-03', '010-5555-5555', 'waiting');

-- ÏÉòÌîå ÏàòÍ∞ï Îì±Î°ù (ClassFlow ÌÖåÏä§Ìä∏Ïö©)
INSERT INTO student_enrollments (student_id, class_id, package_id, position_in_class, sessions_total, original_price, final_price) VALUES
('20000000-0000-0000-0000-000000000001', '10000000-0000-0000-0000-000000000001', (SELECT id FROM course_packages WHERE name = 'ÏàòÌïô ÏõîÏ†ïÏï°'), 1, 0, 150000, 150000),
('20000000-0000-0000-0000-000000000002', '10000000-0000-0000-0000-000000000001', (SELECT id FROM course_packages WHERE name = 'ÏàòÌïô 10ÌöåÍ∂å'), 2, 10, 200000, 200000),
('20000000-0000-0000-0000-000000000003', '10000000-0000-0000-0000-000000000002', (SELECT id FROM course_packages WHERE name = 'ÏòÅÏñ¥ 3Í∞úÏõî Ìå®ÌÇ§ÏßÄ'), 1, 0, 400000, 400000);
```

## ‚úÖ ÏôÑÎ£å Í∏∞Ï§Ä (Acceptance Criteria)

### ÌïÑÏàò Ï°∞Í±¥
- [ ] Supabase ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î∞è Ïó∞Í≤∞ ÏôÑÎ£å
- [ ] database_schema_v2.sqlÏùò Î™®Îì† ÌÖåÏù¥Î∏î, ÌÉÄÏûÖ, Ìï®Ïàò Ï†ïÏÉÅ ÏÉùÏÑ±
- [ ] 5Í∞ÄÏßÄ ÏöîÍ∏àÏ†ú ÌÉÄÏûÖ Î™®Îëê Ï†ïÏÉÅ ÎèôÏûë ÌôïÏù∏
- [ ] 4-tier RBAC (admin/instructor/staff/viewer) Í∂åÌïú ÏãúÏä§ÌÖú ÏôÑÎ≤Ω Íµ¨ÌòÑ
- [ ] ClassFlowÎ•º ÏúÑÌïú Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ Í∏∞Îä• ÌôúÏÑ±Ìôî

### Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Ï°∞Í±¥
- [ ] Î™®Îì† Ïô∏ÎûòÌÇ§ Ï†úÏïΩ Ï°∞Í±¥ Ï†ïÏÉÅ ÎèôÏûë
- [ ] position_in_class Ïú†ÎãàÌÅ¨ Ï†úÏïΩ Ï°∞Í±¥ (ÎèôÏùº ÌÅ¥ÎûòÏä§ ÎÇ¥ Ï§ëÎ≥µ Î∞©ÏßÄ)
- [ ] ÏÇ¨Ïö©Îüâ Ï∂îÏ†Å Î°úÏßÅ Ï†ïÌôïÏÑ± (sessions_used, hours_used)
- [ ] ÏöîÍ∏àÏ†úÎ≥Ñ ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù (billing_type CHECK Ï†úÏïΩ)

### ÏÑ±Îä• Ï°∞Í±¥
- [ ] ÌïÑÏàò Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏôÑÎ£å (ÌïôÏÉù Ï°∞Ìöå, ÌÅ¥ÎûòÏä§Î≥Ñ Ï°∞Ìöå Îì±)
- [ ] 1000Î™Ö ÌïôÏÉù Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ Ïãú ÏùëÎãµ ÏãúÍ∞Ñ < 5Ï¥à
- [ ] ClassFlow ÌïôÏÉù Ïù¥Îèô ÏøºÎ¶¨ ÏùëÎãµ ÏãúÍ∞Ñ < 100ms

### Î≥¥Ïïà Ï°∞Í±¥
- [ ] Î™®Îì† ÌÖåÏù¥Î∏î RLS ÌôúÏÑ±Ìôî
- [ ] Í∂åÌïúÎ≥Ñ Ï†ëÍ∑º Ï†úÏñ¥ Ï†ïÌôïÏÑ± 100% (admin/instructor/staff/viewer)
- [ ] API ÌÇ§ Î∞è Ïó∞Í≤∞ Ï†ïÎ≥¥ ÏïàÏ†ÑÌïú ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
- [ ] ÎØºÍ∞ê Ï†ïÎ≥¥ (Í∏âÏó¨ Ï†ïÏ±Ö) Í∂åÌïúÎ≥Ñ Ï†ëÍ∑º Ï†úÌïú

## üß™ ÌÖåÏä§Ìä∏ ÏºÄÏù¥Ïä§

### 1. Ïä§ÌÇ§Îßà ÏÉùÏÑ± ÌÖåÏä§Ìä∏
```sql
-- Î™®Îì† ÌÖåÏù¥Î∏î Ï°¥Ïû¨ ÌôïÏù∏
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- Î™®Îì† Ïó¥Í±∞Ìòï ÌÉÄÏûÖ ÌôïÏù∏
SELECT typname FROM pg_type WHERE typtype = 'e' ORDER BY typname;

-- Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÌôïÏù∏
SELECT indexname FROM pg_indexes WHERE schemaname = 'public' ORDER BY indexname;
```

### 2. Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ ÌÖåÏä§Ìä∏
```sql
-- 5Í∞ÄÏßÄ ÏöîÍ∏àÏ†ú ÌÉÄÏûÖ ÌÖåÏä§Ìä∏
INSERT INTO course_packages (name, billing_type, price, sessions, hours, months) VALUES
('ÌÖåÏä§Ìä∏ ÏõîÏ†ïÏï°', 'monthly', 100000, 0, 0, 1),
('ÌÖåÏä§Ìä∏ 10ÌöåÍ∂å', 'sessions', 150000, 10, 0, 0),
('ÌÖåÏä§Ìä∏ ÏãúÍ∞ÑÏ†ú', 'hours', 25000, 0, 1.0, 0),
('ÌÖåÏä§Ìä∏ 3Í∞úÏõî Ìå®ÌÇ§ÏßÄ', 'package', 300000, 0, 0, 3),
('ÌÖåÏä§Ìä∏ ÎìúÎ°≠Ïù∏', 'drop_in', 20000, 1, 0, 0);

-- CHECK Ï†úÏïΩ Ï°∞Í±¥ ÌÖåÏä§Ìä∏ (Ïã§Ìå®Ìï¥Ïïº Ìï®)
INSERT INTO course_packages (name, billing_type, price, sessions) VALUES
('ÏûòÎ™ªÎêú ÌöåÏ∞®Ï†ú', 'sessions', 100000, 0); -- sessions > 0 Ï°∞Í±¥ ÏúÑÎ∞ò
```

### 3. RLS Í∂åÌïú ÌÖåÏä§Ìä∏
```sql
-- Admin Í∂åÌïú ÌÖåÏä§Ìä∏ (Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º Í∞ÄÎä•)
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claims.sub TO '00000000-0000-0000-0000-000000000001';
SELECT COUNT(*) FROM students; -- Î™®Îì† ÌïôÏÉù Ï°∞Ìöå Í∞ÄÎä•

-- Instructor Í∂åÌïú ÌÖåÏä§Ìä∏ (Îã¥Îãπ ÌÅ¥ÎûòÏä§Îßå Ï†ëÍ∑º)
SET LOCAL request.jwt.claims.sub TO '00000000-0000-0000-0000-000000000002';
SELECT COUNT(*) FROM students; -- Îã¥Îãπ ÌÅ¥ÎûòÏä§ ÌïôÏÉùÎßå Ï°∞Ìöå

-- Viewer Í∂åÌïú ÌÖåÏä§Ìä∏ (ÏùΩÍ∏∞Îßå Í∞ÄÎä•)
SET LOCAL request.jwt.claims.sub TO '00000000-0000-0000-0000-000000000004';
INSERT INTO students (name, student_number) VALUES ('ÌÖåÏä§Ìä∏', 'TEST001'); -- Ïã§Ìå®Ìï¥Ïïº Ìï®
```

### 4. ClassFlow Ïã§ÏãúÍ∞Ñ Í∏∞Îä• ÌÖåÏä§Ìä∏
```typescript
// ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ ÌÖåÏä§Ìä∏
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const subscription = supabase
  .channel('student_enrollments')
  .on('postgres_changes', 
    { event: 'UPDATE', schema: 'public', table: 'student_enrollments' },
    (payload) => {
      console.log('ÌïôÏÉù Ïù¥Îèô Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏:', payload);
    }
  )
  .subscribe();
```

### 5. ÏÑ±Îä• ÌÖåÏä§Ìä∏
```sql
-- ÎåÄÎüâ Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ ÌÖåÏä§Ìä∏
INSERT INTO students (student_number, name, status)
SELECT 
  'BULK' || generate_series(1, 1000),
  'Test Student ' || generate_series(1, 1000),
  'active'
FROM generate_series(1, 1000);

-- Ïù∏Îç±Ïä§ ÏÑ±Îä• ÌÖåÏä§Ìä∏
EXPLAIN ANALYZE SELECT * FROM students WHERE status = 'active';
EXPLAIN ANALYZE SELECT * FROM student_enrollments WHERE class_id = '10000000-0000-0000-0000-000000000001';
```

### 6. ÏûêÎèôÌôî Ìä∏Î¶¨Í±∞ ÌÖåÏä§Ìä∏
```sql
-- Ï∂úÏÑù Ï≤¥ÌÅ¨ Ïãú ÏÇ¨Ïö©Îüâ ÏûêÎèô Ï∞®Í∞ê ÌÖåÏä§Ìä∏
INSERT INTO attendances (student_id, class_id, enrollment_id, attendance_date, status)
VALUES (
  '20000000-0000-0000-0000-000000000002',
  '10000000-0000-0000-0000-000000000001',
  (SELECT id FROM student_enrollments WHERE student_id = '20000000-0000-0000-0000-000000000002'),
  CURRENT_DATE,
  'present'
);

-- ÏÇ¨Ïö©Îüâ Ï∞®Í∞ê ÌôïÏù∏
SELECT sessions_used, hours_used FROM student_enrollments 
WHERE student_id = '20000000-0000-0000-0000-000000000002';
```

## üìÅ ÌååÏùº Íµ¨Ï°∞

```
EduCanvas/
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îú‚îÄ‚îÄ config.toml              # Supabase Î°úÏª¨ ÏÑ§Ï†ï
‚îÇ   ‚îú‚îÄ‚îÄ migrations/              # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 20250812000001_initial_schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ functions/               # Edge Functions (Ìñ•ÌõÑ)
‚îÇ   ‚îî‚îÄ‚îÄ seed.sql                 # ÏÉòÌîå Îç∞Ïù¥ÌÑ∞
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ client.ts        # Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ server.ts        # ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ types.ts         # ÏûêÎèô ÏÉùÏÑ±Îêú ÌÉÄÏûÖ
‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ       ‚îî‚îÄ‚îÄ database.ts          # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÉÄÏûÖ
‚îú‚îÄ‚îÄ .env.local                   # ÌôòÍ≤Ω Î≥ÄÏàò (Î°úÏª¨)
‚îî‚îÄ‚îÄ .env.example                 # ÌôòÍ≤Ω Î≥ÄÏàò ÌÖúÌîåÎ¶ø
```

## üíª ÌïµÏã¨ Íµ¨ÌòÑ ÏΩîÎìú

### 1. ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (.env.local)
```bash
# Supabase ÏÑ§Ï†ï
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Î°úÏª¨ Í∞úÎ∞úÏö© (supabase start ÌõÑ Ï†úÍ≥µÎêòÎäî URL)
# NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
# NEXT_PUBLIC_SUPABASE_ANON_KEY=your-local-anon-key
```

### 2. Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÑ§Ï†ï
```typescript
// src/lib/supabase/client.ts
import { createBrowserSupabaseClient } from '@supabase/auth-helpers-nextjs'
import { Database } from '@/types/database'

export const supabase = createBrowserSupabaseClient<Database>()

// src/lib/supabase/server.ts
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { Database } from '@/types/database'

export const createServerSupabaseClient = () => {
  return createServerSupabaseClient<Database>({
    headers: headers(),
    cookies: cookies(),
  })
}
```

### 3. TypeScript ÌÉÄÏûÖ ÏûêÎèô ÏÉùÏÑ±
```bash
# ÌÉÄÏûÖ ÏÉùÏÑ± Î™ÖÎ†π
supabase gen types typescript --project-id YOUR_PROJECT_ID --schema public > src/types/database.ts

# package.jsonÏóê Ïä§ÌÅ¨Î¶ΩÌä∏ Ï∂îÍ∞Ä
{
  "scripts": {
    "types:generate": "supabase gen types typescript --local > src/types/database.ts"
  }
}
```

### 4. ClassFlowÎ•º ÏúÑÌïú ÏøºÎ¶¨ Ìï®Ïàò
```typescript
// src/lib/supabase/queries.ts
import { supabase } from './client'
import { Database } from '@/types/database'

type StudentEnrollment = Database['public']['Tables']['student_enrollments']['Row']

// ClassFlow ÌïôÏÉù Î™©Î°ù Ï°∞Ìöå
export async function getStudentsByClass(classId: string) {
  const { data, error } = await supabase
    .from('student_class_view')
    .select('*')
    .eq('class_id', classId)
    .eq('enrollment_active', true)
    .order('position_in_class')
  
  if (error) throw error
  return data
}

// ÌïôÏÉù ÌÅ¥ÎûòÏä§ Ïù¥Îèô
export async function moveStudentToClass(
  studentId: string, 
  targetClassId: string, 
  position: number
) {
  // Ìä∏ÎûúÏû≠ÏÖòÏúºÎ°ú ÏïàÏ†ÑÌïòÍ≤å Ïù¥Îèô
  const { data, error } = await supabase.rpc('move_student_to_class', {
    p_student_id: studentId,
    p_target_class_id: targetClassId,
    p_position: position
  })
  
  if (error) throw error
  return data
}

// Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ ÏÑ§Ï†ï
export function subscribeToClassChanges(
  classId: string, 
  callback: (payload: any) => void
) {
  return supabase
    .channel(`class-${classId}`)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'student_enrollments',
      filter: `class_id=eq.${classId}`
    }, callback)
    .subscribe()
}
```

### 5. ÌïôÏÉù Ïù¥ÎèôÏùÑ ÏúÑÌïú PostgreSQL Ìï®Ïàò
```sql
-- ÌïôÏÉù ÏïàÏ†ÑÌïú ÌÅ¥ÎûòÏä§ Ïù¥Îèô Ìï®Ïàò
CREATE OR REPLACE FUNCTION move_student_to_class(
    p_student_id UUID,
    p_target_class_id UUID,
    p_position INTEGER
)
RETURNS JSON AS $$
DECLARE
    current_enrollment student_enrollments%ROWTYPE;
    max_students INTEGER;
    current_student_count INTEGER;
    result JSON;
BEGIN
    -- ÌòÑÏû¨ Îì±Î°ù Ï†ïÎ≥¥ Ï°∞Ìöå
    SELECT * INTO current_enrollment
    FROM student_enrollments
    WHERE student_id = p_student_id AND is_active = true;
    
    IF current_enrollment.id IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'Student not found or not enrolled');
    END IF;
    
    -- ÎåÄÏÉÅ ÌÅ¥ÎûòÏä§ Ï†ïÏõê Î∞è ÌòÑÏû¨ Ïù∏Ïõê ÌôïÏù∏
    SELECT c.max_students, COUNT(se.student_id)
    INTO max_students, current_student_count
    FROM classes c
    LEFT JOIN student_enrollments se ON se.class_id = c.id AND se.is_active = true
    WHERE c.id = p_target_class_id
    GROUP BY c.id, c.max_students;
    
    -- Ï†ïÏõê Ï¥àÍ≥º ÌôïÏù∏
    IF current_student_count >= max_students THEN
        RETURN json_build_object('success', false, 'error', 'Target class is full');
    END IF;
    
    -- ÏúÑÏπò Ï°∞Ï†ï (Í∏∞Ï°¥ ÌïôÏÉùÎì§Ïùò position Ïû¨Ï†ïÎ†¨)
    UPDATE student_enrollments 
    SET position_in_class = position_in_class + 1
    WHERE class_id = p_target_class_id 
      AND position_in_class >= p_position 
      AND is_active = true;
    
    -- ÌïôÏÉù Ïù¥Îèô
    UPDATE student_enrollments
    SET 
        class_id = p_target_class_id,
        position_in_class = p_position,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = current_enrollment.id;
    
    -- ÏÑ±Í≥µ ÏùëÎãµ
    SELECT json_build_object(
        'success', true,
        'student_id', p_student_id,
        'new_class_id', p_target_class_id,
        'new_position', p_position
    ) INTO result;
    
    RETURN result;
    
EXCEPTION WHEN OTHERS THEN
    -- ÏóêÎü¨ ÏùëÎãµ
    RETURN json_build_object('success', false, 'error', SQLERRM);
END;
$$ LANGUAGE plpgsql;
```

## üö® ÏúÑÌóò ÏöîÏÜå Î∞è ÏôÑÌôî Î∞©Ïïà

### ÎÜíÏùÄ ÏúÑÌóò
**Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Î¨∏Ï†ú**
- ÏúÑÌóò: Î≥µÏû°Ìïú ÎπÑÏ¶àÎãàÏä§ Î°úÏßÅÏúºÎ°ú Ïù∏Ìïú Îç∞Ïù¥ÌÑ∞ Î∂àÏùºÏπò
- ÏôÑÌôî: Ìä∏ÎûúÏû≠ÏÖò Îã®ÏúÑ Ï≤òÎ¶¨, CHECK Ï†úÏïΩ Ï°∞Í±¥ ÌôúÏö©, Ï≤†Ï†ÄÌïú ÌÖåÏä§Ìä∏

**ÏÑ±Îä• Ï†ÄÌïò**
- ÏúÑÌóò: RLS Ï†ïÏ±ÖÏúºÎ°ú Ïù∏Ìïú ÏøºÎ¶¨ ÏÑ±Îä• Ï†ÄÌïò
- ÏôÑÌôî: Ï†ÅÏ†àÌïú Ïù∏Îç±Ïä§ ÏÉùÏÑ±, ÏøºÎ¶¨ ÏµúÏ†ÅÌôî, ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ

### Ï§ëÍ∞Ñ ÏúÑÌóò
**Supabase Ï†úÏïΩÏÇ¨Ìï≠**
- ÏúÑÌóò: ÎèôÏãú Ï†ëÏÜçÏûê Ïàò, Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÅ¨Í∏∞ Ï†úÌïú
- ÏôÑÌôî: Ï†ÅÏ†àÌïú ÏöîÍ∏àÏ†ú ÏÑ†ÌÉù, Î™®ÎãàÌÑ∞ÎßÅ ÏÑ§Ï†ï

**Î≥µÏû°Ìïú Í∂åÌïú ÏãúÏä§ÌÖú**
- ÏúÑÌóò: RLS Ï†ïÏ±Ö ÏÑ§Ï†ï Ïò§Î•ò
- ÏôÑÌôî: Îã®Í≥ÑÎ≥Ñ ÌÖåÏä§Ìä∏, Í∂åÌïúÎ≥Ñ ÌÖåÏä§Ìä∏ ÏºÄÏù¥Ïä§ ÏûëÏÑ±

## üìö Ï∞∏Í≥† Î¨∏ÏÑú

- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Row Level Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Supabase Realtime](https://supabase.com/docs/guides/realtime)
- [database_design.md](../../docs/database_design.md)

## üîÑ ÌõÑÏÜç ÏûëÏóÖ

Ïù¥ ÌÉúÏä§ÌÅ¨ ÏôÑÎ£å ÌõÑ Ïó∞Í≤∞ÎêòÎäî ÏûëÏóÖÎì§:
- T-004: TypeScript ÌÉÄÏûÖ ÏûêÎèô ÏÉùÏÑ± ÏÑ§Ï†ï
- T-007: Supabase Auth Ïù∏Ï¶ù ÏãúÏä§ÌÖú Íµ¨ÌòÑ
- T-008: RBAC Í∏∞Î≥∏ Íµ¨Ï°∞ Íµ¨ÌòÑ (Ïù¥ÎØ∏ DBÏóê Íµ¨ÌòÑÎê®)
- T-013: ÌïôÏÉù CRUD API ÏóîÎìúÌè¨Ïù∏Ìä∏ Íµ¨ÌòÑ

---

**ÏûëÏÑ±Ïûê**: Backend Dev  
**Í≤ÄÌÜ†Ïûê**: Lead Dev, DBA  
**ÏûëÏÑ±Ïùº**: 2025-08-08  
**ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏**: 2025-08-10 (v3 Ïä§ÌÇ§Îßà ÏóÖÎç∞Ïù¥Ìä∏)  
**Í¥ÄÎ†® Ïä§ÌîÑÎ¶∞Ìä∏**: S1 (ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Î∞ò ÏÑ§Ï†ï)