---
id: T-003
title: Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° database_schema_v4.1 ì ìš©
status: COMPLETED
priority: P0
assignees: [Claude Code]
estimate: 1.5d
actual: 2d (UUID ì˜¤ë¥˜ë¡œ ì¸í•œ ì§€ì—°)
completed: 2025-08-10
dependencies: [T-001, T-002]
labels: [database, setup, infrastructure, multitenant, video, completed]
---

# T-003: Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° database_schema_v4.1 ì ìš©

## ğŸ“‹ ì‘ì—… ê°œìš”

EduCanvas MVPì˜ ë°±ì—”ë“œ ì¸í”„ë¼ì¸ Supabase í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³ , ë©€í‹°í…Œë„ŒíŠ¸ ì•„í‚¤í…ì²˜ì™€ YouTube ê¸°ë°˜ ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œì„ ì§€ì›í•˜ëŠ” database_schema_v4.1ì„ ì™„ì „íˆ ì ìš©í•©ë‹ˆë‹¤. í™•ì¥ì„±ê³¼ ë³´ì•ˆì„±ì„ ê·¹ëŒ€í™”í•œ ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ ë°ì´í„°ë² ì´ìŠ¤ ì¸í”„ë¼ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

## ğŸ¯ ëª©ì 

- **ë©€í‹°í…Œë„ŒíŠ¸ ì•„í‚¤í…ì²˜**: ì—¬ëŸ¬ í•™ì›ì´ ë…ë¦½ì ìœ¼ë¡œ ìš´ì˜ë˜ëŠ” SaaS í”Œë«í¼ êµ¬ì¡°
- **ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ**: YouTube ì—°ë™ ê¸°ë°˜ ì˜¨ë¼ì¸ ê°•ì˜ ë° ì§„ë„ ê´€ë¦¬
- **ìœ ì—°í•œ ê¶Œí•œ ì‹œìŠ¤í…œ**: í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ì—­í•  ë° ì„¸ë°€í•œ ê¶Œí•œ ì œì–´
- **í™•ì¥ ê°€ëŠ¥í•œ ì¸í”„ë¼**: ëŒ€ìš©ëŸ‰ ë°ì´í„°ì™€ ë‹¤ì¤‘ í…Œë„ŒíŠ¸ ì§€ì›
- **ì‹¤ì‹œê°„ í˜‘ì—…**: ClassFlow ë“œë˜ê·¸ì•¤ë“œë¡­ ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
- **ì—”í„°í”„ë¼ì´ì¦ˆ ë³´ì•ˆ**: í…Œë„ŒíŠ¸ ê²©ë¦¬, ë°ì´í„° ì•”í˜¸í™”, ê°ì‚¬ ë¡œê·¸

## ğŸ—ï¸ êµ¬í˜„ í•­ëª©

### 1. Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° ê¸°ë³¸ ì„¤ì •

- [ ] Supabase ê³„ì • ìƒì„± ë° ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
- [ ] í”„ë¡œì íŠ¸ ì„¤ì • ìµœì í™” (ì§€ì—­: ì•„ì‹œì•„-íƒœí‰ì–‘ ì„ íƒ)
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ ì•ˆì „í•œ ì„¤ì •
- [ ] ë©€í‹°í…Œë„ŒíŠ¸ë¥¼ ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€ ì„¤ì •
- [ ] API í‚¤ ë° ì—°ê²° ì •ë³´ í™•ì¸

### 2. ë¡œì»¬ ê°œë°œ í™˜ê²½ ì„¤ì •

```bash
# Supabase CLI ì„¤ì¹˜
npm install -g supabase

# í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
supabase init

# ë¡œì»¬ ê°œë°œ í™˜ê²½ ì‹œì‘
supabase start

# ì›ê²© í”„ë¡œì íŠ¸ ì—°ê²°
supabase link --project-ref [PROJECT_ID]
```

### 3. database_schema_v4.1 ì™„ì „ ì ìš©

#### 3.1 v4.1 ì£¼ìš” íŠ¹ì§•
- **ë©€í‹°í…Œë„ŒíŠ¸ ì•„í‚¤í…ì²˜**: í…Œë„ŒíŠ¸ë³„ ê²©ë¦¬ëœ ë°ì´í„° êµ¬ì¡°
- **YouTube ë™ì˜ìƒ ê°•ì˜**: ì§„ë„ ê´€ë¦¬ ë° ì‹œì²­ ë¶„ì„
- **ìœ ì—°í•œ ê¶Œí•œ ì‹œìŠ¤í…œ**: í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ì—­í• 
- **í™•ì¥ëœ ê¸°ëŠ¥**: êµì‹¤, ì‹œê°„í‘œ, ì„±ì , ìƒë‹´ ê´€ë¦¬

#### 3.2 í•µì‹¬ ENUM íƒ€ì… ì •ì˜

```sql
-- v4.0 ê¸°ì¡´ íƒ€ì… + v4.1 ë™ì˜ìƒ ê´€ë ¨ ì¶”ê°€
CREATE TYPE user_status AS ENUM ('active', 'inactive', 'suspended', 'pending_approval');
CREATE TYPE student_status AS ENUM ('active', 'inactive', 'graduated', 'withdrawn', 'suspended');
CREATE TYPE billing_type AS ENUM ('monthly', 'sessions', 'hours', 'package', 'drop_in');
CREATE TYPE discount_type AS ENUM ('sibling', 'early_payment', 'loyalty', 'scholarship', 'promotion', 'volume');
CREATE TYPE salary_policy_type AS ENUM ('fixed_monthly', 'fixed_hourly', 'commission', 'tiered_commission', 'student_based', 'hybrid', 'guaranteed_minimum');
CREATE TYPE attendance_status AS ENUM ('present', 'absent', 'late', 'excused');
CREATE TYPE payment_status AS ENUM ('pending', 'completed', 'overdue', 'cancelled', 'refunded');

-- v4.1 ìƒˆë¡œìš´ ë™ì˜ìƒ ê´€ë ¨ íƒ€ì…ë“¤
CREATE TYPE video_status AS ENUM ('draft', 'published', 'private', 'archived', 'deleted');
CREATE TYPE video_type AS ENUM ('lecture', 'supplement', 'homework_review', 'exam_review', 'announcement');
CREATE TYPE watch_status AS ENUM ('not_started', 'in_progress', 'completed', 'skipped');
CREATE TYPE video_quality AS ENUM ('240p', '360p', '480p', '720p', '1080p', '1440p', '2160p');
```

#### 3.3 ë©€í‹°í…Œë„ŒíŠ¸ í•µì‹¬ í…Œì´ë¸”

**í…Œë„ŒíŠ¸ ê´€ë¦¬**
```sql
-- í…Œë„ŒíŠ¸ (í•™ì›) ê´€ë¦¬
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(50) UNIQUE NOT NULL,
    domain VARCHAR(100) UNIQUE,
    contact_email VARCHAR(255),
    contact_phone VARCHAR(20),
    address TEXT,
    business_registration VARCHAR(50),
    settings JSONB DEFAULT '{}',
    features JSONB DEFAULT '{}',
    limits JSONB DEFAULT '{}',
    subscription_tier VARCHAR(20) DEFAULT 'basic',
    subscription_status VARCHAR(20) DEFAULT 'active',
    trial_ends_at TIMESTAMP WITH TIME ZONE,
    billing_email VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ìœ ì—°í•œ ì—­í•  ì •ì˜ ì‹œìŠ¤í…œ
CREATE TABLE tenant_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    parent_role_id UUID REFERENCES tenant_roles(id) ON DELETE SET NULL,
    hierarchy_level INTEGER DEFAULT 1,
    base_permissions JSONB DEFAULT '{}',
    is_system_role BOOLEAN DEFAULT false,
    is_assignable BOOLEAN DEFAULT true,
    max_users INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT unique_tenant_role_name UNIQUE(tenant_id, name)
);

-- ì„¸ë°€í•œ ê¶Œí•œ ì •ì˜
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(20) NOT NULL,
    scope VARCHAR(20) NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(30),
    is_system_permission BOOLEAN DEFAULT true,
    requires_approval BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT unique_permission UNIQUE(resource, action, scope)
);
```

**ì‚¬ìš©ì ë° ë©¤ë²„ì‹­ ê´€ë¦¬**
```sql
-- ì‚¬ìš©ì í”„ë¡œí•„ (ë©€í‹°í…Œë„ŒíŠ¸ ì§€ì›)
CREATE TABLE user_profiles (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    avatar_url TEXT,
    preferred_language VARCHAR(10) DEFAULT 'ko',
    timezone VARCHAR(50) DEFAULT 'Asia/Seoul',
    status user_status DEFAULT 'active',
    email_verified BOOLEAN DEFAULT false,
    two_factor_enabled BOOLEAN DEFAULT false,
    last_login_at TIMESTAMP WITH TIME ZONE,
    login_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- í…Œë„ŒíŠ¸ ë©¤ë²„ì‹­
CREATE TABLE tenant_memberships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE,
    role_id UUID REFERENCES tenant_roles(id) ON DELETE RESTRICT,
    status VARCHAR(20) DEFAULT 'active',
    invited_by UUID REFERENCES user_profiles(id),
    invited_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    accepted_at TIMESTAMP WITH TIME ZONE,
    last_accessed_at TIMESTAMP WITH TIME ZONE,
    permissions_override JSONB DEFAULT '{}',
    is_primary_contact BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT unique_tenant_user UNIQUE(tenant_id, user_id)
);
```

#### 3.4 í•™ìƒ ë° í´ë˜ìŠ¤ ê´€ë¦¬ (í…Œë„ŒíŠ¸ë³„ ê²©ë¦¬)

**í•™ìƒ ê´€ë¦¬**
```sql
-- í•™ìƒ ì •ë³´ (í…Œë„ŒíŠ¸ë³„ ê²©ë¦¬)
CREATE TABLE students (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    student_number VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_english VARCHAR(100),
    birth_date DATE,
    gender VARCHAR(10) CHECK (gender IN ('male', 'female', 'other')),
    phone VARCHAR(20),
    email VARCHAR(255),
    address TEXT,
    school_name VARCHAR(100),
    grade_level VARCHAR(20),
    status student_status DEFAULT 'active',
    notes TEXT,
    emergency_contact JSONB,
    custom_fields JSONB DEFAULT '{}',
    tags TEXT[],
    created_by UUID REFERENCES user_profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT unique_tenant_student_number UNIQUE(tenant_id, student_number)
);

-- í´ë˜ìŠ¤ ì •ë³´ (í…Œë„ŒíŠ¸ë³„ ê²©ë¦¬)
CREATE TABLE classes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    subject VARCHAR(100),
    level VARCHAR(50),
    color VARCHAR(7),
    max_students INTEGER DEFAULT 20,
    min_students INTEGER DEFAULT 1,
    instructor_id UUID REFERENCES user_profiles(id),
    classroom_id UUID,
    is_active BOOLEAN DEFAULT true,
    start_date DATE,
    end_date DATE,
    schedule_config JSONB DEFAULT '{}',
    custom_fields JSONB DEFAULT '{}',
    created_by UUID REFERENCES user_profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3.5 YouTube ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ

**ë™ì˜ìƒ ì½˜í…ì¸  ê´€ë¦¬**
```sql
-- ë™ì˜ìƒ ê°•ì˜
CREATE TABLE videos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
    instructor_id UUID REFERENCES user_profiles(id),
    
    -- ê¸°ë³¸ ì •ë³´
    title VARCHAR(500) NOT NULL,
    description TEXT,
    youtube_video_id VARCHAR(20) NOT NULL,
    youtube_url TEXT NOT NULL,
    thumbnail_url TEXT,
    
    -- ë©”íƒ€ë°ì´í„°
    duration_seconds INTEGER,
    video_type video_type NOT NULL DEFAULT 'lecture',
    status video_status DEFAULT 'draft',
    quality video_quality DEFAULT '720p',
    
    -- ì ‘ê·¼ ì œì–´
    is_public BOOLEAN DEFAULT false,
    password_protected BOOLEAN DEFAULT false,
    password_hash TEXT,
    available_from TIMESTAMP WITH TIME ZONE,
    available_until TIMESTAMP WITH TIME ZONE,
    
    -- í•™ìŠµ ê´€ë¦¬
    order_index INTEGER DEFAULT 0,
    prerequisites UUID[] DEFAULT '{}',
    learning_objectives TEXT[],
    tags TEXT[],
    
    -- ë¶„ì„ ë°ì´í„°
    view_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0,
    total_watch_time INTEGER DEFAULT 0,
    
    -- ê´€ë¦¬ ì •ë³´
    created_by UUID REFERENCES user_profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT valid_youtube_id CHECK (LENGTH(youtube_video_id) = 11)
);

-- í•™ìƒ ë™ì˜ìƒ ì‹œì²­ ê¸°ë¡
CREATE TABLE video_watch_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    video_id UUID REFERENCES videos(id) ON DELETE CASCADE,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    enrollment_id UUID,
    
    -- ì‹œì²­ ì •ë³´
    watch_status watch_status DEFAULT 'not_started',
    progress_seconds INTEGER DEFAULT 0,
    completion_percentage DECIMAL(5,2) DEFAULT 0,
    
    -- ì‹œì²­ ì„¸ì…˜
    session_start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_position_time TIMESTAMP WITH TIME ZONE,
    total_watch_time INTEGER DEFAULT 0,
    play_count INTEGER DEFAULT 0,
    
    -- ìƒí˜¸ì‘ìš©
    is_liked BOOLEAN DEFAULT false,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    notes TEXT,
    bookmarks JSONB DEFAULT '[]',
    
    -- í’ˆì§ˆ ë° ê¸°ê¸°
    playback_quality video_quality,
    device_type VARCHAR(50),
    user_agent TEXT,
    ip_address INET,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT unique_student_video UNIQUE(student_id, video_id)
);
```

#### 3.6 í–¥ìƒëœ ìˆ˜ê°• ê´€ë¦¬ ì‹œìŠ¤í…œ

**ìˆ˜ê°•ê¶Œ ë° ê²°ì œ**
```sql
-- ìˆ˜ê°•ê¶Œ íŒ¨í‚¤ì§€ (í…Œë„ŒíŠ¸ë³„)
CREATE TABLE course_packages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    billing_type billing_type NOT NULL,
    
    -- ê°€ê²© ì •ë³´
    price DECIMAL(12,2) NOT NULL,
    original_price DECIMAL(12,2),
    currency VARCHAR(3) DEFAULT 'KRW',
    
    -- ìˆ˜ëŸ‰ ì •ë³´
    sessions INTEGER DEFAULT 0,
    hours DECIMAL(5,1) DEFAULT 0,
    months INTEGER DEFAULT 0,
    validity_days INTEGER DEFAULT 365,
    
    -- ë™ì˜ìƒ ì•¡ì„¸ìŠ¤
    video_access_days INTEGER DEFAULT 0,
    offline_access BOOLEAN DEFAULT false,
    download_allowed BOOLEAN DEFAULT false,
    
    -- ìƒíƒœ ë° ê°€ìš©ì„±
    is_active BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    max_enrollments INTEGER,
    available_from DATE,
    available_until DATE,
    
    -- ë¶€ê°€ ê¸°ëŠ¥
    includes_materials BOOLEAN DEFAULT false,
    includes_certificate BOOLEAN DEFAULT false,
    refund_policy TEXT,
    terms_conditions TEXT,
    
    created_by UUID REFERENCES user_profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- ìˆ˜ê°•ê¶Œ ìœ í˜•ë³„ ê²€ì¦
    CONSTRAINT valid_billing_config CHECK (
        CASE billing_type
            WHEN 'sessions' THEN sessions > 0
            WHEN 'hours' THEN hours > 0
            WHEN 'package' THEN months > 0
            ELSE true
        END
    )
);

-- í•™ìƒ ìˆ˜ê°• ë“±ë¡ (í–¥ìƒëœ)
CREATE TABLE student_enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
    package_id UUID REFERENCES course_packages(id),
    
    -- ë“±ë¡ ì •ë³´
    enrollment_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    start_date DATE,
    end_date DATE,
    expires_at TIMESTAMP WITH TIME ZONE,
    
    -- ì‚¬ìš©ëŸ‰ ì¶”ì 
    sessions_total INTEGER DEFAULT 0,
    sessions_used INTEGER DEFAULT 0,
    sessions_remaining INTEGER DEFAULT 0,
    hours_total DECIMAL(5,1) DEFAULT 0,
    hours_used DECIMAL(5,1) DEFAULT 0,
    hours_remaining DECIMAL(5,1) DEFAULT 0,
    
    -- ë™ì˜ìƒ ì•¡ì„¸ìŠ¤
    video_access_expires_at TIMESTAMP WITH TIME ZONE,
    can_download_videos BOOLEAN DEFAULT false,
    video_watch_count INTEGER DEFAULT 0,
    
    -- ìƒíƒœ ë° ìœ„ì¹˜
    status VARCHAR(20) DEFAULT 'active',
    position_in_class INTEGER DEFAULT 0,
    
    -- ê°€ê²© ì •ë³´
    original_price DECIMAL(12,2) NOT NULL,
    discount_amount DECIMAL(12,2) DEFAULT 0,
    final_price DECIMAL(12,2) NOT NULL,
    payment_plan VARCHAR(50),
    
    -- ì„±ê³¼ ì¶”ì 
    attendance_rate DECIMAL(5,2) DEFAULT 0,
    assignment_completion_rate DECIMAL(5,2) DEFAULT 0,
    average_grade DECIMAL(5,2) DEFAULT 0,
    
    -- ê´€ë¦¬ ì •ë³´
    notes TEXT,
    custom_fields JSONB DEFAULT '{}',
    enrolled_by UUID REFERENCES user_profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- ClassFlowë¥¼ ìœ„í•œ ìœ ë‹ˆí¬ ì œì•½
    CONSTRAINT unique_class_position UNIQUE(class_id, position_in_class)
);
```

### 4. ë©€í‹°í…Œë„ŒíŠ¸ Row Level Security (RLS) êµ¬í˜„

#### 4.1 í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ê²©ë¦¬

```sql
-- ëª¨ë“  í…Œë„ŒíŠ¸ í…Œì´ë¸”ì— RLS í™œì„±í™”
ALTER TABLE tenants ENABLE ROW LEVEL SECURITY;
ALTER TABLE tenant_memberships ENABLE ROW LEVEL SECURITY;
ALTER TABLE tenant_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;
ALTER TABLE video_watch_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_packages ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_enrollments ENABLE ROW LEVEL SECURITY;

-- í…Œë„ŒíŠ¸ ì ‘ê·¼ ê¶Œí•œ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION auth.user_tenant_id()
RETURNS UUID
LANGUAGE SQL
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT COALESCE(
    (SELECT tm.tenant_id 
     FROM tenant_memberships tm 
     WHERE tm.user_id = auth.uid() 
       AND tm.status = 'active'
     LIMIT 1),
    NULL::UUID
  );
$$;
```

#### 4.2 í…Œë„ŒíŠ¸ë³„ RLS ì •ì±…

```sql
-- í•™ìƒ í…Œì´ë¸” RLS ì •ì±…
CREATE POLICY "Users can only access students in their tenant"
ON students FOR ALL
USING (tenant_id = auth.user_tenant_id());

-- í´ë˜ìŠ¤ í…Œì´ë¸” RLS ì •ì±…
CREATE POLICY "Users can only access classes in their tenant"
ON classes FOR ALL
USING (tenant_id = auth.user_tenant_id());

-- ë™ì˜ìƒ í…Œì´ë¸” RLS ì •ì±…
CREATE POLICY "Users can only access videos in their tenant"
ON videos FOR ALL
USING (tenant_id = auth.user_tenant_id());

-- ì‹œì²­ ê¸°ë¡ RLS ì •ì±… (í•™ìƒì€ ìì‹ ì˜ ê¸°ë¡ë§Œ)
CREATE POLICY "Students can only access their own watch sessions"
ON video_watch_sessions FOR ALL
USING (
  tenant_id = auth.user_tenant_id() AND
  (
    -- ê´€ë¦¬ì/ê°•ì‚¬ëŠ” ëª¨ë“  ê¸°ë¡ ì ‘ê·¼
    EXISTS (
      SELECT 1 FROM tenant_memberships tm
      JOIN tenant_roles tr ON tr.id = tm.role_id
      WHERE tm.user_id = auth.uid()
        AND tm.tenant_id = auth.user_tenant_id()
        AND tr.name IN ('admin', 'instructor')
    )
    OR
    -- í•™ìƒì€ ìì‹ ì˜ ê¸°ë¡ë§Œ
    student_id IN (
      SELECT s.id FROM students s
      WHERE s.tenant_id = auth.user_tenant_id()
        AND s.email = (SELECT email FROM user_profiles WHERE id = auth.uid())
    )
  )
);
```

### 5. ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •

```sql
-- ClassFlow ë° ë™ì˜ìƒ ê°•ì˜ë¥¼ ìœ„í•œ ì‹¤ì‹œê°„ êµ¬ë…
ALTER PUBLICATION supabase_realtime ADD TABLE student_enrollments;
ALTER PUBLICATION supabase_realtime ADD TABLE video_watch_sessions;
ALTER PUBLICATION supabase_realtime ADD TABLE videos;
ALTER PUBLICATION supabase_realtime ADD TABLE students;
ALTER PUBLICATION supabase_realtime ADD TABLE classes;
```

### 6. ê³ ê¸‰ íŠ¸ë¦¬ê±° ë° ìë™í™”

#### 6.1 ë™ì˜ìƒ ì‹œì²­ ì§„ë„ ìë™ ì—…ë°ì´íŠ¸

```sql
-- ë™ì˜ìƒ ì‹œì²­ ì§„ë„ ìë™ ì—…ë°ì´íŠ¸
CREATE OR REPLACE FUNCTION update_video_progress()
RETURNS TRIGGER AS $$
BEGIN
    -- ì™„ë£Œìœ¨ ê³„ì‚°
    IF NEW.progress_seconds > 0 AND 
       EXISTS (SELECT 1 FROM videos WHERE id = NEW.video_id AND duration_seconds > 0) THEN
        
        NEW.completion_percentage := LEAST(
            100.0, 
            (NEW.progress_seconds::DECIMAL / 
             (SELECT duration_seconds FROM videos WHERE id = NEW.video_id)) * 100
        );
        
        -- 80% ì´ìƒ ì‹œì²­ ì‹œ ì™„ë£Œ ì²˜ë¦¬
        IF NEW.completion_percentage >= 80 THEN
            NEW.watch_status := 'completed';
        ELSIF NEW.completion_percentage > 0 THEN
            NEW.watch_status := 'in_progress';
        END IF;
    END IF;
    
    -- ë™ì˜ìƒ ì „ì²´ ì‹œì²­ í†µê³„ ì—…ë°ì´íŠ¸
    UPDATE videos 
    SET 
        view_count = (
            SELECT COUNT(*) FROM video_watch_sessions 
            WHERE video_id = NEW.video_id 
              AND progress_seconds > 0
        ),
        total_watch_time = (
            SELECT COALESCE(SUM(total_watch_time), 0) 
            FROM video_watch_sessions 
            WHERE video_id = NEW.video_id
        ),
        updated_at = NOW()
    WHERE id = NEW.video_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER video_progress_trigger
    BEFORE INSERT OR UPDATE ON video_watch_sessions
    FOR EACH ROW
    EXECUTE FUNCTION update_video_progress();
```

#### 6.2 ìˆ˜ê°• ë“±ë¡ ìë™ ê´€ë¦¬

```sql
-- ìˆ˜ê°• ë“±ë¡ ì‚¬ìš©ëŸ‰ ë° ë§Œë£Œ ê´€ë¦¬
CREATE OR REPLACE FUNCTION manage_enrollment_status()
RETURNS TRIGGER AS $$
BEGIN
    -- ì”ì—¬ ìˆ˜ê°•ê¶Œ ê³„ì‚°
    NEW.sessions_remaining := GREATEST(0, NEW.sessions_total - NEW.sessions_used);
    NEW.hours_remaining := GREATEST(0, NEW.hours_total - NEW.hours_used);
    
    -- ì¶œì„ë¥  ê³„ì‚°
    NEW.attendance_rate := (
        SELECT COALESCE(
            (COUNT(*) FILTER (WHERE status IN ('present', 'late'))::DECIMAL / 
             NULLIF(COUNT(*), 0)) * 100, 
            0
        )
        FROM attendances 
        WHERE enrollment_id = NEW.id
    );
    
    -- ìˆ˜ê°•ê¶Œ ë§Œë£Œ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸
    IF NEW.expires_at IS NOT NULL AND NEW.expires_at < NOW() THEN
        NEW.status := 'expired';
    ELSIF NEW.sessions_remaining <= 0 AND NEW.sessions_total > 0 THEN
        NEW.status := 'completed';
    ELSIF NEW.hours_remaining <= 0 AND NEW.hours_total > 0 THEN
        NEW.status := 'completed';
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enrollment_management_trigger
    BEFORE INSERT OR UPDATE ON student_enrollments
    FOR EACH ROW
    EXECUTE FUNCTION manage_enrollment_status();
```

### 7. ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤

```sql
-- í…Œë„ŒíŠ¸ë³„ ì„±ëŠ¥ ìµœì í™”
CREATE INDEX idx_students_tenant_status ON students(tenant_id, status);
CREATE INDEX idx_students_tenant_name ON students(tenant_id, name);
CREATE INDEX idx_classes_tenant_instructor ON classes(tenant_id, instructor_id);
CREATE INDEX idx_enrollments_tenant_class ON student_enrollments(tenant_id, class_id);

-- ë™ì˜ìƒ ì„±ëŠ¥ ìµœì í™”
CREATE INDEX idx_videos_tenant_class ON videos(tenant_id, class_id);
CREATE INDEX idx_videos_youtube_id ON videos(youtube_video_id);
CREATE INDEX idx_video_sessions_student_video ON video_watch_sessions(student_id, video_id);
CREATE INDEX idx_video_sessions_tenant_status ON video_watch_sessions(tenant_id, watch_status);

-- ClassFlow ì„±ëŠ¥ ìµœì í™”
CREATE INDEX idx_enrollments_position ON student_enrollments(class_id, position_in_class, status);

-- ë©¤ë²„ì‹­ ë° ê¶Œí•œ ìµœì í™”
CREATE INDEX idx_memberships_user_tenant ON tenant_memberships(user_id, tenant_id, status);
CREATE INDEX idx_memberships_tenant_role ON tenant_memberships(tenant_id, role_id);
```

### 8. ìœ í‹¸ë¦¬í‹° ë·° ë° í•¨ìˆ˜

```sql
-- ì¢…í•© í•™ìƒ-í´ë˜ìŠ¤-ë™ì˜ìƒ ë·°
CREATE VIEW comprehensive_student_view AS
SELECT 
    s.id as student_id,
    s.name as student_name,
    s.tenant_id,
    t.name as tenant_name,
    c.id as class_id,
    c.name as class_name,
    se.position_in_class,
    se.status as enrollment_status,
    se.attendance_rate,
    
    -- ë™ì˜ìƒ ì§„ë„ ìš”ì•½
    COUNT(vws.id) as total_videos_assigned,
    COUNT(vws.id) FILTER (WHERE vws.watch_status = 'completed') as videos_completed,
    COALESCE(AVG(vws.completion_percentage), 0) as avg_video_completion,
    
    -- ìˆ˜ê°•ê¶Œ ì •ë³´
    se.sessions_remaining,
    se.hours_remaining,
    se.expires_at
    
FROM students s
JOIN tenants t ON t.id = s.tenant_id
JOIN student_enrollments se ON se.student_id = s.id
JOIN classes c ON c.id = se.class_id
LEFT JOIN videos v ON v.class_id = c.id AND v.status = 'published'
LEFT JOIN video_watch_sessions vws ON vws.video_id = v.id AND vws.student_id = s.id
WHERE se.status = 'active'
GROUP BY s.id, s.name, s.tenant_id, t.name, c.id, c.name, se.position_in_class, 
         se.status, se.attendance_rate, se.sessions_remaining, se.hours_remaining, se.expires_at;
```

### 9. ìƒ˜í”Œ ë°ì´í„° (ë©€í‹°í…Œë„ŒíŠ¸)

```sql
-- ìƒ˜í”Œ í…Œë„ŒíŠ¸
INSERT INTO tenants (id, name, slug, contact_email) VALUES
('tenant-1', 'ABC í•™ì›', 'abc-academy', 'admin@abc-academy.com'),
('tenant-2', 'XYZ êµìœ¡ì„¼í„°', 'xyz-center', 'admin@xyz-center.com');

-- ì‹œìŠ¤í…œ ì—­í•  (ê° í…Œë„ŒíŠ¸ë³„)
INSERT INTO tenant_roles (tenant_id, name, display_name, is_system_role, hierarchy_level) VALUES
('tenant-1', 'admin', 'ê´€ë¦¬ì', true, 1),
('tenant-1', 'instructor', 'ê°•ì‚¬', true, 2),
('tenant-1', 'staff', 'ì§ì›', true, 3),
('tenant-1', 'student', 'í•™ìƒ', true, 4);

-- ìƒ˜í”Œ ì‚¬ìš©ì ë° ë©¤ë²„ì‹­
INSERT INTO user_profiles (id, email, name) VALUES
('user-1', 'admin@abc-academy.com', 'ABC ê´€ë¦¬ì'),
('user-2', 'teacher@abc-academy.com', 'ê¹€ì„ ìƒë‹˜');

INSERT INTO tenant_memberships (tenant_id, user_id, role_id) VALUES
('tenant-1', 'user-1', (SELECT id FROM tenant_roles WHERE tenant_id = 'tenant-1' AND name = 'admin')),
('tenant-1', 'user-2', (SELECT id FROM tenant_roles WHERE tenant_id = 'tenant-1' AND name = 'instructor'));
```

## âœ… ì™„ë£Œ ê¸°ì¤€ (Acceptance Criteria)

### í•„ìˆ˜ ì¡°ê±´
- [ ] Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° ì—°ê²° ì™„ë£Œ
- [ ] database_schema_v4.1ì˜ ëª¨ë“  í…Œì´ë¸”, íƒ€ì…, í•¨ìˆ˜ ì •ìƒ ìƒì„±
- [ ] ë©€í‹°í…Œë„ŒíŠ¸ RLS ì •ì±… 100% êµ¬í˜„ ë° í…ŒìŠ¤íŠ¸
- [ ] YouTube ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ ì™„ì „ êµ¬í˜„
- [ ] ClassFlow ì‹¤ì‹œê°„ êµ¬ë… ê¸°ëŠ¥ í™œì„±í™”

### ë°ì´í„° ë¬´ê²°ì„± ì¡°ê±´
- [ ] í…Œë„ŒíŠ¸ë³„ ì™„ì „í•œ ë°ì´í„° ê²©ë¦¬
- [ ] ëª¨ë“  ì™¸ë˜í‚¤ ì œì•½ ì¡°ê±´ ì •ìƒ ë™ì‘
- [ ] ë™ì˜ìƒ ì‹œì²­ ì§„ë„ ì¶”ì  ì •í™•ì„±
- [ ] ìˆ˜ê°•ê¶Œ ì‚¬ìš©ëŸ‰ ìë™ ê´€ë¦¬ ì •í™•ì„±

### ì„±ëŠ¥ ì¡°ê±´
- [ ] ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ì—ì„œ ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™”
- [ ] 10,000ëª… í•™ìƒ + 1,000ê°œ ë™ì˜ìƒ ë°ì´í„° ì²˜ë¦¬ ê°€ëŠ¥
- [ ] RLS ì •ì±…ìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ < 20%

### ë³´ì•ˆ ì¡°ê±´
- [ ] í…Œë„ŒíŠ¸ ê°„ ì™„ì „í•œ ë°ì´í„° ê²©ë¦¬
- [ ] ë™ì˜ìƒ ì•¡ì„¸ìŠ¤ ê¶Œí•œ ì œì–´ ì •í™•ì„±
- [ ] ì‚¬ìš©ì ê¶Œí•œë³„ ì ‘ê·¼ ì œì–´ 100% ì •í™•ì„±

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

### 1. ë©€í‹°í…Œë„ŒíŠ¸ ê²©ë¦¬ í…ŒìŠ¤íŠ¸
```sql
-- í…Œë„ŒíŠ¸ A ì‚¬ìš©ìë¡œ í…Œë„ŒíŠ¸ B ë°ì´í„° ì ‘ê·¼ ì‹œë„ (ì‹¤íŒ¨í•´ì•¼ í•¨)
SET LOCAL request.jwt.claims.sub TO 'user-from-tenant-a';
SELECT COUNT(*) FROM students WHERE tenant_id = 'tenant-b'; -- 0ì´ì–´ì•¼ í•¨
```

### 2. ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
```sql
-- ë™ì˜ìƒ ì‹œì²­ ì§„ë„ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
INSERT INTO video_watch_sessions (video_id, student_id, progress_seconds)
VALUES ('video-1', 'student-1', 600); -- 10ë¶„ ì‹œì²­

-- ì™„ë£Œìœ¨ ìë™ ê³„ì‚° í™•ì¸
SELECT completion_percentage, watch_status FROM video_watch_sessions 
WHERE video_id = 'video-1' AND student_id = 'student-1';
```

### 3. ê¶Œí•œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
```typescript
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê¶Œí•œë³„ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
const testUserPermissions = async (userId: string) => {
  const { data: accessibleStudents } = await supabase
    .from('students')
    .select('*');
    
  console.log(`User ${userId} can access ${accessibleStudents.length} students`);
};
```

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
EduCanvas/
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ config.toml              # Supabase ë¡œì»¬ ì„¤ì •
â”‚   â”œâ”€â”€ migrations/              # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
â”‚   â”‚   â””â”€â”€ 20250814000001_v41_multitenant_video.sql
â”‚   â”œâ”€â”€ functions/               # Edge Functions
â”‚   â”‚   â”œâ”€â”€ video-proxy/         # YouTube ë™ì˜ìƒ í”„ë¡ì‹œ
â”‚   â”‚   â””â”€â”€ tenant-management/   # í…Œë„ŒíŠ¸ ê´€ë¦¬
â”‚   â””â”€â”€ seed.sql                 # ë©€í‹°í…Œë„ŒíŠ¸ ìƒ˜í”Œ ë°ì´í„°
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ supabase/
â”‚   â”‚       â”œâ”€â”€ client.ts        # ë¸Œë¼ìš°ì € í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚       â”œâ”€â”€ server.ts        # ì„œë²„ í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚       â”œâ”€â”€ admin.ts         # ê´€ë¦¬ì í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚       â””â”€â”€ types.ts         # v4.1 ìë™ ìƒì„± íƒ€ì…
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useTenant.ts         # í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸
â”‚   â”‚   â”œâ”€â”€ useVideoProgress.ts  # ë™ì˜ìƒ ì§„ë„ ê´€ë¦¬
â”‚   â”‚   â””â”€â”€ usePermissions.ts    # ê¶Œí•œ ê´€ë¦¬
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ tenant.ts            # í…Œë„ŒíŠ¸ ìœ í‹¸ë¦¬í‹°
â”‚       â””â”€â”€ video.ts             # ë™ì˜ìƒ ìœ í‹¸ë¦¬í‹°
â”œâ”€â”€ .env.local                   # í™˜ê²½ ë³€ìˆ˜
â””â”€â”€ .env.example                 # í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿
```

## ğŸ’» í•µì‹¬ êµ¬í˜„ ì½”ë“œ

### 1. ë©€í‹°í…Œë„ŒíŠ¸ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •

```typescript
// src/lib/supabase/client.ts
import { createBrowserSupabaseClient } from '@supabase/auth-helpers-nextjs'
import { Database } from '@/types/database'

export const supabase = createBrowserSupabaseClient<Database>()

// í…Œë„ŒíŠ¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ„í•œ í—¬í¼
export const createTenantClient = (tenantId: string) => {
  return supabase.rpc('set_current_tenant', { tenant_id: tenantId })
}
```

### 2. ë™ì˜ìƒ ì§„ë„ ê´€ë¦¬ í›…

```typescript
// src/hooks/useVideoProgress.ts
import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase/client'

export const useVideoProgress = (videoId: string, studentId: string) => {
  const [progress, setProgress] = useState(0)
  const [watchStatus, setWatchStatus] = useState<'not_started' | 'in_progress' | 'completed'>('not_started')

  const updateProgress = async (progressSeconds: number) => {
    const { data, error } = await supabase
      .from('video_watch_sessions')
      .upsert({
        video_id: videoId,
        student_id: studentId,
        progress_seconds: progressSeconds,
        last_position_time: new Date().toISOString()
      })
      .select()
      .single()

    if (!error && data) {
      setProgress(data.completion_percentage)
      setWatchStatus(data.watch_status)
    }
  }

  return { progress, watchStatus, updateProgress }
}
```

### 3. í…Œë„ŒíŠ¸ ê´€ë¦¬ ìœ í‹¸ë¦¬í‹°

```typescript
// src/utils/tenant.ts
import { supabase } from '@/lib/supabase/client'

export const getCurrentTenant = async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return null

  const { data } = await supabase
    .from('tenant_memberships')
    .select(`
      tenant_id,
      tenants (
        id,
        name,
        slug,
        features
      )
    `)
    .eq('user_id', user.id)
    .eq('status', 'active')
    .single()

  return data?.tenants
}

export const switchTenant = async (tenantId: string) => {
  return await supabase.rpc('set_current_tenant', {
    tenant_id: tenantId
  })
}
```

## ğŸš¨ ìœ„í—˜ ìš”ì†Œ ë° ì™„í™” ë°©ì•ˆ

### ë†’ì€ ìœ„í—˜
**ë©€í‹°í…Œë„ŒíŠ¸ ë°ì´í„° ê²©ë¦¬ ì‹¤íŒ¨**
- ìœ„í—˜: RLS ì •ì±… ì˜¤ë¥˜ë¡œ ì¸í•œ í…Œë„ŒíŠ¸ ê°„ ë°ì´í„° ë…¸ì¶œ
- ì™„í™”: ì² ì €í•œ RLS í…ŒìŠ¤íŠ¸, ìë™í™”ëœ ë³´ì•ˆ ê²€ì¦

**ë³µì¡í•œ ê¶Œí•œ ì‹œìŠ¤í…œ**
- ìœ„í—˜: ìœ ì—°í•œ ê¶Œí•œ ì‹œìŠ¤í…œìœ¼ë¡œ ì¸í•œ ì„¤ì • ë³µì¡ë„ ì¦ê°€
- ì™„í™”: ë‹¨ê³„ë³„ êµ¬í˜„, ê¸°ë³¸ ì—­í•  í…œí”Œë¦¿ ì œê³µ

### ì¤‘ê°„ ìœ„í—˜
**YouTube API ì˜ì¡´ì„±**
- ìœ„í—˜: YouTube API ì œí•œ ë° ì •ì±… ë³€ê²½
- ì™„í™”: ìºì‹± ì „ëµ, ëŒ€ì²´ ë¹„ë””ì˜¤ ì„œë¹„ìŠ¤ ì¤€ë¹„

**ì„±ëŠ¥ ìµœì í™”**
- ìœ„í—˜: ë©€í‹°í…Œë„ŒíŠ¸ êµ¬ì¡°ë¡œ ì¸í•œ ì¿¼ë¦¬ ë³µì¡ë„ ì¦ê°€
- ì™„í™”: ì ì ˆí•œ ì¸ë±ì‹±, ì¿¼ë¦¬ ìµœì í™”, ëª¨ë‹ˆí„°ë§

## ğŸ”„ í›„ì† ì‘ì—…

ì´ íƒœìŠ¤í¬ ì™„ë£Œ í›„ ì—°ê²°ë˜ëŠ” ì‘ì—…ë“¤:
- T-004: TypeScript íƒ€ì… ìë™ ìƒì„± ì„¤ì • (v4.1 ê¸°ì¤€)
- T-005: ë©€í‹°í…Œë„ŒíŠ¸ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„
- T-007: YouTube ë™ì˜ìƒ ê°•ì˜ API êµ¬í˜„
- T-013: í•™ìƒ CRUD API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (ë©€í‹°í…Œë„ŒíŠ¸)

## âœ… ì‘ì—… ì™„ë£Œ ê²°ê³¼

### 1. ê¸°ë³¸ ì„¤ì • âœ…
- [x] database_schema_v4.1.sql íŒŒì¼ í™•ì¸
- [x] Supabase CLI ì„¤ì¹˜ (v2.33.9)
- [x] Supabase í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
- [x] ì›ê²© í”„ë¡œì íŠ¸ ì—°ê²° (hodkqpmukwfrreozwmcy)

### 2. ìŠ¤í‚¤ë§ˆ ì ìš© âœ…
- [x] ë©€í‹°í…Œë„ŒíŠ¸ í•µì‹¬ í…Œì´ë¸” ìƒì„±
- [x] YouTube ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ êµ¬í˜„
- [x] ëª¨ë“  ENUM íƒ€ì… ì •ì˜
- [x] ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤ ìƒì„±

### 3. ë³´ì•ˆ ì‹œìŠ¤í…œ âœ…
- [x] Row Level Security (RLS) ì •ì±… êµ¬í˜„
- [x] í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ê²©ë¦¬ ë³´ì¥
- [x] ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- [x] ë™ì˜ìƒ ì•¡ì„¸ìŠ¤ ê¶Œí•œ ì œì–´

### 4. ìë™í™” íŠ¸ë¦¬ê±° âœ…
- [x] ë™ì˜ìƒ ì‹œì²­ ì§„ë„ ìë™ ì—…ë°ì´íŠ¸
- [x] ìˆ˜ê°•ê¶Œ ì‚¬ìš©ëŸ‰ ê´€ë¦¬
- [x] ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •

### 5. ìƒ˜í”Œ ë°ì´í„° âœ…
- [x] 3ê°œ í…Œë„ŒíŠ¸ ìƒì„± (ë°ëª¨ í•™ì›, XYZ êµìœ¡ì„¼í„°, ìŠ¤ë§ˆíŠ¸ ì•„ì¹´ë°ë¯¸)
- [x] 8ê°œ í´ë˜ìŠ¤, 11ëª… í•™ìƒ ìƒì„±
- [x] ë™ì˜ìƒ ê°•ì˜ ë° ì‹œì²­ ê¸°ë¡ ìƒì„±
- [x] ClassFlow í…ŒìŠ¤íŠ¸ìš© position_in_class ì„¤ì •

### 6. í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ âœ…
- [x] ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì† í…ŒìŠ¤íŠ¸ í˜ì´ì§€ í™•ì¸
- [x] ì‹¤í–‰ ê°€ì´ë“œ ë¬¸ì„œ ì‘ì„±
- [x] í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦

## ğŸ“ ìƒì„±ëœ íŒŒì¼ ëª©ë¡

```
supabase/
â”œâ”€â”€ config.toml                 # Supabase ì„¤ì •
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 20250810_v4.1_multitenant_video.sql
â”œâ”€â”€ schema_setup.sql            # ìŠ¤í‚¤ë§ˆ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ rls_policies_fixed.sql      # RLS ì •ì±… ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì •ë²„ì „)
â”œâ”€â”€ sample_data_working.sql     # ìƒ˜í”Œ ë°ì´í„° ìŠ¤í¬ë¦½íŠ¸ (ìµœì¢…)
â””â”€â”€ README.md                   # ì‹¤í–‰ ê°€ì´ë“œ

src/lib/supabase/
â””â”€â”€ client.ts                   # Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •

src/app/test-db/
â””â”€â”€ page.tsx                    # ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì† í…ŒìŠ¤íŠ¸ í˜ì´ì§€

docs/
â”œâ”€â”€ database-development-checklist.md  # ë°ì´í„°ë² ì´ìŠ¤ ê°œë°œ ì²´í¬ë¦¬ìŠ¤íŠ¸
â””â”€â”€ project/DECISIONS/
    â””â”€â”€ ADR-0003-uuid-development-standards.md  # UUID ê°œë°œ í‘œì¤€
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì† í…ŒìŠ¤íŠ¸
- âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
- âœ… í™˜ê²½ë³€ìˆ˜ í™•ì¸
- âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ
- âœ… ì¸ì¦ ìƒíƒœ í™•ì¸
- âœ… í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ê²€ì¦

### ìƒì„±ëœ ë°ì´í„° í˜„í™©
- **í…Œë„ŒíŠ¸**: 3ê°œ
- **ì‚¬ìš©ì ì—­í• **: 12ê°œ (ê° í…Œë„ŒíŠ¸ë³„ 4ê°œ)
- **í´ë˜ìŠ¤**: 8ê°œ
- **í•™ìƒ**: 11ëª…
- **ìˆ˜ê°• ë“±ë¡**: 5ê°œ
- **ë™ì˜ìƒ ê°•ì˜**: 4ê°œ
- **ì‹œì²­ ê¸°ë¡**: 5ê°œ

## ğŸš¨ ë°œìƒí•œ ë¬¸ì œ ë° í•´ê²°ì±…

### UUID í˜•ì‹ ì˜¤ë¥˜ (3ì‹œê°„ ì§€ì—°)
**ë¬¸ì œ**: ì˜ëª»ëœ UUID í˜•ì‹ìœ¼ë¡œ ì¸í•œ ë°˜ë³µì  SQL ì˜¤ë¥˜
```
ERROR: 22P02: invalid input syntax for type uuid: "ffffffff-gggg-hhhh-iiii-jjjjjjjjjjjj"
```

**ì›ì¸**: ìˆ˜ë™ í•˜ë“œì½”ë”©ëœ UUIDì—ì„œ ë§ˆì§€ë§‰ segmentê°€ 11ìë¦¬ (ì˜¬ë°”ë¥¸ í˜•ì‹: 12ìë¦¬)

**í•´ê²°ì±…**: 
1. PostgreSQL `gen_random_uuid()` ìë™ ìƒì„± ì‚¬ìš©
2. ë™ì  ì°¸ì¡° ì‹œìŠ¤í…œìœ¼ë¡œ ê´€ê³„í˜• ë°ì´í„° ìƒì„±
3. `ON CONFLICT DO NOTHING` ì¶©ëŒ ë°©ì§€

**ì˜ˆë°©ì±… ìˆ˜ë¦½**:
- [CLAUDE.md UUID ê°€ì´ë“œë¼ì¸](../../CLAUDE.md) ì—…ë°ì´íŠ¸
- [ADR-0003 UUID ê°œë°œ í‘œì¤€](../DECISIONS/ADR-0003-uuid-development-standards.md) ë¬¸ì„œí™”
- [Database Development Checklist](../../database-development-checklist.md) ì‘ì„±

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### ìŠ¤í‚¤ë§ˆ ì ìš© (Supabase ì›¹ ì¸í„°í˜ì´ìŠ¤)
1. https://supabase.com/dashboard/project/hodkqpmukwfrreozwmcy/sql ì ‘ì†
2. `supabase/schema_setup.sql` ì‹¤í–‰
3. `supabase/rls_policies_fixed.sql` ì‹¤í–‰  
4. `supabase/sample_data_working.sql` ì‹¤í–‰

### ë¡œì»¬ í…ŒìŠ¤íŠ¸
1. `npm run dev`
2. http://localhost:3000/test-db ì ‘ì†
3. "ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œì‘" í´ë¦­

## ğŸ—ï¸ êµ¬í˜„ëœ ì•„í‚¤í…ì²˜

### ë©€í‹°í…Œë„ŒíŠ¸ ì‹œìŠ¤í…œ
- **ì™„ì „í•œ ë°ì´í„° ê²©ë¦¬**: í…Œë„ŒíŠ¸ë³„ ë…ë¦½ì  ë°ì´í„° ê´€ë¦¬
- **ìœ ì—°í•œ ê¶Œí•œ ì‹œìŠ¤í…œ**: í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ì—­í•  ì •ì˜
- **í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°**: ìƒˆë¡œìš´ í…Œë„ŒíŠ¸ ì¶”ê°€ ìš©ì´

### YouTube ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ
- **ë™ì˜ìƒ ë©”íƒ€ë°ì´í„° ê´€ë¦¬**: ì œëª©, ì„¤ëª…, ì‹œê°„, í’ˆì§ˆ ë“±
- **ì‹œì²­ ì§„ë„ ì¶”ì **: ì‹¤ì‹œê°„ ì‹œì²­ ì‹œê°„ ë° ì™„ë£Œìœ¨ ê³„ì‚°
- **ì ‘ê·¼ ê¶Œí•œ ì œì–´**: ìˆ˜ê°• ë“±ë¡ ìƒíƒœ ê¸°ë°˜ ì ‘ê·¼ ê´€ë¦¬

### ClassFlow ë“œë˜ê·¸ì•¤ë“œë¡­ ì§€ì›
- **position_in_class**: í•™ìƒ ë°°ì¹˜ ìˆœì„œ ê´€ë¦¬
- **ì‹¤ì‹œê°„ êµ¬ë…**: ë™ì‹œ í¸ì§‘ ì§€ì›
- **ìœ ë‹ˆí¬ ì œì•½**: ì¤‘ë³µ ìœ„ì¹˜ ë°©ì§€

## ğŸ‰ ì„±ê³¼

- **ë©€í‹°í…Œë„ŒíŠ¸ ì•„í‚¤í…ì²˜** ì™„ì „ êµ¬í˜„
- **YouTube ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ** í†µí•©
- **ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ ë³´ì•ˆ** RLS ì •ì±… ì ìš©
- **ClassFlow ë“œë˜ê·¸ì•¤ë“œë¡­** ì§€ì› êµ¬ì¡° ì™„ì„±
- **í™•ì¥ ê°€ëŠ¥í•œ ì¸í”„ë¼** êµ¬ì¶•
- **ê°œë°œ í‘œì¤€ ìˆ˜ë¦½** UUID ì˜¤ë¥˜ ë°©ì§€ì±… ë¬¸ì„œí™”

---

**ì‘ì„±ì**: Backend Dev â†’ Claude Code (ì™„ë£Œì)
**ê²€í† ì**: Lead Dev, DBA, Security Architect  
**ì‘ì„±ì¼**: 2025-08-08  
**ì™„ë£Œì¼**: 2025-08-10  
**ì—…ë°ì´íŠ¸**: 2025-08-10 (v4.1 ë©€í‹°í…Œë„ŒíŠ¸ + ë™ì˜ìƒ ê°•ì˜ ì‹œìŠ¤í…œ)  
**ê´€ë ¨ ìŠ¤í”„ë¦°íŠ¸**: S1 (í”„ë¡œì íŠ¸ ê¸°ë°˜ ì„¤ì •)  
**êµí›ˆ**: ê¸°ë³¸ì ì¸ ì‹¤ìˆ˜ê°€ í° ì§€ì—°ì„ ì•¼ê¸°í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ í‘œì¤€ ì¤€ìˆ˜ê°€ í•„ìˆ˜