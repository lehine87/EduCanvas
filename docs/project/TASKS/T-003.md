---
id: T-003
title: Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° database_schema_v3.sql ì ìš©
status: TODO
priority: P0
assignees: [Backend Dev]
estimate: 1.0d
due: 2025-08-14
dependencies: [T-001]
labels: [database, setup, infrastructure]
---

# T-003: Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° database_schema_v3.sql ì ìš©

## ğŸ“‹ ì‘ì—… ê°œìš”

EduCanvas MVPì˜ ë°±ì—”ë“œ ì¸í”„ë¼ì¸ Supabase í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³ , ë³µì¡í•œ ìš”ê¸ˆì œì™€ ê¸‰ì—¬ ì •ì±… + í™•ì¥ ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” database_schema_v3.sqlì„ ì™„ì „íˆ ì ìš©í•©ë‹ˆë‹¤. MVP ê¸°ë°˜ + Phase 4-10 í™•ì¥ ê¸°ëŠ¥, Row Level Security, ì‹¤ì‹œê°„ ê¸°ëŠ¥, ìë™ íŠ¸ë¦¬ê±°ê¹Œì§€ ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ê¸°ëŠ¥ì„ ì™„ì„±í•©ë‹ˆë‹¤.

## ğŸ¯ ëª©ì 

- Supabase í”„ë¡œì íŠ¸ ì™„ì „í•œ ì„¤ì • ë° í™˜ê²½ êµ¬ì„±
- database_schema_v3.sql ê¸°ë°˜ ì™„ì „í•œ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ êµ¬ì¶• (MVP + í™•ì¥)
- **MVP ê¸°ë°˜**: 5ê°€ì§€ ìš”ê¸ˆì œ íƒ€ì…ê³¼ 7ê°€ì§€ ê¸‰ì—¬ ì •ì±… ì™„ë²½ ì§€ì›
- **í™•ì¥ ê¸°ëŠ¥**: êµì‹¤, ì‹œê°„í‘œ, ì„±ì , ë¬¸ì„œ, íˆìŠ¤í† ë¦¬, ìƒë‹´ ê´€ë¦¬ ì‹œìŠ¤í…œ
- Row Level Security (RLS) 4-tier ê¶Œí•œ ì‹œìŠ¤í…œ êµ¬í˜„
- ì‹¤ì‹œê°„ êµ¬ë… ë° ìë™í™” íŠ¸ë¦¬ê±° ì„¤ì •
- AI ê¸°ë°˜ í•™ìŠµ ë¶„ì„ì„ ìœ„í•œ ë°ì´í„° êµ¬ì¡° ì¤€ë¹„
- TypeScript íƒ€ì… ìë™ ìƒì„± í™˜ê²½ êµ¬ì¶•

## ğŸ—ï¸ êµ¬í˜„ í•­ëª©

### 1. Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° ê¸°ë³¸ ì„¤ì •

- [ ] Supabase ê³„ì • ìƒì„± ë° ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
- [ ] í”„ë¡œì íŠ¸ ì„¤ì • ìµœì í™” (ì§€ì—­: ì•„ì‹œì•„-íƒœí‰ì–‘ ì„ íƒ)
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ ì•ˆì „í•œ ì„¤ì •
- [ ] API í‚¤ ë° ì—°ê²° ì •ë³´ í™•ì¸

### 2. ë¡œì»¬ ê°œë°œ í™˜ê²½ ì„¤ì •

```bash
# Supabase CLI ì„¤ì¹˜
npm install -g supabase

# í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
supabase init

# ë¡œì»¬ ê°œë°œ í™˜ê²½ ì‹œì‘
supabase start

# ì›ê²© í”„ë¡œì íŠ¸ ì—°ê²°
supabase link --project-ref [PROJECT_ID]
```

### 3. database_schema_v2.sql ì™„ì „ ì ìš©

#### 3.1 ì—´ê±°í˜• íƒ€ì… (ENUMs) ì •ì˜
```sql
-- í•™ìƒ ìƒíƒœ
CREATE TYPE student_status AS ENUM ('active', 'waiting', 'inactive', 'graduated');

-- ì‚¬ìš©ì ì—­í•  (4-tier RBAC)
CREATE TYPE user_role AS ENUM ('admin', 'instructor', 'staff', 'viewer');

-- ì¶œì„ ìƒíƒœ  
CREATE TYPE attendance_status AS ENUM ('present', 'late', 'absent', 'excused');

-- ê²°ì œ ìƒíƒœ
CREATE TYPE payment_status AS ENUM ('pending', 'completed', 'overdue', 'cancelled', 'refunded');

-- ê²°ì œ ë°©ë²•
CREATE TYPE payment_method AS ENUM ('cash', 'card', 'transfer', 'mobile');

-- 5ê°€ì§€ ìˆ˜ê°•ê¶Œ ì²­êµ¬ ìœ í˜•
CREATE TYPE billing_type AS ENUM (
    'monthly',      -- ì›” ì •ì•¡ì œ
    'sessions',     -- íšŒì°¨ì œ (10íšŒê¶Œ, 20íšŒê¶Œ)
    'hours',        -- ì‹œê°„ì œ
    'package',      -- íŒ¨í‚¤ì§€ (3ê°œì›”, 6ê°œì›”)
    'drop_in'       -- ë“œë¡­ì¸ (ë§¤íšŒ ê²°ì œ)
);

-- í• ì¸ ìœ í˜•
CREATE TYPE discount_type AS ENUM (
    'sibling',          -- í˜•ì œ í• ì¸
    'early_payment',    -- ì¡°ê¸° ë‚©ë¶€ í• ì¸
    'loyalty',          -- ì¥ê¸° ìˆ˜ê°• í• ì¸
    'scholarship',      -- ì¥í•™ê¸ˆ
    'promotion',        -- í”„ë¡œëª¨ì…˜
    'volume'           -- ë‹¤ê³¼ëª© í• ì¸
);

-- 7ê°€ì§€ ê¸‰ì—¬ ì •ì±… ìœ í˜•
CREATE TYPE salary_policy_type AS ENUM (
    'fixed_monthly',     -- ê³ ì • ì›”ê¸‰
    'fixed_hourly',      -- ê³ ì • ì‹œê¸‰  
    'commission',        -- ë‹¨ìˆœ ë¹„ìœ¨ì œ
    'tiered_commission', -- ëˆ„ì§„ ë¹„ìœ¨ì œ
    'student_based',     -- í•™ìƒ ìˆ˜ ê¸°ì¤€
    'performance_based', -- ì„±ê³¼ê¸‰
    'hybrid'            -- ë³µí•©í˜• (ê¸°ë³¸ê¸‰ + ì„±ê³¼ê¸‰)
);
```

#### 3.2 í•µì‹¬ í…Œì´ë¸” ìƒì„±

**ì‚¬ìš©ì ê´€ë¦¬**
```sql
-- ì‚¬ìš©ì í”„ë¡œí•„ (Supabase Auth í™•ì¥)
CREATE TABLE user_profiles (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    role user_role NOT NULL DEFAULT 'viewer',
    phone TEXT,
    avatar_url TEXT,
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**í•™ìƒ ê´€ë¦¬**
```sql
-- í•™ìƒ ì •ë³´
CREATE TABLE students (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_number TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    name_english TEXT,
    birth_date DATE,
    gender TEXT CHECK (gender IN ('male', 'female')),
    phone TEXT,
    email TEXT,
    address TEXT,
    school TEXT,
    grade TEXT,
    status student_status DEFAULT 'active',
    notes TEXT,
    emergency_contact JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- í•™ë¶€ëª¨ ì •ë³´
CREATE TABLE guardians (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    relationship TEXT NOT NULL,
    phone TEXT NOT NULL,
    email TEXT,
    is_primary BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**í´ë˜ìŠ¤ ë° ê°•ì‚¬ ê´€ë¦¬**
```sql
-- í´ë˜ìŠ¤ ì •ë³´
CREATE TABLE classes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    subject TEXT,
    level TEXT,
    max_students INTEGER DEFAULT 20,
    instructor_id UUID REFERENCES user_profiles(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ê¸‰ì—¬ ì •ì±…
CREATE TABLE salary_policies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    instructor_id UUID REFERENCES user_profiles(id),
    policy_type salary_policy_type NOT NULL,
    base_amount DECIMAL(10,2) DEFAULT 0,
    rate DECIMAL(5,4) DEFAULT 0,
    tier_config JSONB,
    effective_from DATE NOT NULL,
    effective_to DATE,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**ìˆ˜ê°•ê¶Œ ë° ê²°ì œ ì‹œìŠ¤í…œ**
```sql
-- ìˆ˜ê°•ê¶Œ íŒ¨í‚¤ì§€ (5ê°€ì§€ ìš”ê¸ˆì œ ì§€ì›)
CREATE TABLE course_packages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    class_id UUID REFERENCES classes(id),
    name TEXT NOT NULL,
    billing_type billing_type NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    sessions INTEGER DEFAULT 0,
    hours DECIMAL(4,1) DEFAULT 0,
    months INTEGER DEFAULT 0,
    validity_months INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- ì²­êµ¬ íƒ€ì…ë³„ í•„ìˆ˜ í•„ë“œ ê²€ì¦
    CONSTRAINT valid_billing_config CHECK (
        CASE billing_type
            WHEN 'sessions' THEN sessions > 0
            WHEN 'hours' THEN hours > 0
            WHEN 'package' THEN months > 0
            ELSE true
        END
    )
);

-- í• ì¸ ì •ì±…
CREATE TABLE discount_policies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    discount_type discount_type NOT NULL,
    discount_rate DECIMAL(5,4) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    min_students INTEGER DEFAULT 1,
    max_students INTEGER,
    conditions JSONB,
    is_active BOOLEAN DEFAULT true,
    valid_from DATE NOT NULL,
    valid_to DATE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- í•™ìƒ ìˆ˜ê°•ê¶Œ ë“±ë¡
CREATE TABLE student_enrollments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    class_id UUID REFERENCES classes(id),
    package_id UUID REFERENCES course_packages(id),
    
    -- ë“±ë¡ ì •ë³´
    enrolled_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMPTZ,
    
    -- ì‚¬ìš©ëŸ‰ ì¶”ì 
    sessions_total INTEGER DEFAULT 0,
    sessions_used INTEGER DEFAULT 0,
    hours_total DECIMAL(4,1) DEFAULT 0,
    hours_used DECIMAL(4,1) DEFAULT 0,
    
    -- ìƒíƒœ ê´€ë¦¬
    is_active BOOLEAN DEFAULT true,
    position_in_class INTEGER DEFAULT 0,
    
    -- ê²°ì œ ì •ë³´
    original_price DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    final_price DECIMAL(10,2) NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- ClassFlowë¥¼ ìœ„í•œ ìœ ë‹ˆí¬ ì œì•½
    UNIQUE(class_id, position_in_class)
);

-- ê²°ì œ ê¸°ë¡
CREATE TABLE payments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    enrollment_id UUID REFERENCES student_enrollments(id),
    amount DECIMAL(10,2) NOT NULL,
    method payment_method NOT NULL,
    status payment_status DEFAULT 'pending',
    due_date DATE,
    paid_at TIMESTAMPTZ,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

**ì¶œì„ ê´€ë¦¬**
```sql
-- ì¶œì„ ê¸°ë¡
CREATE TABLE attendances (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id UUID REFERENCES students(id) ON DELETE CASCADE,
    class_id UUID REFERENCES classes(id),
    enrollment_id UUID REFERENCES student_enrollments(id),
    
    attendance_date DATE NOT NULL,
    status attendance_status DEFAULT 'present',
    check_in_time TIMESTAMPTZ,
    check_out_time TIMESTAMPTZ,
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- ì¤‘ë³µ ì¶œì„ ë°©ì§€
    UNIQUE(student_id, class_id, attendance_date)
);
```

### 4. Row Level Security (RLS) ì •ì±… êµ¬í˜„

#### 4.1 RLS í™œì„±í™”
```sql
-- ëª¨ë“  í…Œì´ë¸”ì—ì„œ RLS í™œì„±í™”
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE guardians ENABLE ROW LEVEL SECURITY;
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE salary_policies ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_packages ENABLE ROW LEVEL SECURITY;
ALTER TABLE discount_policies ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendances ENABLE ROW LEVEL SECURITY;
```

#### 4.2 4-tier ê¶Œí•œë³„ ì •ì±… ì •ì˜

**Admin ê¶Œí•œ (ëª¨ë“  ì ‘ê·¼)**
```sql
-- Adminì€ ëª¨ë“  í…Œì´ë¸” ì ‘ê·¼ ê°€ëŠ¥
CREATE POLICY "Admin full access" ON students
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role = 'admin'
        )
    );

-- ë‹¤ë¥¸ í…Œì´ë¸”ë“¤ë„ ë™ì¼í•œ íŒ¨í„´ìœ¼ë¡œ ì ìš©
CREATE POLICY "Admin full access" ON classes
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role = 'admin'
        )
    );
```

**Instructor ê¶Œí•œ (ë‹´ë‹¹ í´ë˜ìŠ¤ë§Œ)**
```sql
-- ê°•ì‚¬ëŠ” ìì‹ ì´ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ì˜ í•™ìƒë§Œ ì¡°íšŒ
CREATE POLICY "Instructor class students" ON students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM user_profiles up
            JOIN classes c ON c.instructor_id = up.id
            JOIN student_enrollments se ON se.class_id = c.id AND se.student_id = students.id
            WHERE up.id = auth.uid() AND up.role = 'instructor'
        )
    );

-- ìì‹ ì˜ ê¸‰ì—¬ ì •ì±…ë§Œ ì¡°íšŒ
CREATE POLICY "Instructor own salary" ON salary_policies
    FOR SELECT USING (
        instructor_id = auth.uid() AND 
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('instructor', 'admin')
        )
    );
```

**Staff ê¶Œí•œ (ì œí•œëœ ì½ê¸°/ì“°ê¸°)**
```sql
-- ìŠ¤íƒœí”„ëŠ” í•™ìƒ ì •ë³´ ì½ê¸°/ìˆ˜ì • ê°€ëŠ¥ (ì‚­ì œ ë¶ˆê°€)
CREATE POLICY "Staff student access" ON students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('staff', 'admin')
        )
    );

CREATE POLICY "Staff student update" ON students
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('staff', 'admin')
        )
    );
```

**Viewer ê¶Œí•œ (ì½ê¸°ë§Œ)**
```sql
-- ë·°ì–´ëŠ” ê¸°ë³¸ ì •ë³´ë§Œ ì½ê¸° ê°€ëŠ¥
CREATE POLICY "Viewer basic read" ON students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM user_profiles 
            WHERE id = auth.uid() AND role IN ('viewer', 'staff', 'instructor', 'admin')
        )
    );
```

### 5. ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •

```sql
-- ClassFlowë¥¼ ìœ„í•œ ì‹¤ì‹œê°„ êµ¬ë… í™œì„±í™”
ALTER PUBLICATION supabase_realtime ADD TABLE student_enrollments;
ALTER PUBLICATION supabase_realtime ADD TABLE attendances;
ALTER PUBLICATION supabase_realtime ADD TABLE students;
ALTER PUBLICATION supabase_realtime ADD TABLE classes;
```

### 6. ìë™í™” íŠ¸ë¦¬ê±° êµ¬í˜„

#### 6.1 ì‚¬ìš©ëŸ‰ ìë™ ì°¨ê° íŠ¸ë¦¬ê±°
```sql
-- ì¶œì„ ì‹œ ì‚¬ìš©ëŸ‰ ìë™ ì°¨ê°
CREATE OR REPLACE FUNCTION update_enrollment_usage()
RETURNS TRIGGER AS $$
BEGIN
    -- ì¶œì„ ì²´í¬ ì‹œ ì‚¬ìš©ëŸ‰ ì°¨ê°
    IF NEW.status = 'present' THEN
        UPDATE student_enrollments 
        SET 
            sessions_used = sessions_used + 1,
            hours_used = hours_used + 1.0,  -- ê¸°ë³¸ 1ì‹œê°„ ì°¨ê°
            updated_at = CURRENT_TIMESTAMP
        WHERE id = NEW.enrollment_id;
        
        -- ì‚¬ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ì•Œë¦¼ (ë‚˜ì¤‘ì— í™•ì¥ ê°€ëŠ¥)
        -- í˜„ì¬ëŠ” ê¸°ë³¸ ì°¨ê°ë§Œ êµ¬í˜„
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER attendance_usage_trigger
    AFTER INSERT OR UPDATE ON attendances
    FOR EACH ROW
    EXECUTE FUNCTION update_enrollment_usage();
```

#### 6.2 ì—…ë°ì´íŠ¸ ì‹œê° ìë™ ê°±ì‹ 
```sql
-- updated_at ìë™ ê°±ì‹  í•¨ìˆ˜
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ì£¼ìš” í…Œì´ë¸”ì— íŠ¸ë¦¬ê±° ì ìš©
CREATE TRIGGER update_students_updated_at 
    BEFORE UPDATE ON students
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_profiles_updated_at 
    BEFORE UPDATE ON user_profiles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_classes_updated_at 
    BEFORE UPDATE ON classes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_enrollments_updated_at 
    BEFORE UPDATE ON student_enrollments
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 6.3 ê¸‰ì—¬ ê³„ì‚° ìë™í™” (ê¸°ë³¸ êµ¬ì¡°)
```sql
-- ê¸‰ì—¬ ê³„ì‚° í•¨ìˆ˜ (í–¥í›„ í™•ì¥ ê°€ëŠ¥)
CREATE OR REPLACE FUNCTION calculate_instructor_salary(
    instructor_id UUID,
    calculation_month DATE
)
RETURNS DECIMAL(10,2) AS $$
DECLARE
    policy salary_policies%ROWTYPE;
    total_salary DECIMAL(10,2) := 0;
    student_count INTEGER;
    attendance_count INTEGER;
BEGIN
    -- í•´ë‹¹ ì›”ì˜ í™œì„± ê¸‰ì—¬ ì •ì±… ì¡°íšŒ
    SELECT * INTO policy
    FROM salary_policies sp
    WHERE sp.instructor_id = calculate_instructor_salary.instructor_id
      AND sp.is_active = true
      AND sp.effective_from <= calculation_month
      AND (sp.effective_to IS NULL OR sp.effective_to >= calculation_month)
    ORDER BY sp.effective_from DESC
    LIMIT 1;
    
    IF policy.id IS NULL THEN
        RETURN 0;
    END IF;
    
    -- ì •ì±… íƒ€ì…ë³„ ê³„ì‚°
    CASE policy.policy_type
        WHEN 'fixed_monthly' THEN
            total_salary := policy.base_amount;
            
        WHEN 'fixed_hourly' THEN
            -- í•´ë‹¹ ì›” ì¶œì„ ì‹œê°„ ê³„ì‚° (ê¸°ë³¸ êµ¬í˜„)
            SELECT COUNT(*) INTO attendance_count
            FROM attendances a
            JOIN classes c ON c.id = a.class_id
            WHERE c.instructor_id = calculate_instructor_salary.instructor_id
              AND DATE_TRUNC('month', a.attendance_date) = DATE_TRUNC('month', calculation_month)
              AND a.status = 'present';
            
            total_salary := attendance_count * policy.base_amount;
            
        WHEN 'student_based' THEN
            -- í•´ë‹¹ ì›” í‰ê·  í•™ìƒ ìˆ˜ ê³„ì‚°
            SELECT COUNT(DISTINCT se.student_id) INTO student_count
            FROM student_enrollments se
            JOIN classes c ON c.id = se.class_id
            WHERE c.instructor_id = calculate_instructor_salary.instructor_id
              AND se.is_active = true
              AND se.enrolled_at <= (calculation_month + INTERVAL '1 month - 1 day');
            
            total_salary := student_count * policy.base_amount;
            
        ELSE
            -- ë‹¤ë¥¸ ì •ì±…ë“¤ì€ í–¥í›„ êµ¬í˜„
            total_salary := policy.base_amount;
    END CASE;
    
    RETURN total_salary;
END;
$$ LANGUAGE plpgsql;
```

### 7. ì¸ë±ìŠ¤ ë° ì„±ëŠ¥ ìµœì í™”

```sql
-- ìì£¼ ì‚¬ìš©ë˜ëŠ” ì¿¼ë¦¬ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
CREATE INDEX idx_students_status ON students(status);
CREATE INDEX idx_students_name ON students(name);
CREATE INDEX idx_students_student_number ON students(student_number);

CREATE INDEX idx_classes_instructor ON classes(instructor_id);
CREATE INDEX idx_classes_active ON classes(is_active);

CREATE INDEX idx_enrollments_student ON student_enrollments(student_id);
CREATE INDEX idx_enrollments_class ON student_enrollments(class_id);
CREATE INDEX idx_enrollments_active ON student_enrollments(is_active);
CREATE INDEX idx_enrollments_position ON student_enrollments(class_id, position_in_class);

CREATE INDEX idx_attendances_date ON attendances(attendance_date);
CREATE INDEX idx_attendances_student_class ON attendances(student_id, class_id);

CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_due_date ON payments(due_date);

-- ë³µí•© ì¸ë±ìŠ¤ (ClassFlow ì„±ëŠ¥ ìµœì í™”)
CREATE INDEX idx_enrollments_class_position_active ON student_enrollments(class_id, position_in_class, is_active);
```

### 8. ë·° ë° í•¨ìˆ˜ ìƒì„±

```sql
-- ClassFlowë¥¼ ìœ„í•œ ë·° (í•™ìƒ-í´ë˜ìŠ¤ ê´€ê³„)
CREATE VIEW student_class_view AS
SELECT 
    s.id as student_id,
    s.name as student_name,
    s.student_number,
    s.status as student_status,
    c.id as class_id,
    c.name as class_name,
    se.position_in_class,
    se.enrolled_at,
    se.expires_at,
    se.sessions_total,
    se.sessions_used,
    se.hours_total,
    se.hours_used,
    se.is_active as enrollment_active,
    up.name as instructor_name
FROM students s
JOIN student_enrollments se ON se.student_id = s.id
JOIN classes c ON c.id = se.class_id
LEFT JOIN user_profiles up ON up.id = c.instructor_id
WHERE se.is_active = true
ORDER BY c.name, se.position_in_class;

-- í†µê³„ë¥¼ ìœ„í•œ ë·°
CREATE VIEW enrollment_stats AS
SELECT 
    c.id as class_id,
    c.name as class_name,
    COUNT(se.student_id) as total_students,
    COUNT(se.student_id) FILTER (WHERE s.status = 'active') as active_students,
    c.max_students,
    c.max_students - COUNT(se.student_id) as available_slots
FROM classes c
LEFT JOIN student_enrollments se ON se.class_id = c.id AND se.is_active = true
LEFT JOIN students s ON s.id = se.student_id
WHERE c.is_active = true
GROUP BY c.id, c.name, c.max_students;
```

### 9. ìƒ˜í”Œ ë°ì´í„° ì‚½ì…

```sql
-- ê¸°ë³¸ ê´€ë¦¬ì ì‚¬ìš©ì (ì‹¤ì œ auth.usersì™€ ì—°ë™ í•„ìš”)
INSERT INTO user_profiles (id, email, name, role) VALUES
('00000000-0000-0000-0000-000000000001', 'admin@educanvas.com', 'ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'admin'),
('00000000-0000-0000-0000-000000000002', 'instructor1@educanvas.com', 'ê¹€ì„ ìƒë‹˜', 'instructor'),
('00000000-0000-0000-0000-000000000003', 'staff1@educanvas.com', 'ë°•ì§ì›', 'staff');

-- ìƒ˜í”Œ í´ë˜ìŠ¤
INSERT INTO classes (id, name, subject, level, max_students, instructor_id) VALUES
('10000000-0000-0000-0000-000000000001', 'ìˆ˜í•™ ì¤‘ê¸‰ë°˜', 'ìˆ˜í•™', 'ì¤‘ê¸‰', 15, '00000000-0000-0000-0000-000000000002'),
('10000000-0000-0000-0000-000000000002', 'ì˜ì–´ ê³ ê¸‰ë°˜', 'ì˜ì–´', 'ê³ ê¸‰', 12, '00000000-0000-0000-0000-000000000002'),
('10000000-0000-0000-0000-000000000003', 'ê³¼í•™ ì´ˆê¸‰ë°˜', 'ê³¼í•™', 'ì´ˆê¸‰', 20, '00000000-0000-0000-0000-000000000002');

-- ìƒ˜í”Œ ìˆ˜ê°•ê¶Œ íŒ¨í‚¤ì§€
INSERT INTO course_packages (class_id, name, billing_type, price, sessions, months) VALUES
('10000000-0000-0000-0000-000000000001', 'ìˆ˜í•™ ì›”ì •ì•¡', 'monthly', 150000, 0, 1),
('10000000-0000-0000-0000-000000000001', 'ìˆ˜í•™ 10íšŒê¶Œ', 'sessions', 200000, 10, 0),
('10000000-0000-0000-0000-000000000002', 'ì˜ì–´ 3ê°œì›” íŒ¨í‚¤ì§€', 'package', 400000, 0, 3),
('10000000-0000-0000-0000-000000000003', 'ê³¼í•™ ì‹œê°„ì œ', 'hours', 20000, 0, 0);

-- ìƒ˜í”Œ í•™ìƒ (5ëª…)
INSERT INTO students (id, student_number, name, birth_date, phone, status) VALUES
('20000000-0000-0000-0000-000000000001', 'ST001', 'ì´ë¯¼ì¤€', '2010-03-15', '010-1111-1111', 'active'),
('20000000-0000-0000-0000-000000000002', 'ST002', 'ê¹€ì„œì—°', '2011-07-22', '010-2222-2222', 'active'),
('20000000-0000-0000-0000-000000000003', 'ST003', 'ë°•ì§€í˜¸', '2010-11-08', '010-3333-3333', 'active'),
('20000000-0000-0000-0000-000000000004', 'ST004', 'ìµœìœ ì§„', '2009-05-30', '010-4444-4444', 'active'),
('20000000-0000-0000-0000-000000000005', 'ST005', 'ì •í˜„ìš°', '2010-12-03', '010-5555-5555', 'waiting');

-- ìƒ˜í”Œ ìˆ˜ê°• ë“±ë¡ (ClassFlow í…ŒìŠ¤íŠ¸ìš©)
INSERT INTO student_enrollments (student_id, class_id, package_id, position_in_class, sessions_total, original_price, final_price) VALUES
('20000000-0000-0000-0000-000000000001', '10000000-0000-0000-0000-000000000001', (SELECT id FROM course_packages WHERE name = 'ìˆ˜í•™ ì›”ì •ì•¡'), 1, 0, 150000, 150000),
('20000000-0000-0000-0000-000000000002', '10000000-0000-0000-0000-000000000001', (SELECT id FROM course_packages WHERE name = 'ìˆ˜í•™ 10íšŒê¶Œ'), 2, 10, 200000, 200000),
('20000000-0000-0000-0000-000000000003', '10000000-0000-0000-0000-000000000002', (SELECT id FROM course_packages WHERE name = 'ì˜ì–´ 3ê°œì›” íŒ¨í‚¤ì§€'), 1, 0, 400000, 400000);
```

## âœ… ì™„ë£Œ ê¸°ì¤€ (Acceptance Criteria)

### í•„ìˆ˜ ì¡°ê±´
- [ ] Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° ì—°ê²° ì™„ë£Œ
- [ ] database_schema_v2.sqlì˜ ëª¨ë“  í…Œì´ë¸”, íƒ€ì…, í•¨ìˆ˜ ì •ìƒ ìƒì„±
- [ ] 5ê°€ì§€ ìš”ê¸ˆì œ íƒ€ì… ëª¨ë‘ ì •ìƒ ë™ì‘ í™•ì¸
- [ ] 4-tier RBAC (admin/instructor/staff/viewer) ê¶Œí•œ ì‹œìŠ¤í…œ ì™„ë²½ êµ¬í˜„
- [ ] ClassFlowë¥¼ ìœ„í•œ ì‹¤ì‹œê°„ êµ¬ë… ê¸°ëŠ¥ í™œì„±í™”

### ë°ì´í„° ë¬´ê²°ì„± ì¡°ê±´
- [ ] ëª¨ë“  ì™¸ë˜í‚¤ ì œì•½ ì¡°ê±´ ì •ìƒ ë™ì‘
- [ ] position_in_class ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ (ë™ì¼ í´ë˜ìŠ¤ ë‚´ ì¤‘ë³µ ë°©ì§€)
- [ ] ì‚¬ìš©ëŸ‰ ì¶”ì  ë¡œì§ ì •í™•ì„± (sessions_used, hours_used)
- [ ] ìš”ê¸ˆì œë³„ í•„ìˆ˜ í•„ë“œ ê²€ì¦ (billing_type CHECK ì œì•½)

### ì„±ëŠ¥ ì¡°ê±´
- [ ] í•„ìˆ˜ ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ (í•™ìƒ ì¡°íšŒ, í´ë˜ìŠ¤ë³„ ì¡°íšŒ ë“±)
- [ ] 1000ëª… í•™ìƒ ë°ì´í„° ì‚½ì… ì‹œ ì‘ë‹µ ì‹œê°„ < 5ì´ˆ
- [ ] ClassFlow í•™ìƒ ì´ë™ ì¿¼ë¦¬ ì‘ë‹µ ì‹œê°„ < 100ms

### ë³´ì•ˆ ì¡°ê±´
- [ ] ëª¨ë“  í…Œì´ë¸” RLS í™œì„±í™”
- [ ] ê¶Œí•œë³„ ì ‘ê·¼ ì œì–´ ì •í™•ì„± 100% (admin/instructor/staff/viewer)
- [ ] API í‚¤ ë° ì—°ê²° ì •ë³´ ì•ˆì „í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- [ ] ë¯¼ê° ì •ë³´ (ê¸‰ì—¬ ì •ì±…) ê¶Œí•œë³„ ì ‘ê·¼ ì œí•œ

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

### 1. ìŠ¤í‚¤ë§ˆ ìƒì„± í…ŒìŠ¤íŠ¸
```sql
-- ëª¨ë“  í…Œì´ë¸” ì¡´ì¬ í™•ì¸
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- ëª¨ë“  ì—´ê±°í˜• íƒ€ì… í™•ì¸
SELECT typname FROM pg_type WHERE typtype = 'e' ORDER BY typname;

-- ì¸ë±ìŠ¤ ìƒì„± í™•ì¸
SELECT indexname FROM pg_indexes WHERE schemaname = 'public' ORDER BY indexname;
```

### 2. ë°ì´í„° ì‚½ì… í…ŒìŠ¤íŠ¸
```sql
-- 5ê°€ì§€ ìš”ê¸ˆì œ íƒ€ì… í…ŒìŠ¤íŠ¸
INSERT INTO course_packages (name, billing_type, price, sessions, hours, months) VALUES
('í…ŒìŠ¤íŠ¸ ì›”ì •ì•¡', 'monthly', 100000, 0, 0, 1),
('í…ŒìŠ¤íŠ¸ 10íšŒê¶Œ', 'sessions', 150000, 10, 0, 0),
('í…ŒìŠ¤íŠ¸ ì‹œê°„ì œ', 'hours', 25000, 0, 1.0, 0),
('í…ŒìŠ¤íŠ¸ 3ê°œì›” íŒ¨í‚¤ì§€', 'package', 300000, 0, 0, 3),
('í…ŒìŠ¤íŠ¸ ë“œë¡­ì¸', 'drop_in', 20000, 1, 0, 0);

-- CHECK ì œì•½ ì¡°ê±´ í…ŒìŠ¤íŠ¸ (ì‹¤íŒ¨í•´ì•¼ í•¨)
INSERT INTO course_packages (name, billing_type, price, sessions) VALUES
('ì˜ëª»ëœ íšŒì°¨ì œ', 'sessions', 100000, 0); -- sessions > 0 ì¡°ê±´ ìœ„ë°˜
```

### 3. RLS ê¶Œí•œ í…ŒìŠ¤íŠ¸
```sql
-- Admin ê¶Œí•œ í…ŒìŠ¤íŠ¸ (ëª¨ë“  ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥)
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claims.sub TO '00000000-0000-0000-0000-000000000001';
SELECT COUNT(*) FROM students; -- ëª¨ë“  í•™ìƒ ì¡°íšŒ ê°€ëŠ¥

-- Instructor ê¶Œí•œ í…ŒìŠ¤íŠ¸ (ë‹´ë‹¹ í´ë˜ìŠ¤ë§Œ ì ‘ê·¼)
SET LOCAL request.jwt.claims.sub TO '00000000-0000-0000-0000-000000000002';
SELECT COUNT(*) FROM students; -- ë‹´ë‹¹ í´ë˜ìŠ¤ í•™ìƒë§Œ ì¡°íšŒ

-- Viewer ê¶Œí•œ í…ŒìŠ¤íŠ¸ (ì½ê¸°ë§Œ ê°€ëŠ¥)
SET LOCAL request.jwt.claims.sub TO '00000000-0000-0000-0000-000000000004';
INSERT INTO students (name, student_number) VALUES ('í…ŒìŠ¤íŠ¸', 'TEST001'); -- ì‹¤íŒ¨í•´ì•¼ í•¨
```

### 4. ClassFlow ì‹¤ì‹œê°„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```typescript
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‹¤ì‹œê°„ êµ¬ë… í…ŒìŠ¤íŠ¸
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const subscription = supabase
  .channel('student_enrollments')
  .on('postgres_changes', 
    { event: 'UPDATE', schema: 'public', table: 'student_enrollments' },
    (payload) => {
      console.log('í•™ìƒ ì´ë™ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', payload);
    }
  )
  .subscribe();
```

### 5. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
```sql
-- ëŒ€ëŸ‰ ë°ì´í„° ì‚½ì… í…ŒìŠ¤íŠ¸
INSERT INTO students (student_number, name, status)
SELECT 
  'BULK' || generate_series(1, 1000),
  'Test Student ' || generate_series(1, 1000),
  'active'
FROM generate_series(1, 1000);

-- ì¸ë±ìŠ¤ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
EXPLAIN ANALYZE SELECT * FROM students WHERE status = 'active';
EXPLAIN ANALYZE SELECT * FROM student_enrollments WHERE class_id = '10000000-0000-0000-0000-000000000001';
```

### 6. ìë™í™” íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸
```sql
-- ì¶œì„ ì²´í¬ ì‹œ ì‚¬ìš©ëŸ‰ ìë™ ì°¨ê° í…ŒìŠ¤íŠ¸
INSERT INTO attendances (student_id, class_id, enrollment_id, attendance_date, status)
VALUES (
  '20000000-0000-0000-0000-000000000002',
  '10000000-0000-0000-0000-000000000001',
  (SELECT id FROM student_enrollments WHERE student_id = '20000000-0000-0000-0000-000000000002'),
  CURRENT_DATE,
  'present'
);

-- ì‚¬ìš©ëŸ‰ ì°¨ê° í™•ì¸
SELECT sessions_used, hours_used FROM student_enrollments 
WHERE student_id = '20000000-0000-0000-0000-000000000002';
```

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
EduCanvas/
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ config.toml              # Supabase ë¡œì»¬ ì„¤ì •
â”‚   â”œâ”€â”€ migrations/              # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
â”‚   â”‚   â””â”€â”€ 20250812000001_initial_schema.sql
â”‚   â”œâ”€â”€ functions/               # Edge Functions (í–¥í›„)
â”‚   â””â”€â”€ seed.sql                 # ìƒ˜í”Œ ë°ì´í„°
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ supabase/
â”‚   â”‚       â”œâ”€â”€ client.ts        # Supabase í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚       â”œâ”€â”€ server.ts        # ì„œë²„ì‚¬ì´ë“œ í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚       â””â”€â”€ types.ts         # ìë™ ìƒì„±ëœ íƒ€ì…
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ database.ts          # ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
â”œâ”€â”€ .env.local                   # í™˜ê²½ ë³€ìˆ˜ (ë¡œì»¬)
â””â”€â”€ .env.example                 # í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿
```

## ğŸ’» í•µì‹¬ êµ¬í˜„ ì½”ë“œ

### 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env.local)
```bash
# Supabase ì„¤ì •
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# ë¡œì»¬ ê°œë°œìš© (supabase start í›„ ì œê³µë˜ëŠ” URL)
# NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
# NEXT_PUBLIC_SUPABASE_ANON_KEY=your-local-anon-key
```

### 2. Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
```typescript
// src/lib/supabase/client.ts
import { createBrowserSupabaseClient } from '@supabase/auth-helpers-nextjs'
import { Database } from '@/types/database'

export const supabase = createBrowserSupabaseClient<Database>()

// src/lib/supabase/server.ts
import { createServerSupabaseClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { Database } from '@/types/database'

export const createServerSupabaseClient = () => {
  return createServerSupabaseClient<Database>({
    headers: headers(),
    cookies: cookies(),
  })
}
```

### 3. TypeScript íƒ€ì… ìë™ ìƒì„±
```bash
# íƒ€ì… ìƒì„± ëª…ë ¹
supabase gen types typescript --project-id YOUR_PROJECT_ID --schema public > src/types/database.ts

# package.jsonì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
{
  "scripts": {
    "types:generate": "supabase gen types typescript --local > src/types/database.ts"
  }
}
```

### 4. ClassFlowë¥¼ ìœ„í•œ ì¿¼ë¦¬ í•¨ìˆ˜
```typescript
// src/lib/supabase/queries.ts
import { supabase } from './client'
import { Database } from '@/types/database'

type StudentEnrollment = Database['public']['Tables']['student_enrollments']['Row']

// ClassFlow í•™ìƒ ëª©ë¡ ì¡°íšŒ
export async function getStudentsByClass(classId: string) {
  const { data, error } = await supabase
    .from('student_class_view')
    .select('*')
    .eq('class_id', classId)
    .eq('enrollment_active', true)
    .order('position_in_class')
  
  if (error) throw error
  return data
}

// í•™ìƒ í´ë˜ìŠ¤ ì´ë™
export async function moveStudentToClass(
  studentId: string, 
  targetClassId: string, 
  position: number
) {
  // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì´ë™
  const { data, error } = await supabase.rpc('move_student_to_class', {
    p_student_id: studentId,
    p_target_class_id: targetClassId,
    p_position: position
  })
  
  if (error) throw error
  return data
}

// ì‹¤ì‹œê°„ êµ¬ë… ì„¤ì •
export function subscribeToClassChanges(
  classId: string, 
  callback: (payload: any) => void
) {
  return supabase
    .channel(`class-${classId}`)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'student_enrollments',
      filter: `class_id=eq.${classId}`
    }, callback)
    .subscribe()
}
```

### 5. í•™ìƒ ì´ë™ì„ ìœ„í•œ PostgreSQL í•¨ìˆ˜
```sql
-- í•™ìƒ ì•ˆì „í•œ í´ë˜ìŠ¤ ì´ë™ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION move_student_to_class(
    p_student_id UUID,
    p_target_class_id UUID,
    p_position INTEGER
)
RETURNS JSON AS $$
DECLARE
    current_enrollment student_enrollments%ROWTYPE;
    max_students INTEGER;
    current_student_count INTEGER;
    result JSON;
BEGIN
    -- í˜„ì¬ ë“±ë¡ ì •ë³´ ì¡°íšŒ
    SELECT * INTO current_enrollment
    FROM student_enrollments
    WHERE student_id = p_student_id AND is_active = true;
    
    IF current_enrollment.id IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'Student not found or not enrolled');
    END IF;
    
    -- ëŒ€ìƒ í´ë˜ìŠ¤ ì •ì› ë° í˜„ì¬ ì¸ì› í™•ì¸
    SELECT c.max_students, COUNT(se.student_id)
    INTO max_students, current_student_count
    FROM classes c
    LEFT JOIN student_enrollments se ON se.class_id = c.id AND se.is_active = true
    WHERE c.id = p_target_class_id
    GROUP BY c.id, c.max_students;
    
    -- ì •ì› ì´ˆê³¼ í™•ì¸
    IF current_student_count >= max_students THEN
        RETURN json_build_object('success', false, 'error', 'Target class is full');
    END IF;
    
    -- ìœ„ì¹˜ ì¡°ì • (ê¸°ì¡´ í•™ìƒë“¤ì˜ position ì¬ì •ë ¬)
    UPDATE student_enrollments 
    SET position_in_class = position_in_class + 1
    WHERE class_id = p_target_class_id 
      AND position_in_class >= p_position 
      AND is_active = true;
    
    -- í•™ìƒ ì´ë™
    UPDATE student_enrollments
    SET 
        class_id = p_target_class_id,
        position_in_class = p_position,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = current_enrollment.id;
    
    -- ì„±ê³µ ì‘ë‹µ
    SELECT json_build_object(
        'success', true,
        'student_id', p_student_id,
        'new_class_id', p_target_class_id,
        'new_position', p_position
    ) INTO result;
    
    RETURN result;
    
EXCEPTION WHEN OTHERS THEN
    -- ì—ëŸ¬ ì‘ë‹µ
    RETURN json_build_object('success', false, 'error', SQLERRM);
END;
$$ LANGUAGE plpgsql;
```

## ğŸš¨ ìœ„í—˜ ìš”ì†Œ ë° ì™„í™” ë°©ì•ˆ

### ë†’ì€ ìœ„í—˜
**ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œ**
- ìœ„í—˜: ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°ì´í„° ë¶ˆì¼ì¹˜
- ì™„í™”: íŠ¸ëœì­ì…˜ ë‹¨ìœ„ ì²˜ë¦¬, CHECK ì œì•½ ì¡°ê±´ í™œìš©, ì² ì €í•œ í…ŒìŠ¤íŠ¸

**ì„±ëŠ¥ ì €í•˜**
- ìœ„í—˜: RLS ì •ì±…ìœ¼ë¡œ ì¸í•œ ì¿¼ë¦¬ ì„±ëŠ¥ ì €í•˜
- ì™„í™”: ì ì ˆí•œ ì¸ë±ìŠ¤ ìƒì„±, ì¿¼ë¦¬ ìµœì í™”, ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### ì¤‘ê°„ ìœ„í—˜
**Supabase ì œì•½ì‚¬í•­**
- ìœ„í—˜: ë™ì‹œ ì ‘ì†ì ìˆ˜, ë°ì´í„°ë² ì´ìŠ¤ í¬ê¸° ì œí•œ
- ì™„í™”: ì ì ˆí•œ ìš”ê¸ˆì œ ì„ íƒ, ëª¨ë‹ˆí„°ë§ ì„¤ì •

**ë³µì¡í•œ ê¶Œí•œ ì‹œìŠ¤í…œ**
- ìœ„í—˜: RLS ì •ì±… ì„¤ì • ì˜¤ë¥˜
- ì™„í™”: ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸, ê¶Œí•œë³„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [Supabase Documentation](https://supabase.com/docs)
- [PostgreSQL Row Level Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Supabase Realtime](https://supabase.com/docs/guides/realtime)
- [database_design.md](../../docs/database_design.md)

## ğŸ”„ í›„ì† ì‘ì—…

ì´ íƒœìŠ¤í¬ ì™„ë£Œ í›„ ì—°ê²°ë˜ëŠ” ì‘ì—…ë“¤:
- T-004: TypeScript íƒ€ì… ìë™ ìƒì„± ì„¤ì •
- T-007: Supabase Auth ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„
- T-008: RBAC ê¸°ë³¸ êµ¬ì¡° êµ¬í˜„ (ì´ë¯¸ DBì— êµ¬í˜„ë¨)
- T-013: í•™ìƒ CRUD API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

---

**ì‘ì„±ì**: Backend Dev  
**ê²€í† ì**: Lead Dev, DBA  
**ì‘ì„±ì¼**: 2025-08-08  
**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-08-10 (v3 ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸)  
**ê´€ë ¨ ìŠ¤í”„ë¦°íŠ¸**: S1 (í”„ë¡œì íŠ¸ ê¸°ë°˜ ì„¤ì •)