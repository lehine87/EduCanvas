# T-004: TypeScript Type Generation Setup

**Task ID**: T-004  
**Priority**: P0 (MVP Critical)  
**Estimated Time**: 2-3 days  
**Dependencies**: T-001 (í”„ë¡œì íŠ¸ êµ¬ì¡°), T-003 (ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •)  
**Phase**: 1 (ê¸°ë°˜ êµ¬ì¶•)

## ğŸ“‹ Task Overview

Supabase database_schema_v4.1ì˜ ë©€í‹°í…Œë„ŒíŠ¸ ì•„í‚¤í…ì²˜ì™€ YouTube ë¹„ë””ì˜¤ í†µí•© ì‹œìŠ¤í…œì„ ìœ„í•œ TypeScript íƒ€ì…ì„ ìë™ ìƒì„±í•˜ê³ , íƒ€ì… ì•ˆì „ì„±ì„ ë³´ì¥í•˜ëŠ” ê°œë°œ í™˜ê²½ì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

## ğŸ¯ Success Criteria

- [ ] Supabase CLIë¥¼ í†µí•œ TypeScript íƒ€ì… ìë™ ìƒì„± ì„¤ì •
- [ ] ë©€í‹°í…Œë„ŒíŠ¸ ìŠ¤í‚¤ë§ˆ v4.1ì˜ ëª¨ë“  í…Œì´ë¸”ê³¼ ê´€ê³„ íƒ€ì… ìƒì„±
- [ ] YouTube ë¹„ë””ì˜¤ ì‹œìŠ¤í…œ ê´€ë ¨ íƒ€ì… ì™„ì „ ì§€ì›
- [ ] Row Level Security (RLS) ì •ì±…ê³¼ í˜¸í™˜ë˜ëŠ” íƒ€ì… ì‹œìŠ¤í…œ
- [ ] ê°œë°œ ì‹œ ì‹¤ì‹œê°„ íƒ€ì… ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš° êµ¬ì¶•
- [ ] íƒ€ì… ê²€ì‚¬ 100% í†µê³¼ (strict mode)
- [ ] ì»´íŒŒì¼ ì‹œê°„ < 5ì´ˆ ìœ ì§€

## ğŸ“š Technical Requirements

### 1. Supabase Type Generation

#### í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
npm install -D supabase
npm install @supabase/supabase-js
```

#### Supabase CLI ì„¤ì •
```json
// supabase/config.toml
[api]
enabled = true
port = 54321
schemas = ["public", "auth", "storage", "realtime"]
extra_search_path = ["public", "extensions"]
max_rows = 1000

[db]
port = 54322
shadow_port = 54320
major_version = 15

[studio]
enabled = true
port = 54323

[auth]
enabled = true
port = 54324
site_url = "http://localhost:3000"
additional_redirect_urls = ["https://localhost:3000"]

[edge_functions]
enabled = true
port = 54325
```

#### íƒ€ì… ìƒì„± ìŠ¤í¬ë¦½íŠ¸
```json
// package.json scripts ì¶”ê°€
{
  "scripts": {
    "types:generate": "supabase gen types typescript --project-id $SUPABASE_PROJECT_ID --schema public > src/types/supabase.ts",
    "types:watch": "chokidar 'supabase/migrations/*.sql' -c 'npm run types:generate'",
    "types:validate": "tsc --noEmit --strict"
  }
}
```

### 2. Multitenant Schema v4.1 Types

#### í•µì‹¬ ì—”í‹°í‹° íƒ€ì… (ìë™ ìƒì„± ì˜ˆìƒ)

```typescript
// src/types/supabase.ts (ìë™ ìƒì„±ë¨)
export type Database = {
  public: {
    Tables: {
      // ë©€í‹°í…Œë„ŒíŠ¸ í•µì‹¬
      tenants: {
        Row: {
          id: string
          name: string
          subdomain: string
          settings: Json
          subscription_tier: 'basic' | 'pro' | 'enterprise'
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          name: string
          subdomain: string
          settings?: Json
          subscription_tier?: 'basic' | 'pro' | 'enterprise'
          created_at?: string
          updated_at?: string
        }
        Update: {
          name?: string
          subdomain?: string
          settings?: Json
          subscription_tier?: 'basic' | 'pro' | 'enterprise'
          updated_at?: string
        }
      }
      
      // ì‚¬ìš©ì ê´€ë¦¬
      tenant_users: {
        Row: {
          id: string
          tenant_id: string
          user_id: string
          role: 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
          permissions: Json
          status: 'active' | 'inactive' | 'suspended'
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          user_id: string
          role: 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
          permissions?: Json
          status?: 'active' | 'inactive' | 'suspended'
          created_at?: string
          updated_at?: string
        }
        Update: {
          role?: 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
          permissions?: Json
          status?: 'active' | 'inactive' | 'suspended'
          updated_at?: string
        }
      }
      
      // í•™ìƒ ê´€ë¦¬
      students: {
        Row: {
          id: string
          tenant_id: string
          name: string
          phone: string | null
          parent_phone: string | null
          email: string | null
          birth_date: string | null
          school: string | null
          grade: number | null
          gender: 'male' | 'female' | 'other' | null
          address: string | null
          emergency_contact: Json | null
          medical_info: Json | null
          enrollment_date: string
          status: 'active' | 'inactive' | 'graduated' | 'transferred'
          tags: string[]
          notes: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          name: string
          phone?: string | null
          parent_phone?: string | null
          email?: string | null
          birth_date?: string | null
          school?: string | null
          grade?: number | null
          gender?: 'male' | 'female' | 'other' | null
          address?: string | null
          emergency_contact?: Json | null
          medical_info?: Json | null
          enrollment_date?: string
          status?: 'active' | 'inactive' | 'graduated' | 'transferred'
          tags?: string[]
          notes?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          name?: string
          phone?: string | null
          parent_phone?: string | null
          email?: string | null
          birth_date?: string | null
          school?: string | null
          grade?: number | null
          gender?: 'male' | 'female' | 'other' | null
          address?: string | null
          emergency_contact?: Json | null
          medical_info?: Json | null
          enrollment_date?: string
          status?: 'active' | 'inactive' | 'graduated' | 'transferred'
          tags?: string[]
          notes?: string | null
          updated_at?: string
        }
      }
      
      // YouTube ë¹„ë””ì˜¤ ì‹œìŠ¤í…œ
      youtube_videos: {
        Row: {
          id: string
          tenant_id: string
          youtube_id: string
          title: string
          description: string | null
          duration: number
          thumbnail_url: string | null
          channel_id: string
          published_at: string
          category: string | null
          tags: string[]
          quality_levels: string[]
          captions_available: boolean
          status: 'active' | 'inactive' | 'private' | 'deleted'
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          youtube_id: string
          title: string
          description?: string | null
          duration: number
          thumbnail_url?: string | null
          channel_id: string
          published_at: string
          category?: string | null
          tags?: string[]
          quality_levels?: string[]
          captions_available?: boolean
          status?: 'active' | 'inactive' | 'private' | 'deleted'
          created_at?: string
          updated_at?: string
        }
        Update: {
          title?: string
          description?: string | null
          duration?: number
          thumbnail_url?: string | null
          category?: string | null
          tags?: string[]
          quality_levels?: string[]
          captions_available?: boolean
          status?: 'active' | 'inactive' | 'private' | 'deleted'
          updated_at?: string
        }
      }
      
      // ë¹„ë””ì˜¤ ì‹œì²­ ì§„ë„
      student_video_progress: {
        Row: {
          id: string
          tenant_id: string
          student_id: string
          video_id: string
          watched_duration: number
          total_duration: number
          completion_percentage: number
          last_watched_at: string
          completed_at: string | null
          watch_sessions: Json[]
          notes: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          student_id: string
          video_id: string
          watched_duration?: number
          total_duration: number
          completion_percentage?: number
          last_watched_at: string
          completed_at?: string | null
          watch_sessions?: Json[]
          notes?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          watched_duration?: number
          total_duration?: number
          completion_percentage?: number
          last_watched_at?: string
          completed_at?: string | null
          watch_sessions?: Json[]
          notes?: string | null
          updated_at?: string
        }
      }
    }
    Views: {
      // ë·° íƒ€ì…ë“¤ (ìë™ ìƒì„±)
      student_enrollment_stats: {
        Row: {
          tenant_id: string
          student_id: string
          student_name: string
          total_enrollments: number
          active_enrollments: number
          total_payments: number
          last_payment_date: string | null
        }
      }
      
      video_learning_analytics: {
        Row: {
          tenant_id: string
          video_id: string
          video_title: string
          total_students: number
          completed_students: number
          average_completion: number
          total_watch_time: number
        }
      }
    }
    Functions: {
      // RPC í•¨ìˆ˜ íƒ€ì…ë“¤ (ìë™ ìƒì„±)
      get_student_by_tenant: {
        Args: { p_tenant_id: string; p_student_id: string }
        Returns: Database['public']['Tables']['students']['Row'] | null
      }
      
      update_video_progress: {
        Args: {
          p_tenant_id: string
          p_student_id: string
          p_video_id: string
          p_watched_duration: number
          p_session_data: Json
        }
        Returns: boolean
      }
    }
  }
}
```

### 3. ì»¤ìŠ¤í…€ íƒ€ì… ì •ì˜

#### ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ íƒ€ì…
```typescript
// src/types/app.types.ts
import { Database } from './supabase'

// í¸ì˜ì„±ì„ ìœ„í•œ íƒ€ì… ë³„ì¹­
export type Tables = Database['public']['Tables']
export type Student = Tables['students']['Row']
export type StudentInsert = Tables['students']['Insert']
export type StudentUpdate = Tables['students']['Update']
export type Tenant = Tables['tenants']['Row']
export type TenantUser = Tables['tenant_users']['Row']
export type YouTubeVideo = Tables['youtube_videos']['Row']
export type VideoProgress = Tables['student_video_progress']['Row']

// ClassFlow ê´€ë ¨ íƒ€ì…
export interface ClassFlowStudent extends Student {
  position?: { x: number; y: number }
  isDragging?: boolean
  isSelected?: boolean
}

export interface ClassFlowClass {
  id: string
  name: string
  students: ClassFlowStudent[]
  maxCapacity: number
  currentCapacity: number
}

// ë¹„ë””ì˜¤ í•™ìŠµ ê´€ë ¨ íƒ€ì…
export interface VideoWatchSession {
  startTime: number
  endTime: number
  watchedAt: string
  quality: string
  device: string
}

export interface VideoLearningStats {
  videoId: string
  totalWatchTime: number
  completionRate: number
  averageSessionLength: number
  sessions: VideoWatchSession[]
}

// ê¶Œí•œ ì‹œìŠ¤í…œ íƒ€ì…
export type UserRole = 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
export type Permission = 'read' | 'write' | 'delete' | 'admin'

export interface RolePermissions {
  students: Permission[]
  classes: Permission[]
  payments: Permission[]
  reports: Permission[]
  settings: Permission[]
  videos: Permission[]
}

// API ì‘ë‹µ íƒ€ì…
export interface ApiResponse<T> {
  data?: T
  error?: string
  message?: string
  success: boolean
}

export interface PaginatedResponse<T> {
  data: T[]
  total: number
  page: number
  limit: number
  hasNext: boolean
  hasPrev: boolean
}

// í¼ ê´€ë ¨ íƒ€ì…
export interface StudentFormData extends Omit<StudentInsert, 'id' | 'tenant_id' | 'created_at' | 'updated_at'> {
  // ì¶”ê°€ í¼ í•„ë“œë“¤
}

export interface VideoProgressFormData {
  studentId: string
  videoId: string
  watchedDuration: number
  notes?: string
}
```

### 4. Type Guards & Validators

#### íƒ€ì… ê²€ì¦ ìœ í‹¸ë¦¬í‹°
```typescript
// src/utils/typeGuards.ts
import { Student, Tenant, YouTubeVideo } from '@/types/app.types'

export function isStudent(obj: any): obj is Student {
  return (
    obj &&
    typeof obj.id === 'string' &&
    typeof obj.tenant_id === 'string' &&
    typeof obj.name === 'string' &&
    typeof obj.status === 'string' &&
    ['active', 'inactive', 'graduated', 'transferred'].includes(obj.status)
  )
}

export function isTenant(obj: any): obj is Tenant {
  return (
    obj &&
    typeof obj.id === 'string' &&
    typeof obj.name === 'string' &&
    typeof obj.subdomain === 'string' &&
    ['basic', 'pro', 'enterprise'].includes(obj.subscription_tier)
  )
}

export function isYouTubeVideo(obj: any): obj is YouTubeVideo {
  return (
    obj &&
    typeof obj.id === 'string' &&
    typeof obj.tenant_id === 'string' &&
    typeof obj.youtube_id === 'string' &&
    typeof obj.title === 'string' &&
    typeof obj.duration === 'number'
  )
}

// Zod ìŠ¤í‚¤ë§ˆ (ì„ íƒì )
import { z } from 'zod'

export const StudentSchema = z.object({
  id: z.string().uuid(),
  tenant_id: z.string().uuid(),
  name: z.string().min(1).max(100),
  phone: z.string().nullable(),
  email: z.string().email().nullable(),
  status: z.enum(['active', 'inactive', 'graduated', 'transferred']),
  grade: z.number().int().min(1).max(12).nullable(),
  tags: z.array(z.string()).default([]),
})

export const VideoProgressSchema = z.object({
  student_id: z.string().uuid(),
  video_id: z.string().uuid(),
  watched_duration: z.number().min(0),
  completion_percentage: z.number().min(0).max(100),
})
```

### 5. Development Workflow

#### íƒ€ì… ì—…ë°ì´íŠ¸ ìë™í™”
```typescript
// src/lib/db/types.ts - íƒ€ì… ê´€ë ¨ ìœ í‹¸ë¦¬í‹°
import { Database } from '@/types/supabase'

export type SupabaseClient = {
  from: <T extends keyof Database['public']['Tables']>(table: T) => {
    select: () => Promise<{ data: Database['public']['Tables'][T]['Row'][] | null; error: any }>
    insert: (data: Database['public']['Tables'][T]['Insert']) => Promise<{ data: any; error: any }>
    update: (data: Database['public']['Tables'][T]['Update']) => Promise<{ data: any; error: any }>
    delete: () => Promise<{ data: any; error: any }>
  }
}

// íƒ€ì… ì•ˆì „í•œ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ í—¬í¼
export function createTypedSupabaseClient(): SupabaseClient {
  // ì‹¤ì œ êµ¬í˜„ì€ T-005ì—ì„œ...
  return {} as SupabaseClient
}
```

#### VSCode ì„¤ì •
```json
// .vscode/settings.json
{
  "typescript.preferences.strictNullChecks": true,
  "typescript.preferences.strictFunctionTypes": true,
  "typescript.preferences.noImplicitReturns": true,
  "typescript.preferences.noImplicitAny": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true,
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.sql": "sql"
  }
}
```

## ğŸ”§ Implementation Steps

### Phase 1: Basic Setup (Day 1)
1. [ ] Supabase CLI ì„¤ì¹˜ ë° ì„¤ì •
2. [ ] ê¸°ë³¸ íƒ€ì… ìƒì„± ìŠ¤í¬ë¦½íŠ¸ êµ¬ì¶•
3. [ ] TypeScript strict mode ì„¤ì •
4. [ ] ê¸°ë³¸ íƒ€ì… ê²€ì¦

### Phase 2: Multitenant Types (Day 2)
1. [ ] ë©€í‹°í…Œë„ŒíŠ¸ ìŠ¤í‚¤ë§ˆ v4.1 íƒ€ì… ìƒì„±
2. [ ] RLS ì •ì±… í˜¸í™˜ì„± ê²€ì¦
3. [ ] ê¶Œí•œ ì‹œìŠ¤í…œ íƒ€ì… ì •ì˜
4. [ ] ì»¤ìŠ¤í…€ íƒ€ì… ì •ì˜

### Phase 3: Video System Types (Day 2-3)
1. [ ] YouTube ë¹„ë””ì˜¤ ê´€ë ¨ íƒ€ì… ìƒì„±
2. [ ] ì§„ë„ ì¶”ì  íƒ€ì… ì‹œìŠ¤í…œ
3. [ ] í•™ìŠµ ë¶„ì„ íƒ€ì… ì •ì˜
4. [ ] ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ íƒ€ì… ì§€ì›

### Phase 4: Developer Experience (Day 3)
1. [ ] Type guards ë° validators êµ¬í˜„
2. [ ] ìë™ íƒ€ì… ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°
3. [ ] IDE ìë™ì™„ì„± ìµœì í™”
4. [ ] íƒ€ì… ì—ëŸ¬ ë””ë²„ê¹… ë„êµ¬

## ğŸ§ª Testing Strategy

### íƒ€ì… í…ŒìŠ¤íŠ¸
```typescript
// src/__tests__/types.test.ts
import { expect, test, describe } from 'vitest'
import { isStudent, StudentSchema } from '@/utils/typeGuards'
import type { Student } from '@/types/app.types'

describe('Type Guards', () => {
  test('isStudent validates correct student object', () => {
    const validStudent: Student = {
      id: '123e4567-e89b-12d3-a456-426614174000',
      tenant_id: '123e4567-e89b-12d3-a456-426614174001',
      name: 'Test Student',
      status: 'active',
      phone: null,
      parent_phone: null,
      email: null,
      birth_date: null,
      school: null,
      grade: null,
      gender: null,
      address: null,
      emergency_contact: null,
      medical_info: null,
      enrollment_date: '2024-01-01',
      tags: [],
      notes: null,
      created_at: '2024-01-01T00:00:00Z',
      updated_at: '2024-01-01T00:00:00Z'
    }
    
    expect(isStudent(validStudent)).toBe(true)
  })

  test('StudentSchema validates with Zod', () => {
    const result = StudentSchema.safeParse({
      id: '123e4567-e89b-12d3-a456-426614174000',
      tenant_id: '123e4567-e89b-12d3-a456-426614174001',
      name: 'Test Student',
      phone: null,
      email: null,
      status: 'active',
      grade: null,
      tags: []
    })
    
    expect(result.success).toBe(true)
  })
})

describe('Type Compilation', () => {
  test('should compile without errors', () => {
    // ì»´íŒŒì¼ íƒ€ì„ íƒ€ì… ì²´í¬
    const student: Student = {} as Student
    const tenant_id: string = student.tenant_id
    expect(typeof tenant_id).toBe('string')
  })
})
```

## ğŸ“Š Performance Considerations

- íƒ€ì… ìƒì„± ì‹œê°„: < 10ì´ˆ
- TypeScript ì»´íŒŒì¼ ì‹œê°„: < 5ì´ˆ
- IDE ìë™ì™„ì„± ì‘ë‹µì†ë„: < 500ms
- íƒ€ì… íŒŒì¼ í¬ê¸°: < 100KB

## ğŸš€ Expected Outcomes

1. **100% íƒ€ì… ì•ˆì „ì„±**: ëŸ°íƒ€ì„ ì—ëŸ¬ 90% ê°ì†Œ
2. **ê°œë°œ ìƒì‚°ì„± í–¥ìƒ**: ìë™ì™„ì„±ìœ¼ë¡œ 30% ë¹ ë¥¸ ê°œë°œ
3. **ì½”ë“œ í’ˆì§ˆ**: íƒ€ì… ê¸°ë°˜ ë¦¬íŒ©í† ë§ ì§€ì›
4. **ì‹¤ì‹œê°„ ë™ê¸°í™”**: DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ìë™ íƒ€ì… ì—…ë°ì´íŠ¸
5. **ë©€í‹°í…Œë„ŒíŠ¸ ì§€ì›**: í…Œë„ŒíŠ¸ë³„ íƒ€ì… ê²©ë¦¬ ë³´ì¥

## ğŸ“ Documentation

- [ ] íƒ€ì… ìƒì„± ê°€ì´ë“œ ë¬¸ì„œí™”
- [ ] ê°œë°œì ì›Œí¬í”Œë¡œìš° ë§¤ë‰´ì–¼
- [ ] íƒ€ì… ì•ˆì „ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ

## ğŸ”— Related Tasks

- **Next**: T-005 (ë©€í‹°í…Œë„ŒíŠ¸ ì¸ì¦ ì‹œìŠ¤í…œ)
- **Depends**: T-003 (ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •)
- **Related**: T-007 (API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„)

---

**Status**: TODO  
**Assignee**: Developer  
**Created**: 2025-08-10  
**Updated**: 2025-08-10  
**Completion**: 0%