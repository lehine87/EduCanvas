# T-004: TypeScript Type Generation Setup

**Task ID**: T-004  
**Priority**: P0 (MVP Critical)  
**Estimated Time**: 2-3 days  
**Dependencies**: T-001 (프로젝트 구조), T-003 (데이터베이스 설정)  
**Phase**: 1 (기반 구축)

## 📋 Task Overview

Supabase database_schema_v4.1의 멀티테넌트 아키텍처와 YouTube 비디오 통합 시스템을 위한 TypeScript 타입을 자동 생성하고, 타입 안전성을 보장하는 개발 환경을 구축합니다.

## 🎯 Success Criteria

- [ ] Supabase CLI를 통한 TypeScript 타입 자동 생성 설정
- [ ] 멀티테넌트 스키마 v4.1의 모든 테이블과 관계 타입 생성
- [ ] YouTube 비디오 시스템 관련 타입 완전 지원
- [ ] Row Level Security (RLS) 정책과 호환되는 타입 시스템
- [ ] 개발 시 실시간 타입 업데이트 워크플로우 구축
- [ ] 타입 검사 100% 통과 (strict mode)
- [ ] 컴파일 시간 < 5초 유지

## 📚 Technical Requirements

### 1. Supabase Type Generation

#### 필수 패키지 설치
```bash
npm install -D supabase
npm install @supabase/supabase-js
```

#### Supabase CLI 설정
```json
// supabase/config.toml
[api]
enabled = true
port = 54321
schemas = ["public", "auth", "storage", "realtime"]
extra_search_path = ["public", "extensions"]
max_rows = 1000

[db]
port = 54322
shadow_port = 54320
major_version = 15

[studio]
enabled = true
port = 54323

[auth]
enabled = true
port = 54324
site_url = "http://localhost:3000"
additional_redirect_urls = ["https://localhost:3000"]

[edge_functions]
enabled = true
port = 54325
```

#### 타입 생성 스크립트
```json
// package.json scripts 추가
{
  "scripts": {
    "types:generate": "supabase gen types typescript --project-id $SUPABASE_PROJECT_ID --schema public > src/types/supabase.ts",
    "types:watch": "chokidar 'supabase/migrations/*.sql' -c 'npm run types:generate'",
    "types:validate": "tsc --noEmit --strict"
  }
}
```

### 2. Multitenant Schema v4.1 Types

#### 핵심 엔티티 타입 (자동 생성 예상)

```typescript
// src/types/supabase.ts (자동 생성됨)
export type Database = {
  public: {
    Tables: {
      // 멀티테넌트 핵심
      tenants: {
        Row: {
          id: string
          name: string
          subdomain: string
          settings: Json
          subscription_tier: 'basic' | 'pro' | 'enterprise'
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          name: string
          subdomain: string
          settings?: Json
          subscription_tier?: 'basic' | 'pro' | 'enterprise'
          created_at?: string
          updated_at?: string
        }
        Update: {
          name?: string
          subdomain?: string
          settings?: Json
          subscription_tier?: 'basic' | 'pro' | 'enterprise'
          updated_at?: string
        }
      }
      
      // 사용자 관리
      tenant_users: {
        Row: {
          id: string
          tenant_id: string
          user_id: string
          role: 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
          permissions: Json
          status: 'active' | 'inactive' | 'suspended'
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          user_id: string
          role: 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
          permissions?: Json
          status?: 'active' | 'inactive' | 'suspended'
          created_at?: string
          updated_at?: string
        }
        Update: {
          role?: 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
          permissions?: Json
          status?: 'active' | 'inactive' | 'suspended'
          updated_at?: string
        }
      }
      
      // 학생 관리
      students: {
        Row: {
          id: string
          tenant_id: string
          name: string
          phone: string | null
          parent_phone: string | null
          email: string | null
          birth_date: string | null
          school: string | null
          grade: number | null
          gender: 'male' | 'female' | 'other' | null
          address: string | null
          emergency_contact: Json | null
          medical_info: Json | null
          enrollment_date: string
          status: 'active' | 'inactive' | 'graduated' | 'transferred'
          tags: string[]
          notes: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          name: string
          phone?: string | null
          parent_phone?: string | null
          email?: string | null
          birth_date?: string | null
          school?: string | null
          grade?: number | null
          gender?: 'male' | 'female' | 'other' | null
          address?: string | null
          emergency_contact?: Json | null
          medical_info?: Json | null
          enrollment_date?: string
          status?: 'active' | 'inactive' | 'graduated' | 'transferred'
          tags?: string[]
          notes?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          name?: string
          phone?: string | null
          parent_phone?: string | null
          email?: string | null
          birth_date?: string | null
          school?: string | null
          grade?: number | null
          gender?: 'male' | 'female' | 'other' | null
          address?: string | null
          emergency_contact?: Json | null
          medical_info?: Json | null
          enrollment_date?: string
          status?: 'active' | 'inactive' | 'graduated' | 'transferred'
          tags?: string[]
          notes?: string | null
          updated_at?: string
        }
      }
      
      // YouTube 비디오 시스템
      youtube_videos: {
        Row: {
          id: string
          tenant_id: string
          youtube_id: string
          title: string
          description: string | null
          duration: number
          thumbnail_url: string | null
          channel_id: string
          published_at: string
          category: string | null
          tags: string[]
          quality_levels: string[]
          captions_available: boolean
          status: 'active' | 'inactive' | 'private' | 'deleted'
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          youtube_id: string
          title: string
          description?: string | null
          duration: number
          thumbnail_url?: string | null
          channel_id: string
          published_at: string
          category?: string | null
          tags?: string[]
          quality_levels?: string[]
          captions_available?: boolean
          status?: 'active' | 'inactive' | 'private' | 'deleted'
          created_at?: string
          updated_at?: string
        }
        Update: {
          title?: string
          description?: string | null
          duration?: number
          thumbnail_url?: string | null
          category?: string | null
          tags?: string[]
          quality_levels?: string[]
          captions_available?: boolean
          status?: 'active' | 'inactive' | 'private' | 'deleted'
          updated_at?: string
        }
      }
      
      // 비디오 시청 진도
      student_video_progress: {
        Row: {
          id: string
          tenant_id: string
          student_id: string
          video_id: string
          watched_duration: number
          total_duration: number
          completion_percentage: number
          last_watched_at: string
          completed_at: string | null
          watch_sessions: Json[]
          notes: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          tenant_id: string
          student_id: string
          video_id: string
          watched_duration?: number
          total_duration: number
          completion_percentage?: number
          last_watched_at: string
          completed_at?: string | null
          watch_sessions?: Json[]
          notes?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          watched_duration?: number
          total_duration?: number
          completion_percentage?: number
          last_watched_at?: string
          completed_at?: string | null
          watch_sessions?: Json[]
          notes?: string | null
          updated_at?: string
        }
      }
    }
    Views: {
      // 뷰 타입들 (자동 생성)
      student_enrollment_stats: {
        Row: {
          tenant_id: string
          student_id: string
          student_name: string
          total_enrollments: number
          active_enrollments: number
          total_payments: number
          last_payment_date: string | null
        }
      }
      
      video_learning_analytics: {
        Row: {
          tenant_id: string
          video_id: string
          video_title: string
          total_students: number
          completed_students: number
          average_completion: number
          total_watch_time: number
        }
      }
    }
    Functions: {
      // RPC 함수 타입들 (자동 생성)
      get_student_by_tenant: {
        Args: { p_tenant_id: string; p_student_id: string }
        Returns: Database['public']['Tables']['students']['Row'] | null
      }
      
      update_video_progress: {
        Args: {
          p_tenant_id: string
          p_student_id: string
          p_video_id: string
          p_watched_duration: number
          p_session_data: Json
        }
        Returns: boolean
      }
    }
  }
}
```

### 3. 커스텀 타입 정의

#### 애플리케이션 레벨 타입
```typescript
// src/types/app.types.ts
import { Database } from './supabase'

// 편의성을 위한 타입 별칭
export type Tables = Database['public']['Tables']
export type Student = Tables['students']['Row']
export type StudentInsert = Tables['students']['Insert']
export type StudentUpdate = Tables['students']['Update']
export type Tenant = Tables['tenants']['Row']
export type TenantUser = Tables['tenant_users']['Row']
export type YouTubeVideo = Tables['youtube_videos']['Row']
export type VideoProgress = Tables['student_video_progress']['Row']

// ClassFlow 관련 타입
export interface ClassFlowStudent extends Student {
  position?: { x: number; y: number }
  isDragging?: boolean
  isSelected?: boolean
}

export interface ClassFlowClass {
  id: string
  name: string
  students: ClassFlowStudent[]
  maxCapacity: number
  currentCapacity: number
}

// 비디오 학습 관련 타입
export interface VideoWatchSession {
  startTime: number
  endTime: number
  watchedAt: string
  quality: string
  device: string
}

export interface VideoLearningStats {
  videoId: string
  totalWatchTime: number
  completionRate: number
  averageSessionLength: number
  sessions: VideoWatchSession[]
}

// 권한 시스템 타입
export type UserRole = 'owner' | 'admin' | 'instructor' | 'staff' | 'viewer'
export type Permission = 'read' | 'write' | 'delete' | 'admin'

export interface RolePermissions {
  students: Permission[]
  classes: Permission[]
  payments: Permission[]
  reports: Permission[]
  settings: Permission[]
  videos: Permission[]
}

// API 응답 타입
export interface ApiResponse<T> {
  data?: T
  error?: string
  message?: string
  success: boolean
}

export interface PaginatedResponse<T> {
  data: T[]
  total: number
  page: number
  limit: number
  hasNext: boolean
  hasPrev: boolean
}

// 폼 관련 타입
export interface StudentFormData extends Omit<StudentInsert, 'id' | 'tenant_id' | 'created_at' | 'updated_at'> {
  // 추가 폼 필드들
}

export interface VideoProgressFormData {
  studentId: string
  videoId: string
  watchedDuration: number
  notes?: string
}
```

### 4. Type Guards & Validators

#### 타입 검증 유틸리티
```typescript
// src/utils/typeGuards.ts
import { Student, Tenant, YouTubeVideo } from '@/types/app.types'

export function isStudent(obj: any): obj is Student {
  return (
    obj &&
    typeof obj.id === 'string' &&
    typeof obj.tenant_id === 'string' &&
    typeof obj.name === 'string' &&
    typeof obj.status === 'string' &&
    ['active', 'inactive', 'graduated', 'transferred'].includes(obj.status)
  )
}

export function isTenant(obj: any): obj is Tenant {
  return (
    obj &&
    typeof obj.id === 'string' &&
    typeof obj.name === 'string' &&
    typeof obj.subdomain === 'string' &&
    ['basic', 'pro', 'enterprise'].includes(obj.subscription_tier)
  )
}

export function isYouTubeVideo(obj: any): obj is YouTubeVideo {
  return (
    obj &&
    typeof obj.id === 'string' &&
    typeof obj.tenant_id === 'string' &&
    typeof obj.youtube_id === 'string' &&
    typeof obj.title === 'string' &&
    typeof obj.duration === 'number'
  )
}

// Zod 스키마 (선택적)
import { z } from 'zod'

export const StudentSchema = z.object({
  id: z.string().uuid(),
  tenant_id: z.string().uuid(),
  name: z.string().min(1).max(100),
  phone: z.string().nullable(),
  email: z.string().email().nullable(),
  status: z.enum(['active', 'inactive', 'graduated', 'transferred']),
  grade: z.number().int().min(1).max(12).nullable(),
  tags: z.array(z.string()).default([]),
})

export const VideoProgressSchema = z.object({
  student_id: z.string().uuid(),
  video_id: z.string().uuid(),
  watched_duration: z.number().min(0),
  completion_percentage: z.number().min(0).max(100),
})
```

### 5. Development Workflow

#### 타입 업데이트 자동화
```typescript
// src/lib/db/types.ts - 타입 관련 유틸리티
import { Database } from '@/types/supabase'

export type SupabaseClient = {
  from: <T extends keyof Database['public']['Tables']>(table: T) => {
    select: () => Promise<{ data: Database['public']['Tables'][T]['Row'][] | null; error: any }>
    insert: (data: Database['public']['Tables'][T]['Insert']) => Promise<{ data: any; error: any }>
    update: (data: Database['public']['Tables'][T]['Update']) => Promise<{ data: any; error: any }>
    delete: () => Promise<{ data: any; error: any }>
  }
}

// 타입 안전한 데이터베이스 쿼리 헬퍼
export function createTypedSupabaseClient(): SupabaseClient {
  // 실제 구현은 T-005에서...
  return {} as SupabaseClient
}
```

#### VSCode 설정
```json
// .vscode/settings.json
{
  "typescript.preferences.strictNullChecks": true,
  "typescript.preferences.strictFunctionTypes": true,
  "typescript.preferences.noImplicitReturns": true,
  "typescript.preferences.noImplicitAny": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true,
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.sql": "sql"
  }
}
```

## 🔧 Implementation Steps

### Phase 1: Basic Setup (Day 1)
1. [ ] Supabase CLI 설치 및 설정
2. [ ] 기본 타입 생성 스크립트 구축
3. [ ] TypeScript strict mode 설정
4. [ ] 기본 타입 검증

### Phase 2: Multitenant Types (Day 2)
1. [ ] 멀티테넌트 스키마 v4.1 타입 생성
2. [ ] RLS 정책 호환성 검증
3. [ ] 권한 시스템 타입 정의
4. [ ] 커스텀 타입 정의

### Phase 3: Video System Types (Day 2-3)
1. [ ] YouTube 비디오 관련 타입 생성
2. [ ] 진도 추적 타입 시스템
3. [ ] 학습 분석 타입 정의
4. [ ] 실시간 업데이트 타입 지원

### Phase 4: Developer Experience (Day 3)
1. [ ] Type guards 및 validators 구현
2. [ ] 자동 타입 업데이트 워크플로우
3. [ ] IDE 자동완성 최적화
4. [ ] 타입 에러 디버깅 도구

## 🧪 Testing Strategy

### 타입 테스트
```typescript
// src/__tests__/types.test.ts
import { expect, test, describe } from 'vitest'
import { isStudent, StudentSchema } from '@/utils/typeGuards'
import type { Student } from '@/types/app.types'

describe('Type Guards', () => {
  test('isStudent validates correct student object', () => {
    const validStudent: Student = {
      id: '123e4567-e89b-12d3-a456-426614174000',
      tenant_id: '123e4567-e89b-12d3-a456-426614174001',
      name: 'Test Student',
      status: 'active',
      phone: null,
      parent_phone: null,
      email: null,
      birth_date: null,
      school: null,
      grade: null,
      gender: null,
      address: null,
      emergency_contact: null,
      medical_info: null,
      enrollment_date: '2024-01-01',
      tags: [],
      notes: null,
      created_at: '2024-01-01T00:00:00Z',
      updated_at: '2024-01-01T00:00:00Z'
    }
    
    expect(isStudent(validStudent)).toBe(true)
  })

  test('StudentSchema validates with Zod', () => {
    const result = StudentSchema.safeParse({
      id: '123e4567-e89b-12d3-a456-426614174000',
      tenant_id: '123e4567-e89b-12d3-a456-426614174001',
      name: 'Test Student',
      phone: null,
      email: null,
      status: 'active',
      grade: null,
      tags: []
    })
    
    expect(result.success).toBe(true)
  })
})

describe('Type Compilation', () => {
  test('should compile without errors', () => {
    // 컴파일 타임 타입 체크
    const student: Student = {} as Student
    const tenant_id: string = student.tenant_id
    expect(typeof tenant_id).toBe('string')
  })
})
```

## 📊 Performance Considerations

- 타입 생성 시간: < 10초
- TypeScript 컴파일 시간: < 5초
- IDE 자동완성 응답속도: < 500ms
- 타입 파일 크기: < 100KB

## 🚀 Expected Outcomes

1. **100% 타입 안전성**: 런타임 에러 90% 감소
2. **개발 생산성 향상**: 자동완성으로 30% 빠른 개발
3. **코드 품질**: 타입 기반 리팩토링 지원
4. **실시간 동기화**: DB 스키마 변경 시 자동 타입 업데이트
5. **멀티테넌트 지원**: 테넌트별 타입 격리 보장

## 📝 Documentation

- [ ] 타입 생성 가이드 문서화
- [ ] 개발자 워크플로우 매뉴얼
- [ ] 타입 안전성 체크리스트
- [ ] 트러블슈팅 가이드

## 🔗 Related Tasks

- **Next**: T-005 (멀티테넌트 인증 시스템)
- **Depends**: T-003 (데이터베이스 설정)
- **Related**: T-007 (API 엔드포인트 구현)

---

**Status**: TODO  
**Assignee**: Developer  
**Created**: 2025-08-10  
**Updated**: 2025-08-10  
**Completion**: 0%