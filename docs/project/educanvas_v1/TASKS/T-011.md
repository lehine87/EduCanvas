# T-011: 에러 핸들링 시스템 구축 (Sentry 연동)

**생성일**: 2025-08-11  
**상태**: TODO  
**우선순위**: P0 (MVP 필수)  
**담당자**: Full Stack  
**예상 소요**: 1.0일  
**스프린트**: S1 (Week 2)  
**기한**: 2025-08-23

## 📋 작업 개요

EduCanvas 애플리케이션의 안정성과 사용자 경험 향상을 위한 포괄적인 에러 핸들링 시스템을 구축합니다. Sentry를 통한 에러 모니터링, React Error Boundary, 사용자 친화적 에러 UI, 그리고 개발자를 위한 디버깅 도구를 포함하여 완전한 에러 관리 생태계를 구현합니다.

## 🎯 작업 목표

1. **Sentry 에러 모니터링 연동**
2. **React Error Boundary 구현**  
3. **사용자 친화적 에러 UI**
4. **API 에러 처리 표준화**
5. **개발자 디버깅 도구**

## 📚 세부 작업 항목

### 1. Sentry 설정 및 연동 (0.2일)

```typescript
// lib/sentry/sentry.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  
  // 성능 모니터링
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  
  // 세션 리플레이 (사용자 행동 재현)
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
  
  // 민감 정보 필터링
  beforeSend(event, hint) {
    // 개인정보 제거
    if (event.user) {
      delete event.user.email
      delete event.user.ip_address
    }
    
    // 민감한 에러 메시지 필터링
    if (event.message?.includes('password')) {
      return null
    }
    
    return event
  },
  
  integrations: [
    new Sentry.Replay({
      maskAllText: true,
      blockAllMedia: true,
    }),
    new Sentry.BrowserTracing({
      routingInstrumentation: Sentry.nextRouterInstrumentation(router)
    })
  ]
})

// 사용자 컨텍스트 설정
export function setSentryUser(user: { id: string; role: string }) {
  Sentry.setUser({
    id: user.id,
    role: user.role
  })
}

// 테넌트 컨텍스트 설정
export function setSentryContext(tenantId: string) {
  Sentry.setContext('tenant', {
    id: tenantId
  })
}
```

### 2. React Error Boundary 구현 (0.2일)

```typescript
// components/error/ErrorBoundary.tsx
interface ErrorBoundaryState {
  hasError: boolean
  error: Error | null
  errorInfo: ErrorInfo | null
}

export class ErrorBoundary extends Component<
  PropsWithChildren<{ fallback?: ComponentType<ErrorFallbackProps> }>,
  ErrorBoundaryState
> {
  constructor(props: PropsWithChildren<{}>) {
    super(props)
    this.state = { hasError: false, error: null, errorInfo: null }
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return {
      hasError: true,
      error,
      errorInfo: null
    }
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    this.setState({
      error,
      errorInfo
    })

    // Sentry에 에러 리포트
    Sentry.withScope((scope) => {
      scope.setContext('errorBoundary', {
        componentStack: errorInfo.componentStack
      })
      
      scope.setLevel('error')
      Sentry.captureException(error)
    })
  }

  render() {
    if (this.state.hasError) {
      const FallbackComponent = this.props.fallback || DefaultErrorFallback
      
      return (
        <FallbackComponent
          error={this.state.error}
          errorInfo={this.state.errorInfo}
          resetError={() => this.setState({ hasError: false, error: null, errorInfo: null })}
        />
      )
    }

    return this.props.children
  }
}

// 기본 에러 폴백 컴포넌트
function DefaultErrorFallback({ error, resetError }: ErrorFallbackProps) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div className="text-center">
          <ExclamationTriangleIcon className="mx-auto h-12 w-12 text-red-500" />
          <h2 className="mt-6 text-3xl font-extrabold text-gray-900">
            오류가 발생했습니다
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            문제가 지속되면 관리자에게 문의하세요
          </p>
          
          {process.env.NODE_ENV === 'development' && error && (
            <details className="mt-4 text-left">
              <summary className="cursor-pointer text-sm text-gray-500">
                개발자 정보 보기
              </summary>
              <pre className="mt-2 text-xs bg-gray-100 p-2 rounded overflow-auto">
                {error.toString()}
              </pre>
            </details>
          )}
        </div>
        
        <div className="flex space-x-4">
          <Button onClick={resetError} className="flex-1">
            다시 시도
          </Button>
          <Button 
            variant="ghost" 
            onClick={() => window.location.href = '/admin'}
            className="flex-1"
          >
            홈으로 가기
          </Button>
        </div>
      </div>
    </div>
  )
}
```

### 3. API 에러 처리 표준화 (0.3일)

```typescript
// lib/errors/apiErrors.ts
export class APIError extends Error {
  constructor(
    message: string,
    public statusCode: number,
    public code?: string,
    public details?: any
  ) {
    super(message)
    this.name = 'APIError'
  }
}

export class ValidationError extends APIError {
  constructor(message: string, public fields: Record<string, string[]>) {
    super(message, 400, 'VALIDATION_ERROR', fields)
  }
}

export class AuthorizationError extends APIError {
  constructor(message = '권한이 없습니다') {
    super(message, 403, 'AUTHORIZATION_ERROR')
  }
}

export class NotFoundError extends APIError {
  constructor(message = '요청한 리소스를 찾을 수 없습니다') {
    super(message, 404, 'NOT_FOUND')
  }
}

// API 에러 처리 미들웨어
export function withErrorHandling<T extends any[]>(
  fn: (...args: T) => Promise<any>
) {
  return async (...args: T) => {
    try {
      return await fn(...args)
    } catch (error) {
      // Supabase 에러 변환
      if (error instanceof PostgrestError) {
        if (error.code === 'PGRST116') {
          throw new NotFoundError()
        }
        if (error.message.includes('row-level security')) {
          throw new AuthorizationError('해당 데이터에 접근할 권한이 없습니다')
        }
      }
      
      // Auth 에러 변환
      if (error instanceof AuthError) {
        throw new APIError('인증 실패', 401, 'AUTH_ERROR')
      }
      
      // Sentry에 예상치 못한 에러 리포트
      if (!(error instanceof APIError)) {
        Sentry.captureException(error)
      }
      
      throw error
    }
  }
}
```

### 4. 토스트 알림 시스템 구현 (0.2일)

```typescript
// components/ui/Toast.tsx
import { toast } from 'react-hot-toast'

export const toastConfig = {
  duration: 4000,
  position: 'top-right' as const,
  style: {
    borderRadius: '8px',
    background: '#363636',
    color: '#fff',
  },
  success: {
    iconTheme: {
      primary: '#10B981',
      secondary: '#FFFFFF',
    },
  },
  error: {
    iconTheme: {
      primary: '#EF4444',
      secondary: '#FFFFFF',
    },
  },
}

// 사용자 친화적 에러 메시지 변환
export function showErrorToast(error: unknown) {
  let message = '알 수 없는 오류가 발생했습니다'
  
  if (error instanceof APIError) {
    switch (error.code) {
      case 'VALIDATION_ERROR':
        message = '입력한 정보를 확인해주세요'
        break
      case 'AUTHORIZATION_ERROR':
        message = '해당 작업을 수행할 권한이 없습니다'
        break
      case 'NOT_FOUND':
        message = '요청한 데이터를 찾을 수 없습니다'
        break
      default:
        message = error.message
    }
  } else if (error instanceof Error) {
    message = error.message
  }
  
  toast.error(message)
}

export function showSuccessToast(message: string) {
  toast.success(message)
}

// Hook for error handling
export function useErrorHandler() {
  return useCallback((error: unknown) => {
    showErrorToast(error)
  }, [])
}
```

### 5. 개발자 도구 및 디버깅 (0.1일)

```typescript
// lib/debug/errorDebugger.ts
interface ErrorReport {
  timestamp: string
  error: Error
  userAgent: string
  url: string
  userId?: string
  tenantId?: string
  additionalContext?: Record<string, any>
}

export class ErrorDebugger {
  private errors: ErrorReport[] = []
  
  report(error: Error, additionalContext?: Record<string, any>) {
    const report: ErrorReport = {
      timestamp: new Date().toISOString(),
      error,
      userAgent: navigator.userAgent,
      url: window.location.href,
      additionalContext
    }
    
    this.errors.push(report)
    
    // 개발 환경에서 콘솔에 상세 정보 출력
    if (process.env.NODE_ENV === 'development') {
      console.group('🐛 Error Report')
      console.error('Error:', error)
      console.table(report)
      console.groupEnd()
    }
    
    // 로컬 스토리지에 임시 저장 (개발 환경에서만)
    if (process.env.NODE_ENV === 'development') {
      const stored = localStorage.getItem('educanvas_error_logs') || '[]'
      const logs = JSON.parse(stored)
      logs.push({
        ...report,
        error: {
          name: error.name,
          message: error.message,
          stack: error.stack
        }
      })
      
      // 최대 50개까지만 저장
      if (logs.length > 50) {
        logs.shift()
      }
      
      localStorage.setItem('educanvas_error_logs', JSON.stringify(logs))
    }
  }
  
  getErrorLogs(): ErrorReport[] {
    if (process.env.NODE_ENV === 'development') {
      const stored = localStorage.getItem('educanvas_error_logs') || '[]'
      return JSON.parse(stored)
    }
    return []
  }
  
  clearLogs() {
    this.errors = []
    if (process.env.NODE_ENV === 'development') {
      localStorage.removeItem('educanvas_error_logs')
    }
  }
}

export const errorDebugger = new ErrorDebugger()

// 전역 에러 핸들러
if (typeof window !== 'undefined') {
  window.addEventListener('error', (event) => {
    errorDebugger.report(event.error, {
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno
    })
  })
  
  window.addEventListener('unhandledrejection', (event) => {
    errorDebugger.report(
      new Error(`Unhandled Promise Rejection: ${event.reason}`),
      { reason: event.reason }
    )
  })
}
```

## 🛠 기술 요구사항

### 필수 패키지
```json
{
  "@sentry/nextjs": "^7.77.0",
  "react-hot-toast": "^2.4.1",
  "react-error-boundary": "^4.0.11"
}
```

### Sentry 설정
```bash
# .env.local
NEXT_PUBLIC_SENTRY_DSN=https://your-dsn@sentry.io/project-id
SENTRY_ORG=your-org
SENTRY_PROJECT=educanvas
SENTRY_AUTH_TOKEN=your-auth-token
```

### 환경별 에러 처리
- **Development**: 상세한 에러 정보, 로컬 로깅
- **Production**: 사용자 친화적 메시지, Sentry 리포팅
- **Testing**: 에러 시뮬레이션 도구

## 📂 생성될 파일 구조

```
src/
├── components/error/
│   ├── ErrorBoundary.tsx           # React Error Boundary
│   ├── ErrorFallback.tsx           # 에러 폴백 컴포넌트
│   ├── NotFoundPage.tsx            # 404 페이지
│   └── UnauthorizedPage.tsx        # 403 페이지
├── lib/
│   ├── sentry/
│   │   ├── sentry.config.ts        # Sentry 설정
│   │   └── sentryUtils.ts          # Sentry 유틸리티
│   ├── errors/
│   │   ├── apiErrors.ts            # API 에러 클래스들
│   │   ├── errorHandler.ts         # 에러 핸들러
│   │   └── errorUtils.ts           # 에러 유틸리티
│   └── debug/
│       ├── errorDebugger.ts        # 개발자 디버깅 도구
│       └── errorLogger.ts          # 에러 로깅
├── hooks/
│   ├── useErrorHandler.ts          # 에러 처리 훅
│   └── useErrorBoundary.ts         # 에러 바운더리 훅
├── app/
│   ├── global-error.tsx            # 글로벌 에러 페이지
│   ├── not-found.tsx               # 404 페이지
│   └── error.tsx                   # 에러 페이지
└── middleware.ts                   # 에러 처리 미들웨어 추가
```

## 🧪 테스트 계획

### 에러 시나리오 테스트
- [ ] 네트워크 에러 (API 실패)
- [ ] 인증 에러 (토큰 만료)
- [ ] 권한 에러 (RLS 위반)
- [ ] 유효성 검증 에러
- [ ] JavaScript 런타임 에러

### Error Boundary 테스트
- [ ] 컴포넌트 렌더링 에러 복구
- [ ] 에러 폴백 UI 표시
- [ ] 에러 리셋 기능
- [ ] Sentry 리포팅 확인

### 사용자 경험 테스트
- [ ] 에러 메시지 가독성
- [ ] 토스트 알림 동작
- [ ] 에러 복구 플로우
- [ ] 접근성 준수 확인

## 📋 완료 조건

- [ ] Sentry 에러 모니터링 완전 연동
- [ ] React Error Boundary 모든 페이지 적용
- [ ] API 에러 표준화 및 변환
- [ ] 사용자 친화적 에러 UI 구현
- [ ] 토스트 알림 시스템 동작
- [ ] 개발자 디버깅 도구 구축
- [ ] 에러 복구 메커니즘 동작
- [ ] 모든 에러 시나리오 테스트 통과

## 🔗 의존성

**선행 작업**:
- ✅ T-006: UI 컴포넌트 라이브러리 (Button, Modal 등)
- T-007: Supabase Auth 인증 시스템
- T-010: 공통 레이아웃 컴포넌트

**후속 작업**:
- Week 3 학생 관리 CRUD 구현
- T-024: 스키마 변경사항 애플리케이션 레이어 적용

## 💡 구현 참고사항

### 성능 최적화
```typescript
// Sentry 성능 오버헤드 최소화
const sentryConfig = {
  // 프로덕션에서는 샘플링 비율 조정
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  
  // 민감하지 않은 에러만 리포트
  beforeSend: (event) => {
    if (event.exception?.values?.[0]?.type === 'ChunkLoadError') {
      return null // 청크 로드 에러는 무시
    }
    return event
  }
}
```

### 보안 고려사항
```typescript
// 개인정보 마스킹
function sanitizeErrorData(data: any) {
  const sensitiveFields = ['password', 'email', 'phone', 'address']
  
  return Object.keys(data).reduce((acc, key) => {
    if (sensitiveFields.includes(key.toLowerCase())) {
      acc[key] = '[REDACTED]'
    } else {
      acc[key] = data[key]
    }
    return acc
  }, {} as any)
}
```

### 사용자 경험 개선
```typescript
// 에러 복구 제안
function getRecoverySuggestion(error: APIError): string {
  switch (error.code) {
    case 'NETWORK_ERROR':
      return '인터넷 연결을 확인하고 다시 시도해주세요'
    case 'AUTH_ERROR':
      return '다시 로그인해주세요'
    case 'VALIDATION_ERROR':
      return '입력한 정보를 확인해주세요'
    default:
      return '잠시 후 다시 시도해주세요'
  }
}
```

## 📈 예상 리스크 및 대응

| 리스크 | 확률 | 영향도 | 대응방안 |
|-------|------|--------|----------|
| Sentry 성능 오버헤드 | 중간 | 낮음 | 샘플링 비율 조정 |
| 과도한 에러 리포팅 | 중간 | 중간 | 필터링 정책 강화 |
| 민감정보 노출 | 낮음 | 높음 | 데이터 마스킹 철저히 |
| Error Boundary 성능 | 낮음 | 낮음 | 최소한의 폴백 UI |

**총 예상 소요**: 1.0일 (에러 핸들링 시스템 구축 집중)